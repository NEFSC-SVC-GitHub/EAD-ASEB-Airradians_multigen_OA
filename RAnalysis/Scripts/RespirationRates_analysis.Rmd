---
title: "RespirationRates_Analysis"
author: "Samuel Gurr"
date: "2022-11-30"
output:
  pdf_document:
    latex_engine: xelatex
---


```{r setup, include= FALSE, echo = FALSE}

# LOAD PACKAGES :::::::::::::::::::::::::::::::::::::::::::::::::::::::
library(dplyr)
library(ggplot2)
library(forcats)
library(lme4)
library(lmerTest)
library(performance)
library(car)
library(kableExtra)
library(pander)
library(data.table)
library(Rmisc)
library(devtools)
library(ggpubr)
library(SciViews)

# SET WORKING DIRECTORY :::::::::::::::::::::::::::::::::::::::::::::::
setwd("C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis") # personal computer
# setwd("C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis") # Work computer

# LOAD DATA :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
RR_master <- read.csv(file="Output/Respiration/RR_calc_raw.csv", header=T) %>% 
              filter(!Food %in% 'unfed') %>% # omit low food trial data
              # filter out the F2 measurements
              filter(!Date %in% c('8/30/2022', '11/16/2022')) %>% # an F2 measurement
              filter(!(Date == '9/22/2022' & filetype =='SDR_data')) %>% 
  # unique(RR_master$Date) # "10/26/2021" "2/2/2022"   "3/1/2022"   "8/30/2022"  "9/14/2021"  "9/22/2022"  "9/30/2021"
              dplyr::mutate(Age = case_when(Date == '9/14/2021'  ~ 50,
                                            Date == '9/30/2021'  ~ 66,
                                            Date == '10/26/2021'  ~ 92, 
                                            Date == '2/2/2022' ~ 191,
                                            Date == '3/1/2022'  ~ 218,
                                            Date == '9/22/2022'  ~ 423,
                                            Date == '10/26/2022' ~ 457)) %>% 
              dplyr::mutate(Age = as.factor(Age)) %>% 
              dplyr::arrange(Age)
              
# View(RR_master)

```


# F1 DATA ANALYSIS 

### Summary tables

```{r shell lengths at each timepoint, echo = FALSE}

SumTable <- RR_master[!is.na(RR_master$Length_um),] %>%  
            mutate(Length_mm = Length_um/1000) %>% 
            summarySE(measurevar="Length_mm", groupvars=c("Date", "Age")) %>% 
            dplyr::arrange(Age)
SumTable

SumTable_treatment <- RR_master[!is.na(RR_master$Length_um),] %>%  
            mutate(Length_mm = Length_um/1000) %>% 
            summarySE(measurevar="Length_mm", groupvars=c("Date", "Age", "pCO2")) %>% 
            dplyr::arrange(Age)
SumTable_treatment
```


# ALOMETRIC COEFFICIENT (b factor) 


## by TISSUE DRY WEIGHT  ::::::::::
```{r b factor TISSUE DRY WEIGHT, echo = FALSE, message = FALSE, warning = FALSE, results='hide'}


# ABOUT: 

# from Bayne text (page 360)

# b is the scaling exponent, 
# log10_M_O2 = log10_a + (b.factor * log10_Mass) 
# M_O2 ‚àù a*Mass^(b.factor),
# y   =  m(x)^b.factor

# b = the coefficient estimated empirically by fitting the allometric equation below
# [ln(VO2])] = ln(a) + b*(ln(TDW))


# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# GET B FACTOR FOR ALL AVAILABLE INDIVIDUALS WITH TDW AND MO2 ::::::::::::::::::::::::::::::
RR_master_OM            <- RR_master %>% filter(!is.na(resp_umol_hr)) %>%  filter(!is.na(Dry_Tissue_weight)) 
RR_master_OM$log10_VO2  <- log10(as.numeric(RR_master_OM$resp_umol_hr)) # assign resp value
RR_master_OM$log10_TDW  <- log10(as.numeric(RR_master_OM$Dry_Tissue_weight)) # assign length value 
#summary(lm(RR_master_OM$log10_VO2~RR_master_OM$log10_TDW)) # 0.79749 == b factor

MO2_b.factor_PLOT <- RR_master_OM %>% 
                       ggplot(aes(x=log10_TDW, y=log10_VO2)) +
                          geom_point() +
                          theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                          scale_x_continuous(name ="log10_BodyMass; TDW in g") +
                          scale_y_continuous(name ="log10_MO2; RR in umol L-1 hr-1)") +
                          theme_classic() +
                          theme(legend.position="none",axis.title.y=element_text(size=7)) +
                          ggtitle("Metabolic scaling: log10_MO2 = log10_a + (b.factor * log10_BodyMass)") +
                          geom_smooth(method = lm, color = 'red') +
                          ggpmisc::stat_poly_eq(parse=T, aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), label.x.npc = "left")
# MO2_b.factor_PLOT



MO2_b.factor_PLOT_facetted <- RR_master_OM %>% 
                       ggplot(aes(x=log10_TDW, y=log10_VO2, color = pCO2)) +
                          geom_point() +
                          scale_color_manual(values=c("blue","orange")) +
                          theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                          scale_x_continuous(name ="log10_BodyMass; TDW in g") +
                          scale_y_continuous(name ="log10_MO2; RR in umol L-1 hr-1)") +
                          theme_classic() +
                          theme(legend.position="none",axis.title.y=element_text(size=7)) +
                          ggtitle("Metabolic scaling: log10_MO2 = log10_a + (b.factor * log10_BodyMass)") +
                          geom_smooth(method = lm, color = 'red') +
                          ggpmisc::stat_poly_eq(parse=T, aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), label.x.npc = "left") +
                          facet_wrap(~pCO2)
# MO2_b.factor_PLOT_facetted


# OUTPUT PLOTS 
pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/Respiration/MetabolicScaling_bFactor.pdf"), width = 8, height = 8)
print(ggarrange(MO2_b.factor_PLOT, MO2_b.factor_PLOT_facetted, nrow = 2, ncol = 1)) # print the model diagnostics
dev.off() 



# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# GET B FACTOR TWO OUTLIERS OMITTED (VIEW THE PREVIOUS) ::::::::::::::::::::::::::::::
RR_master_OM            <- RR_master %>% filter(!is.na(resp_umol_L_hr)) %>%  filter(!is.na(Dry_Tissue_weight)) 
RR_master_OM$log10_VO2  <- log10(as.numeric(RR_master_OM$resp_umol_L_hr)) # assign resp value
RR_master_OM$log10_TDW  <- log10(as.numeric(RR_master_OM$Dry_Tissue_weight)) # assign length value 
# summary(lm(RR_master_OM$log10_VO2~RR_master_OM$log10_TDW)) # 0.79749 == b factor


MO2_b.factor_PLOT_OM <- RR_master_OM %>% 
                       dplyr::filter(!(log10_TDW > -1 & log10_VO2 < 0)) %>%  # outliers ommited (should be 2 data points)
                       ggplot(aes(x=log10_TDW, y=log10_VO2)) +
                          geom_point() +
                          theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                          scale_x_continuous(name ="log10_BodyMass; TDW in g") +
                          scale_y_continuous(name ="log10_MO2; RR in umol L-1 hr-1)") +
                          theme_classic() +
                          theme(legend.position="none",axis.title.y=element_text(size=7)) +
                          ggtitle("Metabolic scaling: log10_MO2 = log10_a + (b.factor * log10_BodyMass)") +
                          geom_smooth(method = lm, color = 'red') +
                          ggpmisc::stat_poly_eq(parse=T, aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), label.x.npc = "left")

MO2_b.factor_PLOT_facetted_OM <- RR_master_OM %>% 
                       dplyr::filter(!(log10_TDW > -1 & log10_VO2 < 0)) %>%  # outliers ommited (should be 2 data points)
                       ggplot(aes(x=log10_TDW, y=log10_VO2, color = pCO2)) +
                          geom_point() +
                          scale_color_manual(values=c("blue","orange")) +
                          theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                          scale_x_continuous(name ="log10_BodyMass; TDW in g") +
                          scale_y_continuous(name ="log10_MO2; RR in umol L-1 hr-1)") +
                          theme_classic() +
                          theme(legend.position="none",axis.title.y=element_text(size=7)) +
                          ggtitle("Metabolic scaling: log10_MO2 = log10_a + (b.factor * log10_BodyMass)") +
                          geom_smooth(method = lm, color = 'red') +
                          ggpmisc::stat_poly_eq(parse=T, aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), label.x.npc = "left") +
                          facet_wrap(~pCO2)

pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/Respiration/metabolic_scaling/MetabolicScaling_bFactor_TDW_OM.pdf"), width = 8, height = 8)
print(ggarrange(MO2_b.factor_PLOT_OM, MO2_b.factor_PLOT_facetted_OM, nrow = 2, ncol = 1)) # print the model diagnostics 
dev.off()
print(ggarrange(MO2_b.factor_PLOT_OM, MO2_b.factor_PLOT_facetted_OM, nrow = 2, ncol = 1)) # print the model diagnostics 



```

### summary: 

* TDW b factor total = 0.822

* TDW b factor pCO2 high = 0.803

* TDW b factor pCO2 low = 0.841 - two outliers removed here


## by SHELL AND INDIVIDUAL LENGTH 

```{r b factor SHELL AND INDIVIDUAL LENGTH, echo=TRUE, echo = FALSE,message = FALSE, warning = FALSE, results='hide'}

# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# GET B FACTOR FOR ALL AVAILABLE INDIVIDUALS WITH LENGTH AND MO2 ::::::::::::::::::::::::::::::
RR_master_OM               <- RR_master %>% filter(!is.na(resp_umol_L_hr)) %>%  filter(!is.na(Length_um)) 
RR_master_OM$log10_VO2     <- log10(as.numeric(RR_master_OM$resp_umol_L_hr)) # assign resp value
RR_master_OM$log10_Length  <- log10(as.numeric(RR_master_OM$Length_um)) # assign length value 
#summary(lm(RR_master_OM$log10_VO2~RR_master_OM$log10_Length)) # 1.8502 == b factor

MO2_b.factorLENGTH_PLOT <- RR_master_OM %>% 
                           #filter(!resp_umol_L_hr < 0.08) %>% 
                           ggplot(aes(x=log10_Length, y=log10_VO2)) +
                              geom_point() +
                              theme(panel.grid.major = element_blank(), 
                                    panel.grid.minor = element_blank())+ 
                              scale_x_continuous(name ="log10_Length; in mm") +
                              scale_y_continuous(name ="log10_MO2; RR in umol L-1 hr-1)") +
                              theme_classic() +
                              theme(legend.position="none",axis.title.y=element_text(size=7)) +
                              ggtitle("Metabolic scaling: log10_MO2 = log10_a + 
                                      (b.factor * log10_Length)") +
                              geom_smooth(method = lm, color = 'red') +
                              ggpmisc::stat_poly_eq(parse=T, 
                                                    aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
                                                    label.x.npc = "left")
#MO2_b.factorLENGTH_PLOT



MO2_b.factorLENGTH_PLOT_facetted <- RR_master_OM %>% 
                                     ggplot(aes(x=log10_Length, y=log10_VO2, color = pCO2)) +
                                        geom_point() +
                                        scale_color_manual(values=c("blue","orange")) +
                                        theme(panel.grid.major = element_blank(), 
                                              panel.grid.minor = element_blank())+ 
                                        scale_x_continuous(name ="log10_Length; in mm") +
                                        scale_y_continuous(name ="log10_MO2; RR in umol L-1 hr-1)") +
                                        theme_classic() +
                                        theme(legend.position="none",axis.title.y=element_text(size=7)) +
                                        ggtitle("Metabolic scaling: log10_MO2 = log10_a + 
                                                (b.factor * log10_Length)") +
                                        geom_smooth(method = lm, color = 'red') +
                                        ggpmisc::stat_poly_eq(parse=T, 
                                                              aes(label = paste(..eq.label..,
                                                                                ..rr.label.., sep = "~~~")),
                                                              label.x.npc = "left") +
                                        facet_wrap(~pCO2)
# MO2_b.factorLENGTH_PLOT_facetted


# OUTPUT PLOTS 
pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/Respiration/metabolic_scaling/MetabolicScaling_bFactor_LENGTH.pdf"), width = 8, height = 8)
print(ggarrange(MO2_b.factorLENGTH_PLOT, MO2_b.factorLENGTH_PLOT_facetted, nrow = 2, ncol = 1)) # print the model diagnostics
dev.off() 

print(ggarrange(MO2_b.factorLENGTH_PLOT, MO2_b.factorLENGTH_PLOT_facetted, nrow = 2, ncol = 1)) # print the model diagnostics



```

### summary: 

* Length b factor total = 2.18

* Length b factor pCO2 high = 2.2

* Length b factor pCO2 low = 2.16


## WHOLE DRY WEIGHT 

```{r b factor WHOLE DRY WEIGHT, echo=TRUE, echo = FALSE,message = FALSE, warning = FALSE, results='hide'}

# ABOUT: 

# from Bayne text (page 360)

# b is the scaling exponent, 
# log10_M_O2 = log10_a + (b.factor * log10_Mass) 
# M_O2 ‚àù a*Mass^(b.factor),
# y   =  m(x)^b.factor

# b = the coefficient estimated empirically by fitting the allometric equation below
# [ln(VO2])] = ln(a) + b*(ln(TDW))


# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# GET B FACTOR FOR ALL AVAILABLE INDIVIDUALS WITH TDW AND MO2 ::::::::::::::::::::::::::::::

# Note: many ealier rates (larvae - spat F1s) do NOT contain tissue dry weight (TDW) due to size and fragility of the shell for accurate dissections
# this first part of the chunk I will get b factor for the animals that contain TDW, next we will use the equations from size parameters figures (review Growth_Survival.Rmd outputs) 
# to extrapolate TDW for smaller individuals to performa metabolic scaling for all size ranges 



RR_master_OM_WDW            <- RR_master %>% filter(!is.na(resp_umol_L_hr)) %>%  
                                         dplyr::filter(!is.na(whole_Dry_weight))
RR_master_OM_WDW$log10_VO2  <- log10(as.numeric(RR_master_OM_WDW$resp_umol_L_hr)) # assign resp value
RR_master_OM_WDW$log10_WDW  <- log10(as.numeric(RR_master_OM_WDW$whole_Dry_weight)) # assign length value 
#summary(lm(RR_master_OM_WDW$log10_VO2~RR_master_OM_WDW$log10_WDW)) # 0.58873 == b factor

MO2_b.factorWDW_PLOT <- RR_master_OM_WDW %>% 
                         ggplot(aes(x=log10_WDW, y=log10_VO2)) +
                            geom_point() +
                            theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                            scale_x_continuous(name ="log10_BodyMass; WDW in g") +
                            scale_y_continuous(name ="log10_MO2; RR in umol L-1 hr-1)") +
                            theme_classic() +
                            theme(legend.position="none",axis.title.y=element_text(size=7)) +
                            ggtitle("Metabolic scaling: log10_MO2 = log10_a + (b.factor * log10_BodyMass)") +
                            geom_smooth(method = lm, color = 'red') +
                            ggpmisc::stat_poly_eq(parse=T, aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), label.x.npc = "left")
#MO2_b.factorWDW_PLOT



MO2_b.factorWDW_PLOT_facetted <- RR_master_OM_WDW %>% 
                                 ggplot(aes(x=log10_WDW, y=log10_VO2, color = pCO2)) +
                                    geom_point() +
                                    scale_color_manual(values=c("blue","orange")) +
                                    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                                    scale_x_continuous(name ="log10_BodyMass; WDW in g") +
                                    scale_y_continuous(name ="log10_MO2; RR in umol L-1 hr-1)") +
                                    theme_classic() +
                                    theme(legend.position="none",axis.title.y=element_text(size=7)) +
                                    ggtitle("Metabolic scaling: log10_MO2 = log10_a + (b.factor * log10_BodyMass)") +
                                    geom_smooth(method = lm, color = 'red') +
                                    ggpmisc::stat_poly_eq(parse=T, aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), label.x.npc = "left") +
                                    facet_wrap(~pCO2)
#MO2_b.factorWDW_PLOT_facetted


# OUTPUT PLOTS 
pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/Respiration/metabolic_scaling/MetabolicScaling_bFactor_WDW.pdf"), width = 8, height = 8)
print(ggarrange(MO2_b.factorWDW_PLOT, MO2_b.factorWDW_PLOT_facetted, nrow = 2, ncol = 1)) # print the model diagnostics 
dev.off()


print(ggarrange(MO2_b.factorWDW_PLOT, MO2_b.factorWDW_PLOT_facetted, nrow = 2, ncol = 1)) # print the model diagnostics 



```

### summary: 

* WDW b factor total = 0.748

* WDW b factor pCO2 high = 0.745

* WDW b factor pCO2 low = 0.754



# DATA VISUALIZATION 

* raw data (umol O2 hr-1)

* TDW: 
  
    - umol O2 hr-1 gTDW-1 
    
    - umol O2 hr-1 gTDW-1 b factor normalized and meanTDW standardized
    
* Length: 
  
    - umol O2 hr-1 mmLength-1 
    
    - umol O2 hr-1 mmLength-1 b factor normalized and meanLength standardized


```{r, format RRmaster,echo = FALSE, results='hide',message = FALSE, warning = FALSE} 
# unique(as.Date(RR_master$Date, format="%m/%d/%Y")) # view to input labels below

RR_formatted <- RR_master %>% 
  dplyr::mutate(Date = as.Date(Date, format="%m/%d/%Y")) %>% 
  
  dplyr::mutate(Gen = case_when(Date < '2022-03-01' ~ "F1s",
                                Date > '2022-02-02' & filetype == 'LoLigo_data' ~ "F1s",
                                Date > '2022-02-02' & filetype == 'SDR_data' ~ "F2s")) %>% 
  dplyr::mutate(Gen_lifestage = case_when(Gen == 'F1s' & Date < '2021-10-26' ~ "F1s A: small_juv",
                                          Gen == 'F1s' &  Date > '2021-09-30' &  
                                            Date < '2022-03-01' ~ "F1s B: mid_juv",
                                          Gen == 'F1s' & 
                                            Date > '2022-02-02' ~ "F1s C: late_juv_adult",
                                          Date == '2022-08-30' & Num_indivs == 5 ~ "F2s A: larvae",
                                          Date == '2022-08-30' & Num_indivs == 1 ~ "F2s B: spat")) %>% 
  dplyr::filter(!Fed_Unfed %in% 'Low food')




# F1s and bfactor normalize them
RR_formatted_F1s <- RR_formatted %>% dplyr::filter(!Gen %in% 'F2s')  # call only F1s

# call all bfactors (calc above!)
bTDW = 0.822 # review the outlier-omitted b factor plot in previous chunk
bLength = 2.18 # review the outlier-omitted b factor plot in previous chunk


medianLength <- median(RR_formatted_F1s$Length_um/1000) # 12.61 mm

# calc the mean for TDw and length
RR_formatted_F1s$Dry_Tissue_weight <- as.numeric(RR_formatted_F1s$Dry_Tissue_weight)
meanTDW   <- mean((RR_formatted_F1s %>% 
                     dplyr::filter(!Dry_Tissue_weight %in% NA))$Dry_Tissue_weight) # 0.4750597 g
meanLength   <- mean(RR_formatted_F1s$Length_um/1000) # 16.89333 mm

#View(RR_formatted_F1s$TDW_um)
RR_formatted_F1smaster <- RR_formatted_F1s %>% 
  
  dplyr::mutate(resp_umol_hr_bFactorNormTDW.MEAN = 
                  (resp_umol_hr)*((meanTDW/Dry_Tissue_weight)^bTDW)) %>% # TDW b factor
  dplyr::mutate(resp_umol_hr_bFactorNormLength.MEAN = 
                    (resp_umol_hr)*((meanLength/Length_mm)^bLength) ) %>% # length b factor
  
  dplyr::mutate(resp_mg_hr_bFactorNormTDW.MEAN = 
                  (resp_mg_hr)*((meanTDW/Dry_Tissue_weight)^bTDW)) %>% # TDW b factor
  dplyr::mutate(resp_mg_hr_bFactorNormLength.MEAN = 
                    (resp_mg_hr)*((meanLength/Length_mm)^bLength) ) %>% # length b factor
  
  dplyr::select(c(Date,
                  pH,
                  pCO2,
                  Replicate,
                  Chamber_tank,
                  Number,
                  Run,
                  Channel,
                  filetype,
                  Filename,
                  Food,
                  Length_um,
                  Length_mm,
                  Dry_Shell_weight,
                  Dry_Tissue_weight,
                  whole_Dry_weight,
                  volume,
                  Biovol_length3,
                  actual_volume,
                  Lpc,
                  BLANK.mean_Lpc,
                  resp_blankStand,
                  resp_mg_hr,
                  resp_mg_hr_bFactorNormTDW.MEAN,
                  resp_mg_hr_bFactorNormLength.MEAN,
                  resp_umol_hr,
                  resp_umol_hr_bFactorNormTDW.MEAN,
                  resp_umol_hr_bFactorNormLength.MEAN,
                  Age,
                  Gen,
                  Gen_lifestage))

write.csv(RR_formatted_F1smaster, "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/Respiration/RR_F1s_calc_master.csv")
```



## BOXPLOTS the raw resp rate data

```{r, raw umol L hr,echo = FALSE, results='hide',message = FALSE, warning = FALSE}

 
# TISSUE ---------------------------------------------------------------------------- #
# PLOT THE F2S DATA FOR  DRY WEIGHT CORRECTION

F1s.BOXPLOT <- RR_formatted_F1s %>% 
  ggplot(aes(x = factor(Date), 
             y = resp_umol_L_hr, 
             fill = pCO2)) +
         geom_boxplot(alpha = 0.5, # color hue
             width=0.6, # boxplot width
             outlier.size=0, # make outliers small
             position = position_dodge(preserve = "single")) + 
         geom_point(pch = 19, 
                    position = position_jitterdodge(0.01), 
                    size=1) +
         scale_fill_manual(values=c("forestgreen","orange")) +
         theme_classic() + 
         #ylim(0, 0.2) +
         ggtitle("Raw resp") +
         theme(legend.position="none",
               axis.title.y=element_text(size=7),
               axis.title.x=element_text(size=7),
               axis.text.x=element_text(size=7)) +
         stat_summary(fun.y=mean, 
                      geom = "errorbar", 
                      aes(ymax = ..y.., ymin = ..y..), 
                      width = 0.6, 
                      size=0.4, 
                      linetype = "dashed", 
                      position = position_dodge(preserve = "single"))

#F1s.BOXPLOT

F1s.BOXPLOT_facetted <- RR_formatted_F1s %>% 
  ggplot(aes(x = factor(Date), 
             y = resp_umol_L_hr, 
             fill = pCO2)) +
         geom_boxplot(alpha = 0.5, # color hue
             width=0.6, # boxplot width
             outlier.size=0, # make outliers small
             position = position_dodge(preserve = "single")) + 
         geom_point(pch = 19, 
                    position = position_jitterdodge(0.01), 
                    size=1) +
         scale_fill_manual(values=c("forestgreen","orange")) +
         theme_classic() + 
         #ylim(0, 0.2) +
         ggtitle("Raw resp") +
         theme(legend.position="none",
               axis.title.y=element_text(size=7),
               axis.title.x=element_text(size=7),
               axis.text.x=element_text(size=7)) +
         stat_summary(fun.y=mean, 
                      geom = "errorbar", 
                      aes(ymax = ..y.., ymin = ..y..), 
                      width = 0.6, 
                      size=0.4, 
                      linetype = "dashed", 
                      position = position_dodge(preserve = "single")) +
         facet_wrap(~Gen_lifestage, scales = "free")

#F1s.BOXPLOT_facetted

ggarrange(F1s.BOXPLOT_facetted,F1s.BOXPLOT, nrow = 2, ncol = 1)

```



## BOXPLOTS by TISSUE DRY WEIGHT (b factor = 0.822)

```{r, by mg TISSUE,echo = FALSE, results='hide',message = FALSE, warning = FALSE}

 
# TISSUE ---------------------------------------------------------------------------- #
# PLOT THE F2S DATA FOR  DRY WEIGHT CORRECTION

F1s.BOXPLOT_TDW <- RR_formatted_F1s %>% 
  ggplot(aes(x = factor(Date), 
             y = resp_umol_L_mg_TDW_hr, 
             fill = pCO2)) +
         geom_boxplot(alpha = 0.5, # color hue
             width=0.6, # boxplot width
             outlier.size=0, # make outliers small
             position = position_dodge(preserve = "single")) + 
         geom_point(pch = 19, 
                    position = position_jitterdodge(0.01), 
                    size=1) +
         scale_fill_manual(values=c("forestgreen","orange")) +
         theme_classic() + 
         #ylim(0, 0.2) +
         ggtitle("Resp / TDW") +
         theme(legend.position="none",
               axis.title.y=element_text(size=7),
               axis.title.x=element_text(size=7),
               axis.text.x=element_text(size=7)) +
         stat_summary(fun.y=mean, 
                      geom = "errorbar", 
                      aes(ymax = ..y.., ymin = ..y..), 
                      width = 0.6, 
                      size=0.4, 
                      linetype = "dashed", 
                      position = position_dodge(preserve = "single")) #+
         #facet_wrap(~Gen_lifestage, scales = "free")

F1s.BOXPLOT_TDW_facetted <- RR_formatted_F1s %>% 
  ggplot(aes(x = factor(Date), 
             y = resp_umol_L_mg_TDW_hr, 
             fill = pCO2)) +
         geom_boxplot(alpha = 0.5, # color hue
             width=0.6, # boxplot width
             outlier.size=0, # make outliers small
             position = position_dodge(preserve = "single")) + 
         geom_point(pch = 19, 
                    position = position_jitterdodge(0.01), 
                    size=1) +
         scale_fill_manual(values=c("forestgreen","orange")) +
         theme_classic() + 
         #ylim(0, 0.2) +
         ggtitle("Resp / TDW") +
         theme(legend.position="none",
               axis.title.y=element_text(size=7),
               axis.title.x=element_text(size=7),
               axis.text.x=element_text(size=7)) +
         stat_summary(fun.y=mean, 
                      geom = "errorbar", 
                      aes(ymax = ..y.., ymin = ..y..), 
                      width = 0.6, 
                      size=0.4, 
                      linetype = "dashed", 
                      position = position_dodge(preserve = "single")) +
         facet_wrap(~Gen_lifestage, scales = "free")

print(ggarrange(F1s.BOXPLOT_TDW_facetted,F1s.BOXPLOT_TDW, nrow = 2, ncol = 1)) # print the model diagnostics 
pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/Respiration/Respiration_Boxplots_TDW_raw.pdf"), width = 18, height = 8)
print(ggarrange(F1s.BOXPLOT_TDW_facetted,F1s.BOXPLOT_TDW, nrow = 2, ncol = 1)) # print the model diagnostics 
dev.off()
 

# B factor normalized - TISSUE DRY WEIGHT

bTDW = 0.822 # review the outlier-omitted b factor plot in previous chunk

RR_formatted_F1s$Dry_Tissue_weight <- as.numeric(RR_formatted_F1s$Dry_Tissue_weight)
meanTDW   <- mean((RR_formatted_F1s %>% dplyr::filter(!Dry_Tissue_weight %in% NA))$Dry_Tissue_weight) # 0.4750597 g
medianTDW <- median((RR_formatted_F1s %>% dplyr::filter(!Dry_Tissue_weight %in% NA))$Dry_Tissue_weight) # 0.1436 g

#View(RR_formatted_F1s$TDW_um)
RR_formatted_F1s.TDW <- RR_formatted_F1s %>% 
  dplyr::mutate(resp_umol_L_hr_bFactorNormTDW.MEAN = (resp_umol_L_hr)*((meanTDW/Dry_Tissue_weight)^bTDW) ) %>% # RStd = (Lexp/Lstd)1.77 * RRexp 
  dplyr::mutate(resp_umol_L_hr_bFactorNormTDW.MEDIAN = (resp_umol_L_hr)*((medianTDW/Dry_Tissue_weight)^bTDW) ) # RStd = (Lexp/Lstd)1.77 * RRexp

F1s.BOXPLOT_TDW_bfactor <- RR_formatted_F1s.TDW %>% 
  ggplot(aes(x = factor(Date), 
             y = resp_umol_L_hr_bFactorNormTDW.MEAN, 
             fill = pCO2)) +
         geom_boxplot(alpha = 0.5, # color hue
             width=0.6, # boxplot width
             outlier.size=0, # make outliers small
             position = position_dodge(preserve = "single")) + 
         geom_point(pch = 19, 
                    position = position_jitterdodge(0.01), 
                    size=1) +
         scale_fill_manual(values=c("forestgreen","orange")) +
         theme_classic() + 
         ggtitle("Resp * [ (meanTDW / TDW_meas)^0.822 ]") +
         theme(legend.position="none",
               axis.title.y=element_text(size=7),
               axis.title.x=element_text(size=7),
               axis.text.x=element_text(size=7)) +
         #ylim(0, 0.2) +
         stat_summary(fun.y=mean, 
                      geom = "errorbar", 
                      aes(ymax = ..y.., ymin = ..y..), 
                      width = 0.6, 
                      size=0.4, 
                      linetype = "dashed", 
                      position = position_dodge(preserve = "single")) # +
         #facet_wrap(~Gen_lifestage, scales = "free") #, scales = "free)

F1s.BOXPLOT_TDW_bfactor_facetted <- RR_formatted_F1s.TDW %>% 
   ggplot(aes(x = factor(Date), 
             y = resp_umol_L_hr_bFactorNormTDW.MEAN, 
             fill = pCO2)) +
         geom_boxplot(alpha = 0.5, # color hue
             width=0.6, # boxplot width
             outlier.size=0, # make outliers small
             position = position_dodge(preserve = "single")) + 
         geom_point(pch = 19, 
                    position = position_jitterdodge(0.01), 
                    size=1) +
         scale_fill_manual(values=c("forestgreen","orange")) +
         theme_classic() + 
         ggtitle("Resp * [ (meanTDW / TDW_meas)^0.822 ]") +
         theme(legend.position="none",
               axis.title.y=element_text(size=7),
               axis.title.x=element_text(size=7),
               axis.text.x=element_text(size=7)) +
         #ylim(0, 0.2) +
         stat_summary(fun.y=mean, 
                      geom = "errorbar", 
                      aes(ymax = ..y.., ymin = ..y..), 
                      width = 0.6, 
                      size=0.4, 
                      linetype = "dashed", 
                      position = position_dodge(preserve = "single")) +
         facet_wrap(~Gen_lifestage, scales = "free") #, scales = "free)

print(ggarrange(F1s.BOXPLOT_TDW_bfactor_facetted, F1s.BOXPLOT_TDW_bfactor, nrow = 2, ncol = 1)) # print the model diagnostics 


pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/Respiration/Respiration_Boxplots_TDW_biovol.pdf"), width = 8, height = 8)
print(ggarrange(F1s.BOXPLOT_TDW_facetted, F1s.BOXPLOT_TDW_bfactor, nrow = 2, ncol = 1)) # print the model diagnostics 
dev.off()


```


## BOXPLOTS by SHELL LENGTH (b factor = 2.18)

```{r, by MM LENGTH,echo = FALSE, results='hide',message = FALSE, warning = FALSE}

 
# TISSUE ---------------------------------------------------------------------------- #
# PLOT THE F2S DATA FOR  DRY WEIGHT CORRECTION

F1s.BOXPLOT_Length_facetted <- RR_formatted_F1s %>% 
  ggplot(aes(x = factor(Date), 
             y = resp_umol_L_mm_Length_hr, 
             fill = pCO2)) +
         geom_boxplot(alpha = 0.5, # color hue
             width=0.6, # boxplot width
             outlier.size=0, # make outliers small
             position = position_dodge(preserve = "single")) + 
         geom_point(pch = 19, 
                    position = position_jitterdodge(0.01), 
                    size=1) +
         scale_fill_manual(values=c("forestgreen","orange")) +
         theme_classic() + 
         #ylim(0, 0.2) +
         ggtitle("Resp / Length (raw)") +
         theme(legend.position="none",
               axis.title.y=element_text(size=7),
               axis.title.x=element_text(size=7),
               axis.text.x=element_text(size=7)) +
         stat_summary(fun.y=mean, 
                      geom = "errorbar", 
                      aes(ymax = ..y.., ymin = ..y..), 
                      width = 0.6, 
                      size=0.4, 
                      linetype = "dashed", 
                      position = position_dodge(preserve = "single")) +
         facet_wrap(~Gen_lifestage, scales = "free")
#F1s.BOXPLOT_Length_facetted # not that we do not have Length for 9/14 and 9/30 data 

 F1s.BOXPLOT_Length_nofacet <- RR_formatted_F1s %>% 
                        ggplot(aes(x = factor(Date), 
                                   y = resp_umol_L_mm_Length_hr, 
                                   fill = pCO2)) +
                               geom_boxplot(alpha = 0.5, # color hue
                                   width=0.6, # boxplot width
                                   outlier.size=0, # make outliers small
                                   position = position_dodge(preserve = "single")) + 
                               geom_point(pch = 19, 
                                          position = position_jitterdodge(0.01), 
                                          size=1) +
                               scale_fill_manual(values=c("forestgreen","orange")) +
                               theme_classic() + 
                               ggtitle("Resp / Length (raw)") +
                               theme(legend.position="none",
                                   axis.title.y=element_text(size=7),
                                   axis.title.x=element_text(size=7),
                                   axis.text.x=element_text(size=7)) +
                               #ylim(0, 0.2) +
                               stat_summary(fun.y=mean, 
                                            geom = "errorbar", 
                                            aes(ymax = ..y.., ymin = ..y..), 
                                            width = 0.6, 
                                            size=0.4, 
                                            linetype = "dashed", 
                                            position = position_dodge(preserve = "single")) 
# save
pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/Respiration/Respiration_Boxplots_LENGTH_raw.pdf"), width = 18, height = 8)
print(ggarrange(F1s.BOXPLOT_Length_facetted,F1s.BOXPLOT_Length_nofacet, nrow = 1, ncol = 2)) # print the model diagnostics 
dev.off()
 

# print for Rmarkdown
print(ggarrange(F1s.BOXPLOT_Length_facetted,F1s.BOXPLOT_Length_nofacet, nrow = 2, ncol = 1)) # print the model diagnostics 


# B factor normalized - SHELL LENGTH

bLength = 2.18 # review the outlier-omitted b factor plot in previous chunk

meanLength   <- mean(RR_formatted_F1s$Length_um/1000) # 16.89333 mm
medianLength <- median(RR_formatted_F1s$Length_um/1000) # 12.61 mm

#View(RR_formatted_F1s$Length_um)
RR_formatted_F1s.length <- RR_formatted_F1s %>% 
  dplyr::mutate(Length_mm = Length_um/1000) %>% 
  dplyr::mutate(resp_umol_L_hr_bFactorNormLength.MEAN = (resp_umol_L_hr)*((meanLength/Length_mm)^bLength) ) %>% # RStd = (Lexp/Lstd)1.77 * RRexp 
  dplyr::mutate(resp_umol_L_hr_bFactorNormLength.MEDIAN = (resp_umol_L_hr)*((medianLength/Length_mm)^bLength) ) # RStd = (Lexp/Lstd)1.77 * RRexp

F1s.BOXPLOT_Length_bfactor.MEAN <- RR_formatted_F1s.length %>% 
  ggplot(aes(x = factor(Date), 
             y = resp_umol_L_hr_bFactorNormLength.MEAN, 
             fill = pCO2)) +
         geom_boxplot(alpha = 0.5, # color hue
             width=0.6, # boxplot width
             outlier.size=0, # make outliers small
             position = position_dodge(preserve = "single")) + 
         geom_point(pch = 19, 
                    position = position_jitterdodge(0.01), 
                    size=1) +
         scale_fill_manual(values=c("forestgreen","orange")) +
         theme_classic() + 
         ggtitle("Resp * [ ( meanLength / Length_meas)^2.18 ]") +
         theme(legend.position="none",
               axis.title.y=element_text(size=7),
               axis.title.x=element_text(size=7),
               axis.text.x=element_text(size=7)) +
         #ylim(0, 0.2) +
         stat_summary(fun.y=mean, 
                      geom = "errorbar", 
                      aes(ymax = ..y.., ymin = ..y..), 
                      width = 0.6, 
                      size=0.4, 
                      linetype = "dashed", 
                      position = position_dodge(preserve = "single")) +
         facet_wrap(~Gen_lifestage, scales = "free") #, scales = "free)

F1s.BOXPLOT_Length_bfactor.MEAN.nofacet <- RR_formatted_F1s.length %>% 
  ggplot(aes(x = factor(Date), 
             y = resp_umol_L_hr_bFactorNormLength.MEAN, 
             fill = pCO2)) +
         geom_boxplot(alpha = 0.5, # color hue
             width=0.6, # boxplot width
             outlier.size=0, # make outliers small
             position = position_dodge(preserve = "single")) + 
         geom_point(pch = 19, 
                    position = position_jitterdodge(0.01), 
                    size=1) +
         scale_fill_manual(values=c("forestgreen","orange")) +
         theme_classic() + 
         ggtitle("Resp * [ (meanLength/Length_meas)^2.18 ]") +
         theme(legend.position="none",
               axis.title.y=element_text(size=7),
               axis.title.x=element_text(size=7),
               axis.text.x=element_text(size=7)) +
         #ylim(0, 0.2) +
         stat_summary(fun.y=mean, 
                      geom = "errorbar", 
                      aes(ymax = ..y.., ymin = ..y..), 
                      width = 0.6, 
                      size=0.4, 
                      linetype = "dashed", 
                      position = position_dodge(preserve = "single")) # no facet

# save
pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/Respiration/Respiration_Boxplots_LENGTH_bfactorMEAN.pdf"), width = 18, height = 8)
print(ggarrange(F1s.BOXPLOT_Length_bfactor.MEAN,F1s.BOXPLOT_Length_bfactor.MEAN.nofacet, nrow = 1, ncol = 2)) # print the model diagnostics 
dev.off()

# print for Rmarkdown
print(ggarrange(F1s.BOXPLOT_Length_bfactor.MEAN,F1s.BOXPLOT_Length_bfactor.MEAN.nofacet, nrow = 2, ncol = 1)) # print the model diagnostics 



F1s.BOXPLOT_Length_bfactor.MEDIAN <- RR_formatted_F1s.length %>% 
  ggplot(aes(x = factor(Date), 
             y = resp_umol_L_hr_bFactorNormLength.MEDIAN, 
             fill = pCO2)) +
         geom_boxplot(alpha = 0.5, # color hue
             width=0.6, # boxplot width
             outlier.size=0, # make outliers small
             position = position_dodge(preserve = "single")) + 
         geom_point(pch = 19, 
                    position = position_jitterdodge(0.01), 
                    size=1) +
         scale_fill_manual(values=c("forestgreen","orange")) +
         theme_classic() + 
         ggtitle("Resp / [ (Length_meas / medianLength)^2.18 ]") +
         theme(legend.position="none",
               axis.title.y=element_text(size=7),
               axis.title.x=element_text(size=7),
               axis.text.x=element_text(size=7)) +
         #ylim(0, 0.2) +
         stat_summary(fun.y=mean, 
                      geom = "errorbar", 
                      aes(ymax = ..y.., ymin = ..y..), 
                      width = 0.6, 
                      size=0.4, 
                      linetype = "dashed", 
                      position = position_dodge(preserve = "single")) +
         facet_wrap(~Gen_lifestage, scales = "free") #, scales = "free)


F1s.BOXPLOT_Length_bfactor.MEDIAN.nofacet <- RR_formatted_F1s.length %>% 
  ggplot(aes(x = factor(Date), 
             y = resp_umol_L_hr_bFactorNormLength.MEDIAN, 
             fill = pCO2)) +
         geom_boxplot(alpha = 0.5, # color hue
             width=0.6, # boxplot width
             outlier.size=0, # make outliers small
             position = position_dodge(preserve = "single")) + 
         geom_point(pch = 19, 
                    position = position_jitterdodge(0.01), 
                    size=1) +
         scale_fill_manual(values=c("forestgreen","orange")) +
         theme_classic() + 
         ggtitle("Resp * [ ( medianLength / Length_meas)^2.18 ]") +
         theme(legend.position="none",
               axis.title.y=element_text(size=7),
               axis.title.x=element_text(size=7),
               axis.text.x=element_text(size=7)) +
         #ylim(0, 0.2) +
         stat_summary(fun.y=mean, 
                      geom = "errorbar", 
                      aes(ymax = ..y.., ymin = ..y..), 
                      width = 0.6, 
                      size=0.4, 
                      linetype = "dashed", 
                      position = position_dodge(preserve = "single")) # no facet


 
pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/Respiration/Respiration_Boxplots_LENGTH_bfactorMEDIAN.pdf"), width = 18, height = 8)
print(ggarrange(F1s.BOXPLOT_Length_bfactor.MEDIAN,F1s.BOXPLOT_Length_bfactor.MEDIAN.nofacet, nrow = 1, ncol = 2)) # print the model diagnostics 
dev.off()


```


## BOXPLOTS by WHOLE DRY WEIGHT (b factor = 0.748)

```{r, by mg WHOLE DRY WEIGHT,echo = FALSE, results='hide',message = FALSE, warning = FALSE}


F1s.BOXPLOT_WDW <- RR_formatted_F1s %>% 
  ggplot(aes(x = factor(Date), 
             y = resp_umol_L_mg_WDW_hr, 
             fill = pCO2)) +
         geom_boxplot(alpha = 0.5, # color hue
             width=0.6, # boxplot width
             outlier.size=0, # make outliers small
             position = position_dodge(preserve = "single")) + 
         geom_point(pch = 19, 
                    position = position_jitterdodge(0.01), 
                    size=1) +
         scale_fill_manual(values=c("forestgreen","orange")) +
         theme_classic() + 
         ggtitle("whole Dry weight corrected") +
         theme(legend.position="none",
               axis.title.y=element_text(size=7),
               axis.title.x=element_text(size=7),
               axis.text.x=element_text(size=7)) +
         #ylim(0, 0.2) +
         stat_summary(fun.y=mean, 
                      geom = "errorbar", 
                      aes(ymax = ..y.., ymin = ..y..), 
                      width = 0.6, 
                      size=0.4, 
                      linetype = "dashed", 
                      position = position_dodge(preserve = "single"))# +
        # facet_wrap(~Gen_lifestage, scales = "free") #, scales = "free)


pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/Respiration/Respiration_Boxplots_WDW_raw.pdf"), width = 18, height = 8)
print(ggarrange(F1s.BOXPLOT_WDW, nrow = 1, ncol = 1)) # print the model diagnostics 
dev.off()


# B factor normalized - WHOLE DRY WEIGHT
bWDW = 0.748 # review the outlier-omitted b factor plot in previous chunk
# View(RR_formatted)
F1s.BOXPLOT_WDW_bfactor <- RR_formatted_F1s %>% 
  dplyr::mutate(resp_umol_L_hr_bFactorNormWDW = resp_umol_L_hr/(as.numeric(whole_Dry_weight)^bWDW)) %>% 
  ggplot(aes(x = factor(Date), 
             y = resp_umol_L_hr_bFactorNormWDW, 
             fill = pCO2)) +
         geom_boxplot(alpha = 0.5, # color hue
             width=0.6, # boxplot width
             outlier.size=0, # make outliers small
             position = position_dodge(preserve = "single")) + 
         geom_point(pch = 19, 
                    position = position_jitterdodge(0.01), 
                    size=1) +
         scale_fill_manual(values=c("forestgreen","orange")) +
         theme_classic() + 
         ggtitle("whole Dry weight b factor (0.748)") +
         theme(legend.position="none",
               axis.title.y=element_text(size=7),
               axis.title.x=element_text(size=7),
               axis.text.x=element_text(size=7)) +
         #ylim(0, 0.2) +
         stat_summary(fun.y=mean, 
                      geom = "errorbar", 
                      aes(ymax = ..y.., ymin = ..y..), 
                      width = 0.6, 
                      size=0.4, 
                      linetype = "dashed", 
                      position = position_dodge(preserve = "single")) +
         facet_wrap(~Gen_lifestage, scales = "free") #, scales = "free)
F1s.BOXPLOT_WDW_bfactor # not that we do not have TDW for 9/14 and 9/30 data 


pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/Respiration/Respiration_Boxplots_WDW.pdf"), width = 8, height = 8)
print(ggarrange(F1s.BOXPLOT_WDW, F1s.BOXPLOT_WDW_bfactor, nrow = 2, ncol = 1)) # print the model diagnostics 
dev.off()

```




# STANDARDIZE AND STATISTICAL ANALYSIS 


``` {r, standardize & ANOVA stats,echo = FALSE, results='hide',message = FALSE, warning = FALSE}

# get mean and median length for 
RR_F1s       <- RR_formatted %>% dplyr::filter(!Gen %in% 'F2s') %>%  dplyr::mutate(Length_mm = as.numeric(Length_um/1000))
meanLength   <- mean(RR_F1s$Length_mm)    # 16.89333
medianLength <- median(RR_F1s$Length_mm)  # 12.61
bLength      <- 2.18 # review the outlier-omitted b factor plot in previous chunk

RR_formatted_F1s <- RR_formatted %>% dplyr::filter(!Gen %in% 'F2s') %>% 
  dplyr::mutate(Length_mm = Length_um/1000) %>% 
  dplyr::mutate(resp_umol_L_hr_bFactorNormLength.MEAN = (resp_umol_L_hr)*((meanLength/Length_mm)^bLength) ) %>% # RStd = (Lexp/Lstd)1.77 * RRexp 
  dplyr::mutate(resp_umol_L_hr_bFactorNormLength.MEDIAN = (resp_umol_L_hr)*((medianLength/Length_mm)^bLength) ) %>%  # RStd = (Lexp/Lstd)1.77 * RRexp
  dplyr::mutate(Date = as.factor(Date))


# (1) First, run anova within date for all records (for looped!)
ANOVA_Dates       <- as.data.frame(unique(RR_formatted_F1s$Date)) # call a list to loop in 
AOVdf_total       <- data.frame() # start dataframe, this will be the master output
DF_loop           <- data.frame(matrix(nrow = 1, ncol = 13)) # create dataframe to save during for loop
colnames(DF_loop) <- c('Date', 'Age', 'Metric', 'model', 'DF.num' , 'DF.denom', 'F_val','P_val', 'SigDif', 'ShapiroWilk', 'ResidNorm', 'Levenes', 'HomogVar') # names for comuns in the for loop



for (i in 1:nrow(ANOVA_Dates)) {

  date_loop     <- as.character(ANOVA_Dates[i,])
  data_loop     <- RR_formatted_F1s %>% 
                          dplyr::filter(Date == date_loop) %>% 
                          dplyr::select(Date, Age, pCO2, resp_umol_L_hr_bFactorNormLength.MEAN) %>% 
                          na.omit()

        AOVmod              <- aov(lm(data_loop$resp_umol_L_hr_bFactorNormLength.MEAN ~ data_loop$pCO2))
        DF_loop$Date        <- date_loop
        DF_loop$Age         <- data_loop$Age[1]
        DF_loop$Metric      <- 'Respiration rate; WDW b factor normalized'
        DF_loop$model       <- 'one-way AOV; x ~ treatment'
        DF_loop$DF.num      <- summary(AOVmod)[[1]][["Df"]][1]
        DF_loop$DF.denom    <- summary(AOVmod)[[1]][["Df"]][2]
        DF_loop$F_val       <- summary(AOVmod)[[1]][["F value"]][1]
        DF_loop$P_val       <- summary(AOVmod)[[1]][["Pr(>F)"]][1]
        DF_loop$SigDif      <- if( (summary(AOVmod)[[1]][["Pr(>F)"]][1]) > 0.05) {
          'NO'} else {'YES'}
        DF_loop$ShapiroWilk <- shapiro.test(resid(AOVmod))[[2]]
        DF_loop$ResidNorm   <- if( shapiro.test(resid(AOVmod))[[2]] > 0.05) {
          'YES'} else {'NO'}
        DF_loop$Levenes     <- leveneTest(AOVmod)[[3]][[1]]
        DF_loop$HomogVar    <- if( leveneTest(AOVmod)[[3]][[1]] > 0.05) {
          'YES'} else {'NO'}
        
        # asign loop and cumulative output table
        df          <- data.frame(DF_loop) # name dataframe for this single row
        AOVdf_total <- rbind(AOVdf_total,DF_loop) #bind to a cumulative list dataframe
        print(AOVdf_total) # print to monitor progress
        
}
AOVdf_total <- AOVdf_total %>% dplyr::arrange(Age)
# View(AOVdf_total) # view all the anova tests within data 


# WRITE CSV OF THE MASTER FILE
write.csv(AOVdf_total, "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/Respiration/Respiration_ANOVA_table_Length_mean.csv")
#write.csv(Biodep_Master, "C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/Biodeposition/Biodeposition_master.csv")


# Two way anova for pH * time



total_mod  <- aov(lm(resp_umol_L_hr_bFactorNormLength.MEAN  ~ pCO2 * Date, data = RR_formatted_F1s))
leveneTest(total_mod) # 0.006044 **
shapiro.test(resid(total_mod)) # 0.1374
hist(resid(total_mod)) # positive skew
qqnorm(resid(total_mod))
summary(total_mod)
check_model(total_mod)
                  


#find optimal lambda for Box-Cox transformation 



library(MASS)
bc     <- boxcox(RR_formatted_F1s$resp_umol_L_hr_bFactorNormLength.MEAN ~ RR_formatted_F1s$pCO2 * RR_formatted_F1s$Date) # y ~ x
lambda <- bc$x[which.max(bc$y)] # 0.1414141
new_model <- lm(((resp_umol_L_hr_bFactorNormLength.MEAN^lambda-1)/lambda) ~ pCO2 * Date, data = RR_formatted_F1s) #fit new linear regression model using the Box-Cox transformation
check_model(new_model)
leveneTest(new_model) # 0.0773  * - PASS
shapiro.test(resid(new_model)) # 0.5891 - normal
qqnorm(resid(new_model)) # boxcox resolves the qqnorm visual from the raw model greatly
summary(aov(new_model))  # date and pH significant 
#               Df    Sum Sq   Mean Sq F value Pr(>F)  
# pCO2          1 1.210e-14 1.210e-14   4.522 0.0354 *
# Date          1 2.000e-16 2.310e-16   0.086 0.7695  
# pCO2:Date     1 2.000e-16 1.750e-16   0.065 0.7985  
# Residuals   129 3.451e-13 2.675e-15 


# library(knitr)
# pander(anova(new_model), style='rmarkdown') # anova table of lmer
# kable(as.data.frame(anova(new_model))) %>%  # print a png of this table
#   kable_styling() %>%
#   save_kable(file = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/Respiration/Respiration_TwoWayANOVA_table_Length_mean.png", zoom = 1.5)
# 
#                           


```






