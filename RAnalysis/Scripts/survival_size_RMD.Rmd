---
title: "F1 Bay Scallops: High vs. Low food availability under OA conditions"
author: "Samuel Gurr"
date: "10/12/2021"
output:
  pdf_document:
    latex_engine: xelatex
---

Last updates: october 6, 2021


## Load libraries

```{r libraries, include=FALSE}

library(ggplot2)
library(dplyr)
library(tidyverse)
library(car)
library(nlme)
library(multcompView)
library(agricolae)
library(Rmisc)
library(lmerTest)
library(lme4)
library(pander)
library(performance)
library(Rmisc)
library(maditr)
library(reshape2)
library(ggpubr)

#setwd("C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis") # Work computer
setwd("C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis") # Work computer

ShellLength <- read.csv(file="Data/Survival_Size/Juvenile_lengths_master.csv", header = TRUE) 
TDW_AFDW    <- read.csv(file="Data/Survival_Size/TDW_AFDW_Condition_master.csv", header = TRUE) 
```


# density plots

```{r, Shell length}
library(dplyr)
library(tidyr)
ShellLength$Treatment <- as.factor(ShellLength$Treatment)

Alldensity <- ggplot(data = ShellLength, aes(x=Length_um)) + 
                geom_density(aes(x = Length_um, group=Treatment, fill=Treatment, ..scaled..), alpha = 0.4, adjust=1.5) + 
                theme_bw() +
                facet_wrap( ~ Age_DPF) + 
                scale_fill_brewer(palette = "Set1")

density_182DPF <- ShellLength %>% 
                  dplyr::filter(Age_DPF %in% 182) %>% 
                  ggplot(aes(x=Length_um)) + 
                    geom_density(aes(x = Length_um, group=Treatment, fill=Treatment, ..scaled..), alpha = 0.4, adjust=1.5) + 
                    theme_bw() +
                    scale_fill_brewer(palette = "Set1")

pdf(paste0(filename = "C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/Survival_Size/Juvenile_ShellLength_density.pdf"), width = 8, height = 6)
print(Alldensity) # print the model diagnostics 
dev.off()

pdf(paste0(filename = "C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/Survival_Size/Juvenile_ShellLength_density_182DPF.pdf"), width = 8, height = 6)
print(density_182DPF) # print the model diagnostics 
dev.off()
```

```{r, TDW}
library(dplyr)
library(tidyr)
TDW_AFDW$Treatment <- as.factor(TDW_AFDW$pH)


Alldensity_SDW <-TDW_AFDW[!is.na(TDW_AFDW$Dry_Shell_weight_g),] %>% 
                      ggplot(aes(x=Dry_Shell_weight_g)) + 
                      geom_density(aes(x = Dry_Shell_weight_g, group=Treatment, fill=Treatment, ..scaled..), alpha = 0.7,adjust=1.5) + 
                      theme_bw() +
                      ggtitle("Shell dry weight (mg)") +
                      facet_wrap( ~ Date_sampled) + 
                      scale_fill_brewer(palette = "Set1")
Alldensity_SDW


Alldensity_TDW <- TDW_AFDW[!is.na(TDW_AFDW$Dry_Tissue_Tin_Weight_g),] %>% 
                    ggplot(aes(x=Dry_Tissue_weight_g)) + 
                      geom_density(aes(x = Dry_Tissue_weight_g, group=Treatment, fill=Treatment, ..scaled..), alpha = 0.7,adjust=1.5) + 
                      theme_bw() +
                      ggtitle("Tissue dry weight (mg)") +
                      facet_wrap( ~ Date_sampled) + 
                      scale_fill_brewer(palette = "Set1")
 Alldensity_TDW

CI_TDW         <- TDW_AFDW %>% dplyr::filter(!Condition_index_drywtRatio_Walne1976 < 0) %>% 
                      ggplot(aes(x=Condition_index_drywtRatio_Walne1976)) + 
                      geom_density(aes(x = Condition_index_drywtRatio_Walne1976, group=Treatment, fill=Treatment, ..scaled..), alpha = 0.7,adjust=1.5) + 
                      theme_bw() +
                      ggtitle("CI (Ratio TDW / SDW)") +
                      facet_wrap( ~ Date_sampled) + 
                      scale_fill_brewer(palette = "Set1")
CI_TDW

CI_AFDW         <- TDW_AFDW %>% dplyr::filter(!Condition_index_ADFW_div_length < 0) %>% 
                      ggplot(aes(x=Condition_index_ADFW_div_length)) + 
                      geom_density(aes(x = Condition_index_ADFW_div_length, group=Treatment, fill=Treatment, ..scaled..),alpha = 0.7, adjust=1.5) + 
                      theme_bw() +
                      ggtitle("CI (AFDW / SL)") +
                      facet_wrap( ~ Date_sampled) + 
                      scale_fill_brewer(palette = "Set1")
CI_AFDW
ggarrange(Alldensity_SDW,Alldensity_TDW,CI_TDW, CI_AFDW)
```



```{r, AFDW}
library(dplyr)
library(tidyr)
library(ggpubr)
TDW_AFDW$Treatment <- as.factor(TDW_AFDW$pH)


Alldensity_length <-ggplot(data =TDW_AFDW,aes(x=Shell_length_mm)) + 
                      geom_density(aes(x = Shell_length_mm, group=Treatment, fill=Treatment, ..scaled..), alpha = 0.4, adjust=1.5) + 
                      theme_bw() +
                      ggtitle("Length (mm)") +
                      facet_wrap( ~ Date_sampled) + 
                      scale_fill_brewer(palette = "Set1")
Alldensity_length


Alldensity_AFDW <- TDW_AFDW %>% dplyr::filter(!AFDW_g < 0) %>% 
                    ggplot(aes(x=AFDW_g)) + 
                      geom_density(aes(x = AFDW_g, group=Treatment, fill=Treatment, ..scaled..), alpha = 0.4, adjust=1.5) + 
                      theme_bw() +
                      ggtitle("AFDW (mg)") +
                      facet_wrap( ~ Date_sampled) + 
                      scale_fill_brewer(palette = "Set1")
Alldensity_AFDW

CI_AFDW        <- TDW_AFDW %>% dplyr::filter(!Condition_index_ADFW_div_length < 0) %>% 
                    ggplot(aes(x=Condition_index_ADFW_div_length)) + 
                      geom_density(aes(x = Condition_index_ADFW_div_length, group=Treatment, fill=Treatment, ..scaled..), alpha = 0.4, adjust=1.5) + 
                      theme_bw() +
                      ggtitle("CI (AFDW / length * 1000)") +
                      facet_wrap( ~ Date_sampled) + 
                      scale_fill_brewer(palette = "Set1")
CI_AFDW

ggarrange(Alldensity_length,Alldensity_AFDW,CI_AFDW)

```


# regression of size metrics

```{r Length plot Mean SE}

ConditionIndex_Summ <-summarySE(Master_DW_CI, measurevar="CI", groupvars=c("Date_sampled", "pH")) %>% 
                        dplyr::mutate(pCO2 = case_when(pH == 8  ~ "500 μatm", pH == 7.5 ~ "800 μatm")) # cahmber volumes on different dates with

CI_Plot <- ConditionIndex_Summ %>% 
   dplyr::mutate(pCO2 = case_when(pH == 8  ~ "500 μatm", pH == 7.5 ~ "800 μatm")) %>% 
   dplyr::mutate(Age = case_when(Date_sampled == '10/26/2021'  ~ 92, Date_sampled == '12/2/2021' ~ 139)) %>% 
   ggplot(aes(x=as.factor(Age), y=CI, color=as.factor(pCO2))) +
      geom_point(position=position_dodge(.5))+ 
      scale_color_manual(values=c("forestgreen","darkorange2"))+
      geom_errorbar(aes(ymin=CI-se, ymax=CI+se), width=.2,
                    position=position_dodge(.5))+
      theme_classic() +  
      xlab("Age (d)") +
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
      scale_y_continuous(name ="Condition index")+
      geom_line(stat = "identity", size=1.0)+
      theme(text = element_text(size=15))



Shell_length_mm_Summ <-summarySE(Master_DW_CI, measurevar="Shell_length_mm", groupvars=c("Date_sampled", "pH")) %>% 
                        dplyr::mutate(pCO2 = case_when(pH == 8  ~ "500 μatm", pH == 7.5 ~ "800 μatm")) # cahmber volumes on different dates with

Shell_Plot <- Shell_length_mm_Summ %>% 
   dplyr::mutate(pCO2 = case_when(pH == 8  ~ "500 μatm", pH == 7.5 ~ "800 μatm")) %>% 
   dplyr::mutate(Age = case_when(Date_sampled == '10/26/2021'  ~ 92, Date_sampled == '12/2/2021' ~ 139)) %>% 
   ggplot(aes(x=as.factor(Age), y=Shell_length_mm, color=as.factor(pCO2))) +
      geom_point(position=position_dodge(.5))+ 
      scale_color_manual(values=c("forestgreen","darkorange2"))+
      geom_errorbar(aes(ymin=Shell_length_mm-se, ymax=Shell_length_mm+se), width=.2,
                    position=position_dodge(.5))+
      theme_classic() +  
      xlab("Age (d)") +
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
      scale_y_continuous(name ="Shell length (mm)")+
      geom_line(stat = "identity", size=1.0)+
      theme(text = element_text(size=15))



DryTissueWeight_Summ <-summarySE(Master_DW_CI, measurevar="Dry_Tissue_weight_mg", groupvars=c("Date_sampled", "pH")) %>% 
                        dplyr::mutate(pCO2 = case_when(pH == 8  ~ "500 μatm", pH == 7.5 ~ "800 μatm")) # cahmber volumes on different dates with

DryTissueWeight_Plot <- DryTissueWeight_Summ %>% 
   dplyr::mutate(pCO2 = case_when(pH == 8  ~ "500 μatm", pH == 7.5 ~ "800 μatm")) %>% 
   dplyr::mutate(Age = case_when(Date_sampled == '10/26/2021'  ~ 92, Date_sampled == '12/2/2021' ~ 139)) %>% 
   ggplot(aes(x=as.factor(Age), y=Dry_Tissue_weight_mg, color=as.factor(pCO2))) +
      geom_point(position=position_dodge(.5))+ 
      scale_color_manual(values=c("forestgreen","darkorange2"))+
      geom_errorbar(aes(ymin=Dry_Tissue_weight_mg-se, ymax=Dry_Tissue_weight_mg+se), width=.2,
                    position=position_dodge(.5))+
      theme_classic() +  
      xlab("Age (d)") +
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
      scale_y_continuous(name ="Dry tissue weight (mg)")+
      geom_line(stat = "identity", size=1.0)+
      theme(text = element_text(size=15))



DryShellWeight_Summ <-summarySE(Master_DW_CI, measurevar="Dry_Shell_weight_mg", groupvars=c("Date_sampled", "pH")) %>% 
                        dplyr::mutate(pCO2 = case_when(pH == 8  ~ "500 μatm", pH == 7.5 ~ "800 μatm")) # cahmber volumes on different dates with

DryShellWeight_Plot <- DryShelWeight_Summ %>% 
   dplyr::mutate(pCO2 = case_when(pH == 8  ~ "500 μatm", pH == 7.5 ~ "800 μatm")) %>% 
   dplyr::mutate(Age = case_when(Date_sampled == '10/26/2021'  ~ 92, Date_sampled == '12/2/2021' ~ 139)) %>% 
   ggplot(aes(x=as.factor(Age), y=Dry_Shell_weight_mg, color=as.factor(pCO2))) +
      geom_point(position=position_dodge(.5))+ 
      scale_color_manual(values=c("forestgreen","darkorange2"))+
      geom_errorbar(aes(ymin=Dry_Shell_weight_mg-se, ymax=Dry_Shell_weight_mg+se), width=.2,
                    position=position_dodge(.5))+
      theme_classic() +  
      xlab("Age (d)") +
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
      scale_y_continuous(name ="Dry shell weight (mg)")+
      geom_line(stat = "identity", size=1.0)+
      theme(text = element_text(size=15))


# print in markdown file 
ggarrange(CI_Plot, Shell_Plot, DryTissueWeight_Plot, DryShellWeight_Plot,nrow = 2, ncol = 2)
# Export to pdf
pdf(paste0(filename = "C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_mutligen_OA/RAnalysis/Output/Survival_Size/CI_Length_92DPF_139DPF.pdf"), width = 12, height = 6)
ggarrange(CI_Plot, Shell_Plot, DryTissueWeight_Plot, DryShellWeight_Plot,nrow = 2, ncol = 2)
dev.off()

```
# Larvae survival - Low, Mod, High pCO2  (0 - 18 dpf)

```{r, Survival plot Mean SE}
#First make calculations for means and standard error
LarvaeSurvival_Summ <- summarySE(survival_larvae, measurevar="Survival", groupvars=c("Day", "Treatment")) %>% 
    dplyr::mutate(pCO2 = case_when(Treatment == "Low"  ~ "500 μatm", Treatment == "Moderate" ~ "800 μatm", Treatment == "High" ~ "1200 μatm")) # cahmber volumes on different dates with different instruments 


#stL$Treatment <- factor(stL$trt,                 # Relevel group factor
#                         levels = c("Low OA", "Moderate OA", "High OA"))
LarvaeSurvival_Summ$pCO2 <- factor(LarvaeSurvival_Summ$pCO2, c("500 μatm","800 μatm","1200 μatm"))
## Use geom_line and geom_point to plot over time
LarvaeSurvival_Plot <-ggplot(data=LarvaeSurvival_Summ, aes(x=Day, y=Survival, color=pCO2)) +
  geom_line( stat = "identity", size=1.0)+
  geom_point()+ 
  scale_color_manual(values=c("darkorange2","forestgreen", "purple"))+
  geom_errorbar(aes(ymin=Survival-se, ymax=Survival+se), width=.2,
                position=position_dodge(.1))+
  theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  scale_x_continuous(name ="Age (days)") +
  scale_y_continuous(name ="Survival (%)")+
  theme(text = element_text(size=15))
LarvaeSurvival_Plot


# pdf(paste0("C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/Survival_size/20210930_survival.pdf"))
pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/Survival_size/Larval_survival.pdf"),width=10, height=7)
LarvaeSurvival_Plot
dev.off()

```


# Food limitation x pCO2 experiment (50 - 92 dpf)

## Survival plot (all)

* Note: this experiment only included the low and moderate pCO2 due to low survivorship in the high pCO2 condition 

```{r foodxpCO2 survival mean SE plots}

#First make calculations for means and standard erro
survival_juvenile$Fed_Unfed <-  as.factor(gsub("^(?:[^_]+_){2}([^_]+).*", "\\1", survival_juvenile$trt))
levels(survival_juvenile$Fed_Unfed) <- c("High food", "Low food")


survival_juvenile$pCO2 <-  as.factor(gsub("^(?:[^_]+_){1}([^_]+).*", "\\1", survival_juvenile$trt))
levels(survival_juvenile$pCO2) <- c("800 μatm", "500 μatm")

# Survival ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

Survival_Means <- summarySE(survival_juvenile, measurevar="Survival", groupvars=c("Age_DPF", "pCO2", "Fed_Unfed")) 
Survival_Means$pCO2 <- factor(Survival_Means$pCO2, c("500 μatm","800 μatm"))

dodge <- position_dodge(.50)
## Use geom_line and geom_point to plot over time
Survival_All_plot <- ggplot(data=Survival_Means, aes(x=Age_DPF, y=Survival, color=pCO2)) +
  geom_line(aes(linetype = factor(Fed_Unfed)), size = c(0.2, 0.2,0.2, 
                                                        1,1, 1,
                                                        0.2, 0.2,0.2, 
                                                        1,1, 1)) +
  #geom_point(position = position_jitterdodge(jitter.width = 10)) +
  geom_point(position = position_dodge(width=10)) +
  #scale_color_manual(values=c("forestgreen","darkorange2")) +
  scale_color_manual(values=c("black","black")) +
  geom_errorbar(aes(ymin=Survival-se, ymax=Survival+se), width=.2,
                position=position_dodge(width=10))+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  scale_x_continuous(name ="Age (days)") +
  scale_y_continuous(name ="Survival (%)")  + 
  scale_linetype_manual(values = c("High food" = "solid", "Low food" = "dashed"))  +
  theme_classic() +
  theme(legend.position="none") +
  # facet_wrap(~factor(Fed_Unfed, level = c('Low food', 'High food'))) 
  facet_wrap(~pCO2)
Survival_All_plot
pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/Survival_size/Juvenile_length_FoodxOA.pdf"))
Survival_All_plot
dev.off()

```

##  Shell length plot (all)
```{r foodxpCO2 shell size  mean SE plots}
# Length ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

Length_Means <- summarySE(length, measurevar="Length_um", groupvars=c("Age_DPF", "pH", "Fed_Unfed"))
Length_Means <- Length_Means %>% 
  dplyr::mutate(pCO2 = case_when(pH == 8 ~ "500 μatm",  pH == 7.5 ~ "800 μatm")) %>% 
  dplyr::mutate(Fed_Unfed = case_when(Fed_Unfed == "fed" ~ "High food",  Fed_Unfed == "unfed" ~ "Low food"))

## Use geom_line and geom_point to plot over time
Length_All_plot <- ggplot(data=Length_Means, aes(x=Age_DPF, y=(Length_um/1000), color=pCO2)) +
  geom_line(aes(linetype = factor(Fed_Unfed)), size = 0.5) +  
  geom_point()+ 
  scale_color_manual(values=c("forestgreen","darkorange2"))+
  geom_errorbar(aes(ymin=(Length_um/1000)-(se/1000), ymax=(Length_um/1000)+(se/1000)), width=.2,
                position=position_dodge(.1))+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  scale_x_continuous(name ="Age (days)") +
  scale_y_continuous(name ="Shell length (mm)")  + 
  scale_linetype_manual(values = c("High food" = "solid", "Low food" = "dashed"))  +
  theme(legend.position="none") +
  # facet_wrap(~factor(Fed_Unfed, level = c('Low food', 'High food'))) 
  facet_wrap(~pCO2)
Length_All_plot
pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/Survival_size/Juvenile_length_FoodxOA.pdf"))
Length_All_plot
dev.off()

```


# Statistical analysis (survival + shell size)
* sorted by Age

### first load the necessary stats packages...
```{r, load stats packages}
# using lmer
library(lme4)
library(lmerTest)
# using lme
library(nlme)
library(car)
```


## Day 50 post-fertilization  (length only) 

* started with the same stock density per downweller - therefore no tests for survival here...

```{r, Day 50 data}
data_51 <- length %>%
  filter(Age_DPF=="51") %>%
  dplyr::mutate(pCO2 = case_when(pH == 8 ~ "500 μatm",  pH == 7.5 ~ "800 μatm")) %>% 
  dplyr::mutate(Fed_Unfed = case_when(Fed_Unfed == "fed" ~ "High food",  Fed_Unfed == "unfed" ~ "Low food"))

data_51$RFactor <- as.factor(paste(data_51$Replicate, data_51$pH, sep = '_'))

# One way ANOVA mixed effects model :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

# using lmer
ShellLengthMod_D51 <- lmer(Length_um ~ pCO2 + (1|RFactor),
                       data=data_51,
                       REML=TRUE)
pander(anova(ShellLengthMod_D51), style='rmarkdown')
check_model(ShellLengthMod_D51) # observe the diagnostics of the model
shapiro.test(residuals(ShellLengthMod_D51)) # non normal
leveneTest(residuals(ShellLengthMod_D51) ~ data_51$pCO2)

# using lme
ShellLengthMod_D51 = lme(Length_um ~ pCO2, random=~1|RFactor,
            data=data_51,
            method="REML")
pander(Anova(ShellLengthMod_D51), style='rmarkdown')
check_model(ShellLengthMod_D51) # observe the diagnostics of the model
shapiro.test(residuals(ShellLengthMod_D51)) # non normal
leveneTest(residuals(ShellLengthMod_D51) ~ data_51$pCO2)


# plot the data
Day51_Length_BoxPlot<-ggplot(data=data_51, aes(x=pCO2, y=Length_um, fill=pCO2)) +
   geom_boxplot()+scale_fill_manual(values=c("forestgreen","darkorange2"))+ 
  theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank())+ 
  #ggtitle("Age = 8 days")+
  scale_y_continuous(name ="Length (µm)")+
   scale_x_discrete(name ="pCO2 Treatment")
Day51_Length_BoxPlot

```



# Day 64 post-fertilization ( survival & length) 

```{r, Day 64 data}

# survival date
data_64<- survival_juvenile %>%
  filter(Age_DPF=="64")
data_64$Fed_Unfed <- as.factor(gsub("^(?:[^_]+_){2}([^_]+).*", "\\1", data_64$trt))
levels(data_64$Fed_Unfed) <- c("High food", "Low food")
data_64$pCO2 <-  as.factor(gsub("^(?:[^_]+_){1}([^_]+).*", "\\1", data_64$trt))
levels(data_64$pCO2) <- c("800 μatm", "500 μatm")
data_64 %>% dplyr::group_by(Fed_Unfed) %>% dplyr::summarise(mean = mean(Length))

data_64$RFactor <- as.factor(paste(data_64$Rep, data_64$pH, sep = '_'))

# length data 
data_64_length <- length %>%
  filter(Age_DPF=="64") %>%
  dplyr::mutate(pCO2 = case_when(pH == 8 ~ "500 μatm",  pH == 7.5 ~ "800 μatm")) %>% 
  dplyr::mutate(Fed_Unfed = case_when(Fed_Unfed == "fed" ~ "High food",  Fed_Unfed == "unfed" ~ "Low food"))

data_64_length$RFactor <- as.factor(paste(data_64_length$Replicate, data_64_length$pH, sep = '_'))


# ANOVA and diagnostics :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

# Length:::::::::::::::::::::::::::::::::::::::::::::::

# using lmer
ShellLengthMod_D64 <- lmer(Length_um ~ pCO2*Fed_Unfed + (1|RFactor),
                       data=data_64_length,
                       REML=TRUE)
pander(anova(ShellLengthMod_D64), style='rmarkdown') #  **Fed_Unfed**    | 1.198e-111 |
check_model(ShellLengthMod_D64) # observe the diagnosticsdata_64_length$pCO2 of the model
shapiro.test(residuals(ShellLengthMod_D64)) # non normal - 2.2e-16
leveneTest(residuals(ShellLengthMod_D64) ~ data_64_length$pCO2) # good  0.627

# using lme
ShellLengthMod_D64 = lme(Length_um ~ pCO2*Fed_Unfed, random=~1|RFactor,
            data=data_64_length,
            method="REML")
pander(Anova(ShellLengthMod_D64), style='rmarkdown') # **Fed_Unfed**    |  643.8  | 1  | 5.012e-142 |

# Survival:::::::::::::::::::::::::::::::::::::::::::::

# using lmer
SurvivalMod_D64 <- lmer(Survival ~ pCO2*Fed_Unfed + (1|RFactor),
                       data=data_64,
                       REML=TRUE)
pander(anova(SurvivalMod_D64), style='rmarkdown') #  no sig effects
check_model(ShellLengthMod_D64) # observe the diagnosticsdata_64_length$pCO2 of the model
shapiro.test(residuals(ShellLengthMod_D64)) # non normal - 2.2e-16
leveneTest(residuals(ShellLengthMod_D64) ~ data_64$pCO2) # good  0.627

# using lme
ShellLengthMod_D64 = lme(Survival ~ pCO2*Fed_Unfed, random=~1|RFactor,
            data=data_64,
            method="REML")
pander(Anova(ShellLengthMod_D64), style='rmarkdown') # **pCO2**      | 2.791  | 1  |  0.09481
check_model(ShellLengthMod_D64) # observe the diagnosticsdata_64_length$pCO2 of the model
shapiro.test(residuals(ShellLengthMod_D64)) # non normal - 0.002907
leveneTest(residuals(ShellLengthMod_D64) ~ data_64$pCO2) # good  0.07483 .



# plots ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

# survival
Day64_Survival_BoxPlot<-ggplot(data=data_64, aes(x=trt, y=Survival, fill=trt)) +
   geom_boxplot()+scale_fill_manual(values=c("orange1","darkorange2","springgreen2","forestgreen"))+ 
  theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank())+ 
  #ggtitle("Age = 8 days")+
  scale_y_continuous(name ="Length (µm)")+
   scale_x_discrete(name ="Treatment")
Day64_Survival_BoxPlot


# Shell size (length)
Day64_Length_BoxPlot<-ggplot(data=data_64_length, aes(x=pCO2, y=Length_um, fill=pCO2)) +
   geom_boxplot()+scale_fill_manual(values=c("darkorange2","forestgreen"))+ 
  theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank())+ 
  #ggtitle("Age = 8 days")+
  scale_y_continuous(name ="Length (µm)")+
   scale_x_discrete(name ="Treatment") + 
  facet_wrap(~Fed_Unfed)
Day64_Length_BoxPlot



data_64 %>% dplyr::group_by(pCO2) %>% dplyr::summarise(mean = mean(Survival))
data_64 %>% dplyr::group_by(Fed_Unfed) %>% dplyr::summarise(mean = mean(Survival), sd = sd(Survival))
data_64 %>% dplyr::group_by(trt) %>% dplyr::summarise(mean = mean(Survival))


Length_64dpf <- ggplot(data_64_length, aes(x =pCO2, Length_um,  fill = pCO2)) +
  theme(panel.grid=element_blank()) +
  geom_boxplot(size=0.2, alpha=0.1, aes(fill=pCO2)) +
  scale_fill_manual(values=c("grey50","white")) +
  geom_point(shape = 21, size = 1, position = position_jitterdodge(jitter.width = 0.4)) +
  theme_classic() +
  #ylim(2000, 4000) +
  scale_x_discrete(labels=c('~500 μatm', '~800 μatm')) +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold")) +
  stat_summary(fun.y=mean, geom="point", shape=18, size=4) +
  labs(title = "Shell Length; F1 Scallops (juveniles) 66 days post-fertilization", 
       y = expression(Shell~length~"("~μm~")"), 
       x = expression(italic(p)*CO[2]~Treatment~"("~μ*atm~")")) + 
  facet_wrap(~factor(Fed_Unfed, level = c('Low food', 'High food'))) 

Survival_64DPF <- ggplot(data_64, aes(x =pCO2, (Survival*100) , fill = pCO2)) +
  theme(panel.grid=element_blank()) +
  geom_boxplot(size=0.2, alpha=0.1, aes(fill=pCO2)) +
  scale_fill_manual(values=c("grey50","white")) +
  geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
  theme_classic() +
  #ylim(2, 4.5) +
  scale_x_discrete(labels=c('~500 μatm', '~800 μatm')) +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold")) +
  stat_summary(fun.y=mean, geom="point", shape=18, size=4) +
  labs(title = "Perent survival; F1 Scallops (juveniles) 64 days post-fertilization", 
       y = expression(Survival~"(%)"), 
       x = expression(italic(p)*CO[2]~Treatment~"("~μ*atm~")")) + 
  facet_wrap(~factor(Fed_Unfed, level = c('Low food', 'High food'))) 

# pdf(paste0("C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/Respiration/20210930_respiration.pdf"))
 pdf(paste0("C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/Survival_size/20210930_shell_length.pdf"))
# pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/Survival_size/20210930_shell_length.pdf"))
Length_64dpf
dev.off()


 pdf(paste0("C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/Survival_size/20210930_survival.pdf"))
# pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/Survival_size/20210930_survival.pdf"))
Survival_64DPF
dev.off()

```
# Day 90 Analysis and plotting 

```{r, Day 92 data}

# survival date
data_90<- survival_juvenile %>%
  filter(Age_DPF=="92")
data_90$Fed_Unfed <- as.factor(gsub("^(?:[^_]+_){2}([^_]+).*", "\\1", data_90$trt))
levels(data_90$Fed_Unfed) <- c("High food", "Low food")
data_90$pCO2 <-  as.factor(gsub("^(?:[^_]+_){1}([^_]+).*", "\\1", data_90$trt))
levels(data_90$pCO2) <- c("800 μatm", "500 μatm")
data_90 %>% dplyr::group_by(Fed_Unfed) %>% dplyr::summarise(mean = mean(Length))

data_90$RFactor <- as.factor(paste(data_90$Rep, data_90$pH, sep = '_'))

# length data
data_90_length <- length %>%
  filter(Age_DPF=="92") %>%
  dplyr::mutate(pCO2 = case_when(pH == 8 ~ "500 μatm",  pH == 7.5 ~ "800 μatm")) %>% 
  dplyr::mutate(Fed_Unfed = case_when(Fed_Unfed == "fed" ~ "High food",  Fed_Unfed == "unfed" ~ "Low food"))

data_90_length$RFactor <- as.factor(paste(data_90_length$Replicate, data_90_length$pH, sep = '_'))


# ANOVA and diagnostics :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

# Length:::::::::::::::::::::::::::::::::::::::::::::::

# using lmer
ShellLengthMod_D90 <- lmer(Length_um ~ pCO2*Fed_Unfed + (1|RFactor),
                       data=data_90_length,
                       REML=TRUE)
pander(anova(ShellLengthMod_D90), style='rmarkdown') # **Fed_Unfed**    | 2.036e-88 
check_model(ShellLengthMod_D90) # observe the diagnosticsdata_90_length$pCO2 of the model
shapiro.test(residuals(ShellLengthMod_D90)) # non normal 6.026e-15
leveneTest(residuals(ShellLengthMod_D90) ~ data_90_length$pCO2) # good 0.1583

# using lme
ShellLengthMod_D90 = lme(Length_um ~ pCO2*Fed_Unfed, random=~1|RFactor,
            data=data_90_length,
            method="REML")
pander(Anova(ShellLengthMod_D90), style='rmarkdown') # **Fed_Unfed**    |  579.3  | 1  | 5.206e-128 

# Survival:::::::::::::::::::::::::::::::::::::::::::::

# using lmer
SurvivalMod_D90 <- lmer(Survival ~ pCO2*Fed_Unfed + (1|RFactor),
                       data=data_90,
                       REML=TRUE)
pander(anova(SurvivalMod_D90), style='rmarkdown') #  **Fed_Unfed**    | 2.936e-09 |
# check_model(ShellLengthMod_D90) # observe the diagnostics data_90_length$pCO2 of the model
shapiro.test(residuals(ShellLengthMod_D90)) # non normal 6.026e-15
leveneTest(residuals(ShellLengthMod_D90) ~ data_90$pCO2) # good  0.627

# using lme
ShellLengthMod_D90 = lme(Survival ~ pCO2*Fed_Unfed, random=~1|RFactor,
            data=data_90,
            method="REML")
pander(Anova(ShellLengthMod_D90), style='rmarkdown') #  **Fed_Unfed**    |  236.3  | 1  | 2.526e-53  |
check_model(ShellLengthMod_D90) # observe the diagnosticsdata_90_length$pCO2 of the model
shapiro.test(residuals(ShellLengthMod_D90)) #  normal - 0.1661
leveneTest(residuals(ShellLengthMod_D90) ~ data_90$pCO2) # good  0.5736









Length_90dpf <- ggplot(data_90_length, aes(x =pCO2, Length_um,  fill = pCO2)) +
  theme(panel.grid=element_blank()) +
  geom_boxplot(size=0.2, alpha=0.1, aes(fill=pCO2)) +
  scale_fill_manual(values=c("grey50","white")) +
  geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
  theme_classic() +
  #ylim(2000, 4000) +
  scale_x_discrete(labels=c('~500 μatm', '~800 μatm')) +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold")) +
  stat_summary(fun.y=mean, geom="point", shape=18, size=4) +
  labs(title = "Shell Length; F1 Scallops (juveniles) 90 days post-fertilization", 
       y = expression(Shell~length~"("~μm~")"), 
       x = expression(italic(p)*CO[2]~Treatment~"("~μ*atm~")")) + 
  facet_wrap(~factor(Fed_Unfed, level = c('Low food', 'High food'))) 
Length_90dpf




Survival_90DPF <- ggplot(data_90, aes(x =pCO2, (Survival*100) , fill = pCO2)) +
  theme(panel.grid=element_blank()) +
  geom_boxplot(size=0.2, alpha=0.1, aes(fill=pCO2)) +
  scale_fill_manual(values=c("grey50","white")) +
  geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
  theme_classic() +
  #ylim(2, 4.5) +
  scale_x_discrete(labels=c('~500 μatm', '~800 μatm')) +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold")) +
  stat_summary(fun.y=mean, geom="point", shape=18, size=4) +
  labs(title = "Perent survival; F1 Scallops (juveniles) 90 days post-fertilization", 
       y = expression(Survival~"(%)"), 
       x = expression(italic(p)*CO[2]~Treatment~"("~μ*atm~")")) + 
  facet_wrap(~factor(Fed_Unfed, level = c('Low food', 'High food'))) 
Survival_90DPF



# pdf(paste0("C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/Respiration/20210930_respiration.pdf"))
# pdf(paste0("C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/Survival_size/20210930_shell_length.pdf"))
pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/Survival_size/20211026_shell_length.pdf"))
Length_90dpf
dev.off()


pdf(paste0("C:/Users/samuel.gurr/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/Survival_size/20211026_survival.pdf"))
# pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_OA/RAnalysis/Output/Survival_size/20210930_survival.pdf"))
Survival_90DPF
dev.off()

```