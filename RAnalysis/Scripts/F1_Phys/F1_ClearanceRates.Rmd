---
title: "ClearanceRates"
author: "Samuel Gurr"
date: "9/20/2022"
output: pdf_document
---

```{r setup, include=FALSE}
# Purpose: Bay Scallop Project - Feeding Rates
# analysis of respiration rate data

# Written by: Sam J Gurr (last edit 10/12/2021)

# Review Riisgard 2001 defining the clearance rate of bivalves 
# NOTE: clearance rate is defined as the volume of water cleared of suspended particles per unit time, and only equals filtration rate when 
# 100% of suspended particles are efficiently retained

# LOAD PACKAGES :::::::::::::::::::::::::::::::::::::::::::::::::::::::
#install.packages("pander")
library(dplyr)
library(ggplot2)
library(forcats)
library(lme4)
library(lmerTest)
library(see)
library(performance)
library(car)
library(reshape2)
library(lubridate)
library(SciViews)
library(reshape2)
library(SciViews)
library(kableExtra)
library(latex2exp)
library(pander)
library(performance)
library(ggpubr)
library(Rmisc)

# SET WORKING DIRECTORY :::::::::::::::::::::::::::::::::::::::::::::::

# setwd("C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis") # Work computer
#setwd("C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis") # personal computer
setwd("C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis") # personal computer

# LOAD DATA :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#Master_data       <- read.csv(file="Data/Clearance_rates/ClearanceRates_MasterData.csv", header=T) # master data file
Master_data <- read.csv(file="Data/Physiology/Clearance_rates/F1/cumulative_raw/ClearanceRates_master.csv", header=T,stringsAsFactors=FALSE, fileEncoding="latin1") # master data file


clearance.rate_914  <- Master_data  %>% dplyr::filter(Date %in% 20210914)  %>% 
                          dplyr::mutate(Chamber_tank = paste(pH, Replicate, sep='_'))

clearance.rate_930  <- Master_data  %>% dplyr::filter(Date %in% 20210930)  %>% 
                          dplyr::mutate(Chamber_tank = paste(pH, Replicate, sep='_'))

clearance.rate_1026 <- Master_data  %>% dplyr::filter(Date %in% 20211026)  %>% 
                          dplyr::mutate(Chamber_tank = paste(pH, Replicate, sep='_'))

clearance.rate_0202 <- Master_data  %>% dplyr::filter(Date %in% 20220202)  %>% 
                          dplyr::mutate(Chamber_tank = paste(pH, Replicate, sep='_'))

length.resp.feed <- read.csv(file="Data/Physiology/Respiration/Reference_resp_size.csv", header=T) %>% 
                      dplyr::mutate(Date = 
                                      paste("20",
                                            (format(as.Date(Date, "%m/%d/%Y"),"%y%m%d")), 
                                            sep ='')) %>%
                      dplyr::rename(Fed_Unfed = Food) 

length.resp.feed <- length.resp.feed[!is.na(length.resp.feed$Length_um),] %>%  
                      dplyr::select(c('Date', 
                                      'Run', 
                                      'Plate', 
                                      'pH', 
                                      'Fed_Unfed', 
                                      'Replicate',
                                      'Chamber_tank', 
                                      'Number', 
                                      'Length_um',
                                      'whole_Dry_weight'))

```

```{r, calc ratio ChatB : PLY429 for CR trials}

# initial value = the mean value we used to dose the containers with food
Av_Chaet_Tet_initial <- Master_data %>% 
  dplyr::filter(!quality %in% '*') %>% # poor quality data marked with * due to pseudofeces in occasional measurements 
  dplyr::filter(time %in% 0) %>%       # call the initial time point 
  dplyr::group_by(Date) %>% 
 # dplyr::group_by(Date) %>% 
  dplyr::summarise(
    
    meanChaetB = mean(Chaet_cell.ml),
    sdChaetB   = sd(Chaet_cell.ml), 
    
    meanPLY429 = mean(PLY_cell.ml), 
    sdPLY429   = sd(PLY_cell.ml), 
    
    n = n(),
    seChaetB   = (sdChaetB / (sqrt(n))),
    sePLY429   = (sdChaetB / (sqrt(n))),
    
    mean.Total_cellsmL = mean(Chaet_cell.ml + PLY_cell.ml),
    sdTotal    = sd(Chaet_cell.ml + PLY_cell.ml), 
    seTotal    = (sdTotal / (sqrt(n))),

    meanRatio_Ply429.ChaetB = mean(Chaet_cell.ml/PLY_cell.ml)
  )
Av_Chaet_Tet_initial

```

## Merge to master file 'ClearanceRate_Master'

Date from: 
- 20210914
- 20210930 
- 20211026
- 20220202

```{r merge master file, echo = TRUE}

# 20210914 DATA :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# formatting for merge
# call the 20210914 data and remove blanks
clearance.rate_914_Scallops <- merge( # note - merging with th elengths removed the blanks from the clearance rate data (no lengths for them! )
  (clearance.rate_914),
  (length.resp.feed %>% 
     dplyr::filter(Date %in% 20210914) %>% dplyr::mutate(Fed_Unfed = 'fed')) ) # only fed animals - this was day 0 prior to the fed unfed trial run

# 20210930 DATA :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# formatting for merge - ONLY 'fed' chosen here, unfed reserved for other manuscript
# call the 20210930 data and remove blanks
clearance.rate_930_Scallops <- merge( # note - merging with th elengths removed the blanks from the clearance rate data (no lengths for them! )
  (clearance.rate_930),
  (length.resp.feed %>% 
     dplyr::filter(Date %in% 20210930 & Fed_Unfed %in% 'fed')) ) 

# 20210930 DATA :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# formatting for merge - ONLY 'fed' chosen here, unfed reserved for other manuscript
# call the 20210930 data and remove blanks
clearance.rate_1026_Scallops <- merge( # note - merging with th elengths removed the blanks from the clearance rate data (no lengths for them! )
  (clearance.rate_1026),
  (length.resp.feed %>% 
     dplyr::filter(Date %in% 20211026 & Fed_Unfed %in% 'fed')) ) 

# 20220202 DATA :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# formatting for merge - only 'fed' data as this occured far after the food x OA trial
# call the 20210930 data and remove blanks

clearance.rate_0202_Scallops <- merge( # note - merging with th elengths removed the blanks from the clearance rate data (no lengths for them! )
  (clearance.rate_0202),
  (length.resp.feed %>% 
     dplyr::filter(Date %in% 20220202) %>% 
     dplyr::select(c('Chamber_tank', 'Replicate', 'Number', 'Run', 'Length_um', 'whole_Dry_weight'))),
  by = c('Chamber_tank', 'Replicate', 'Number', 'Run'))


ClearanceRate_Master             <- rbind(clearance.rate_914_Scallops, clearance.rate_930_Scallops, clearance.rate_1026_Scallops, clearance.rate_0202_Scallops)
# ClearanceRate_Master$tet.ply     <- (as.numeric(gsub(",", "", ClearanceRate_Master$tet.ply )))*(1000/33)
# ClearanceRate_Master$chaet       <- (as.numeric(gsub(",", "", ClearanceRate_Master$chaet )))*(1000/33)
# ClearanceRate_Master$total_algae <- (as.numeric(gsub(",", "", ClearanceRate_Master$total_algae )))*(1000/33)
# ClearanceRate_Master$seston      <- (as.numeric(gsub(",", "", ClearanceRate_Master$seston )))*(1000/33)

print(head(ClearanceRate_Master))
```



``` {r loops and  for statements - visualization of slope and calculation of CR, echo = TRUE}
# Day 0 20210914 
ClearanceRate_Master.914 <- ClearanceRate_Master %>% 
  dplyr::filter(Date %in% 20210914) %>% 
  dplyr::mutate(uniq_Identifier = paste(pH, "Run", Run, "Rep",Replicate, "Num", Number, sep='_'))

loop_914 <- as.data.frame(unique(ClearanceRate_Master.914$uniq_Identifier)) %>% dplyr::rename(ID = "unique(ClearanceRate_Master.914$uniq_Identifier)")

# 64 DPF 20210930 
ClearanceRate_Master.930       <- ClearanceRate_Master %>% 
  dplyr::filter(Date %in% 20210930) %>% 
  dplyr::mutate(uniq_Identifier = paste(pH, Fed_Unfed, "Run", Run, "Rep",Replicate, "Num", Number, sep='_'))

loop_930 <- as.data.frame(unique(ClearanceRate_Master.930$uniq_Identifier)) %>% dplyr::rename(ID = "unique(ClearanceRate_Master.930$uniq_Identifier)")

# 92 DPF 20211026
ClearanceRate_Master.1026       <- ClearanceRate_Master %>% 
  dplyr::filter(Date %in% 20211026) %>% 
  dplyr::mutate(Run = case_when(Run == "1_B" ~ "1B", Run == "1" ~ "1", Run =='2' ~ '2', Run == '3' ~ '3')) %>% 
  dplyr::mutate(uniq_Identifier = paste(pH, Fed_Unfed, "Run", Run, "Rep",Replicate, "Num", Number, sep='_'))

loop_1026 <- as.data.frame(unique(ClearanceRate_Master.1026$uniq_Identifier)) %>% dplyr::rename(ID = "unique(ClearanceRate_Master.1026$uniq_Identifier)")


# months DPF 20220202
ClearanceRate_Master.0202       <- ClearanceRate_Master %>% 
  dplyr::filter(Date %in% 20220202) %>% 
  dplyr::mutate(uniq_Identifier = paste(pH, "Run", Run, "Rep",Replicate, "Num", Number, sep='_'))

loop_0202 <- as.data.frame(unique(ClearanceRate_Master.0202$uniq_Identifier)) %>% dplyr::rename(ID = "unique(ClearanceRate_Master.0202$uniq_Identifier)")


```



# Visualize raw data & simple slopes/algae loss time-1
## Plot the raw Flow cytometry output

- note: some data points were omitted in the worksheet, review the 'raw' vs 'worksheet_R' data files

``` {r raw data plots, echo = TRUE}

# :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# 20210914 DATA :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::


# SlopePlots_914 <- ClearanceRate_Master[!is.na(ClearanceRate_Master$total_algae),] %>% 
SlopePlots_914_chaet <- ClearanceRate_Master[!is.na(ClearanceRate_Master$Chaet_cell.ml),] %>% 
  dplyr::filter(!Replicate %in% 'blank') %>%
  dplyr::filter(Date %in% "20210914") %>% 
  dplyr::mutate(Time._min = as.numeric(as.character(time))) %>% 
  ggplot(aes(Time._min, Chaet_cell.ml, color=Replicate)) + 
  geom_point(shape=1, color = "black")+ 
  ggtitle("RAW DATA - Chaetoceros: F1s Feeding Rate 20210914")+
  labs(y = expression(Live~algae~cells~"("~cells~mL^{-1}~")"), 
       x = expression(Time~"("~minutes~")")) + 
  theme(plot.title= element_text(size =16, face ="bold", 
                                 lineheight = 8, vjust=1), aspect.ratio=1)+
  stat_smooth(method="lm", se = F) + 
  theme_bw() +
  scale_shape_identity() + 
  facet_wrap( ~ pH, scales = "free_x" )
SlopePlots_914_chaet


SlopePlots_914_ply <- ClearanceRate_Master[!is.na(ClearanceRate_Master$PLY_cell.ml),] %>% 
  dplyr::filter(!Replicate %in% 'blank') %>%
  dplyr::filter(Date %in% "20210914") %>% 
  dplyr::mutate(Time._min = as.numeric(as.character(time))) %>% 
  ggplot(aes(time, PLY_cell.ml, color=Replicate)) + 
  geom_point(shape=1, color = "black")+ 
  ggtitle("RAW DATA - PLY: F1s Feeding Rate 20210914")+
  labs(y = expression(Live~algae~cells~"("~cells~mL^{-1}~")"), 
       x = expression(Time~"("~minutes~")")) + 
  theme(plot.title= element_text(size =16, face ="bold", 
                                 lineheight = 8, vjust=1), aspect.ratio=1)+
  stat_smooth(method="lm", se = F) + 
  theme_bw() +
  scale_shape_identity() + 
  facet_wrap( ~ pH, scales = "free_x" )
SlopePlots_914_ply


SlopePlots_914_lowchla <- ClearanceRate_Master[!is.na(ClearanceRate_Master$Low_chlorophyll_cell.ml),] %>% 
  dplyr::filter(!Replicate %in% 'blank') %>%
  dplyr::filter(Date %in% "20210914") %>% 
  dplyr::mutate(Time._min = as.numeric(as.character(time))) %>% 
  ggplot(aes(time, Low_chlorophyll_cell.ml, color=Replicate)) + 
  geom_point(shape=1, color = "black")+ 
  ggtitle("RAW DATA - Low chl a (seston): F1s Feeding Rate 20210914")+
  labs(y = expression(Live~algae~cells~"("~cells~mL^{-1}~")"), 
       x = expression(Time~"("~minutes~")")) + 
  theme(plot.title= element_text(size =16, face ="bold", 
                                 lineheight = 8, vjust=1), aspect.ratio=1)+
  stat_smooth(method="lm", se = F) + 
  theme_bw() +
  scale_shape_identity() + 
  facet_wrap( ~ pH, scales = "free_x" )
SlopePlots_914_lowchla

ggarrange(SlopePlots_914_chaet, SlopePlots_914_ply, SlopePlots_914_lowchla)





# Table of slope data

SlopeTable_914 <- data.frame() # run this before the loop
for(i in 1:nrow(loop_914)){
  dat <- ClearanceRate_Master.914 %>%  filter(uniq_Identifier %in% loop_914[i,])
    slope  <- summary(lm((dat$Chaet_cell.ml) ~ as.numeric(dat$time)))$coef[2,"Estimate"]
    SLOPE  <- summary(lm((dat$Chaet_cell.ml) ~ as.numeric(dat$time)))$r.squared
    pval   <- summary(lm((dat$Chaet_cell.ml) ~ as.numeric(dat$time)))$coef[2,"Pr(>|t|)"]
    mod    <- lm(as.numeric(dat$time) ~ dat$Chaet_cell.ml)
    norm_assum <- shapiro.test(resid(mod))
    shapiro_pval <- norm_assum$p.value
    # assign the data table 
    SLOPE.loop <- data.frame(matrix(nrow = 1, ncol = 5)) # create a new data table
    colnames(SLOPE.loop) <- c('pH', 'Replicate', 'slope', 'SLOPE', 'pval') # assign headers
    SLOPE.loop$pH        <- gsub("_.*", "\\1", loop_914[i,])
    SLOPE.loop$Replicate <- gsub("^(?:[^_]+_){4}([^_]+).*", "\\1", loop_914[i,])
    SLOPE.loop$slope     <- slope * 60  # cells per mL per hour  
    SLOPE.loop$Number    <- gsub("^(?:[^_]+_){6}([^_]+).*", "\\1", loop_914[i,])
    SLOPE.loop$SLOPE     <- SLOPE
    SLOPE.loop$pval      <- pval
    SLOPE.loop$shapiro_pval <- shapiro_pval
    # loop additions 
    df <- data.frame(SLOPE.loop) # name dataframe for this single row
    SlopeTable_914 <- rbind(SlopeTable_914,df) # bind to a cumulative list dataframe
   # print(SlopeTable_914) # show loop progress in the console
}# outside loo

SLOPE_mod_914 <- aov(lm(slope ~ pH, data= SlopeTable_914))
DF   <- paste( (summary(SLOPE_mod_914)[[1]][["Df"]])[1], (summary(SLOPE_mod_914)[[1]][["Df"]])[2], sep = '/')
Fval <- (summary(SLOPE_mod_914)[[1]][["F value"]])[1]
pval <- (summary(SLOPE_mod_914)[[1]][["Pr(>F)"]])[1]

SlopeFig914_geombox <- ggplot(SlopeTable_914, aes(pH , abs(slope) , fill = pH)) +
  theme(panel.grid=element_blank()) +
  geom_boxplot(size=0.2, alpha=0.1, aes(fill=pH)) +
  scale_fill_manual(values=c("grey50","white")) +
  geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
  theme_classic() +
  scale_x_discrete(labels= c('Elevated (H)', 'Ambient (L)')) +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold")) +
  labs(title = "F1 Scallops: Slope algae cells/time - feeding rate trials 20210914", 
       y = expression(Slope~"="~absolute~value~"("~Live~algae~cells~mL^{-1}~hour^{-1}~")"), 
       x = expression(italic(p)*CO[2]~Treatment~"("~mu*atm~")")) + 
  annotate("text", x=2, y= 25000, size = 4, label = "aov(slope~pH Treatment)") +
  annotate("text", x=2, y= 24300, size = 4, label= paste('DF =',DF,'F =', signif(Fval, digits=3), 'p value =', signif(pval, digits=3), sep=" ")) 

SlopeFig914_geombox # 0.0531




















# :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# 20210930 DATA :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

# NOTE: this is during the fed x unfed trial - only taking the 'fed' animals

SlopePlots_930_chaet <- ClearanceRate_Master[!is.na(ClearanceRate_Master$Chaet_cell.ml),] %>% 
  dplyr::filter(!Replicate %in% 'blank') %>%
  dplyr::filter(Date %in% "20210930") %>% 
  dplyr::filter(Fed_Unfed %in% 'fed') %>% 
  dplyr::mutate(Time._min = as.numeric(as.character(time))) %>% 
  ggplot(aes(Time._min, Chaet_cell.ml, color=Replicate)) + 
  geom_point(shape=1, color = "black")+ 
  ggtitle("RAW DATA - Chaetoceros: F1s Feeding Rate 20210930")+
  labs(y = expression(Live~algae~cells~"("~cells~mL^{-1}~")"), 
       x = expression(Time~"("~minutes~")")) + 
  theme(plot.title= element_text(size =16, face ="bold", 
                                 lineheight = 8, vjust=1), aspect.ratio=1)+
  stat_smooth(method="lm", se = F) + 
  theme_bw() +
  scale_shape_identity() + 
  facet_wrap( ~ pH, scales = "free_x" )
SlopePlots_930_chaet


SlopePlots_930_ply <- ClearanceRate_Master[!is.na(ClearanceRate_Master$PLY_cell.ml),] %>% 
  dplyr::filter(!Replicate %in% 'blank') %>%
  dplyr::filter(Date %in% "20210930") %>% 
  dplyr::filter(Fed_Unfed %in% 'fed') %>% 
  dplyr::mutate(Time._min = as.numeric(as.character(time))) %>% 
  ggplot(aes(time, PLY_cell.ml, color=Replicate)) + 
  geom_point(shape=1, color = "black")+ 
  ggtitle("RAW DATA - PLY: F1s Feeding Rate 20210930")+
  labs(y = expression(Live~algae~cells~"("~cells~mL^{-1}~")"), 
       x = expression(Time~"("~minutes~")")) + 
  theme(plot.title= element_text(size =16, face ="bold", 
                                 lineheight = 8, vjust=1), aspect.ratio=1)+
  stat_smooth(method="lm", se = F) + 
  theme_bw() +
  scale_shape_identity() + 
  facet_wrap( ~ pH, scales = "free_x" )
SlopePlots_930_ply


SlopePlots_930_lowchla <- ClearanceRate_Master[!is.na(ClearanceRate_Master$Low_chlorophyll_cell.ml),] %>% 
  dplyr::filter(!Replicate %in% 'blank') %>%
  dplyr::filter(Date %in% "20210930") %>% 
  dplyr::filter(Fed_Unfed %in% 'fed') %>% 
  dplyr::mutate(Time._min = as.numeric(as.character(time))) %>% 
  ggplot(aes(time, Low_chlorophyll_cell.ml, color=Replicate)) + 
  geom_point(shape=1, color = "black")+ 
  ggtitle("RAW DATA - Low chl a (seston): F1s Feeding Rate 20210930")+
  labs(y = expression(Live~algae~cells~"("~cells~mL^{-1}~")"), 
       x = expression(Time~"("~minutes~")")) + 
  theme(plot.title= element_text(size =16, face ="bold", 
                                 lineheight = 8, vjust=1), aspect.ratio=1)+
  stat_smooth(method="lm", se = F) + 
  theme_bw() +
  scale_shape_identity() + 
  facet_wrap( ~ pH, scales = "free_x" )
SlopePlots_930_lowchla

ggarrange(SlopePlots_930_chaet, SlopePlots_930_ply, SlopePlots_930_lowchla)






# :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# 20211026 DATA :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

# NOTE: this is during the fed x unfed trial - only taking the 'fed' animals


SlopePlots_1026_chaet <- ClearanceRate_Master[!is.na(ClearanceRate_Master$Chaet_cell.ml),] %>% 
  dplyr::filter(!Replicate %in% 'blank') %>%
  dplyr::filter(Date %in% "20211026") %>% 
  dplyr::filter(Fed_Unfed %in% 'fed') %>% 
  dplyr::mutate(Time._min = as.numeric(as.character(time))) %>% 
  ggplot(aes(Time._min, Chaet_cell.ml, color=Replicate)) + 
  geom_point(shape=1, color = "black")+ 
  ggtitle("RAW DATA - Chaetoceros: F1s Feeding Rate 20211026")+
  labs(y = expression(Live~algae~cells~"("~cells~mL^{-1}~")"), 
       x = expression(Time~"("~minutes~")")) + 
  theme(plot.title= element_text(size =16, face ="bold", 
                                 lineheight = 8, vjust=1), aspect.ratio=1)+
  stat_smooth(method="lm", se = F) + 
  theme_bw() +
  scale_shape_identity() + 
  facet_wrap( ~ pH, scales = "free_x" )
SlopePlots_1026_chaet


SlopePlots_1026_ply <- ClearanceRate_Master[!is.na(ClearanceRate_Master$PLY_cell.ml),] %>% 
  dplyr::filter(!Replicate %in% 'blank') %>%
  dplyr::filter(Date %in% "20211026") %>% 
  dplyr::filter(Fed_Unfed %in% 'fed') %>% 
  dplyr::mutate(Time._min = as.numeric(as.character(time))) %>% 
  ggplot(aes(time, PLY_cell.ml, color=Replicate)) + 
  geom_point(shape=1, color = "black")+ 
  ggtitle("RAW DATA - PLY: F1s Feeding Rate 20211026")+
  labs(y = expression(Live~algae~cells~"("~cells~mL^{-1}~")"), 
       x = expression(Time~"("~minutes~")")) + 
  theme(plot.title= element_text(size =16, face ="bold", 
                                 lineheight = 8, vjust=1), aspect.ratio=1)+
  stat_smooth(method="lm", se = F) + 
  theme_bw() +
  scale_shape_identity() + 
  facet_wrap( ~ pH, scales = "free_x" )
SlopePlots_1026_ply


SlopePlots_1026_lowchla <- ClearanceRate_Master[!is.na(ClearanceRate_Master$Low_chlorophyll_cell.ml),] %>% 
  dplyr::filter(!Replicate %in% 'blank') %>%
  dplyr::filter(Date %in% "20211026") %>% 
  dplyr::filter(Fed_Unfed %in% 'fed') %>% 
  dplyr::mutate(Time._min = as.numeric(as.character(time))) %>% 
  ggplot(aes(time, Low_chlorophyll_cell.ml, color=Replicate)) + 
  geom_point(shape=1, color = "black")+ 
  ggtitle("RAW DATA - Low chl a (seston): F1s Feeding Rate 20211026")+
  labs(y = expression(Live~algae~cells~"("~cells~mL^{-1}~")"), 
       x = expression(Time~"("~minutes~")")) + 
  theme(plot.title= element_text(size =16, face ="bold", 
                                 lineheight = 8, vjust=1), aspect.ratio=1)+
  stat_smooth(method="lm", se = F) + 
  theme_bw() +
  scale_shape_identity() + 
  facet_wrap( ~ pH, scales = "free_x" )
SlopePlots_1026_lowchla

ggarrange(SlopePlots_1026_chaet, SlopePlots_1026_ply, SlopePlots_1026_lowchla, ncol = 1, nrow = 3)






# :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# 20211026 DATA :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

# NOTE: this is during the fed x unfed trial - only taking the 'fed' animals


SlopePlots_0202_chaet <- ClearanceRate_Master[!is.na(ClearanceRate_Master$Chaet_cell.ml),] %>% 
  dplyr::filter(!Replicate %in% 'blank') %>%
  dplyr::filter(Date %in% "20220202") %>% 
  dplyr::mutate(Time._min = as.numeric(as.character(time))) %>% 
  ggplot(aes(Time._min, Chaet_cell.ml, color=Replicate)) + 
  geom_point(shape=1, color = "black")+ 
  ggtitle("RAW DATA - Chaetoceros: F1s Feeding Rate 20220202")+
  labs(y = expression(Live~algae~cells~"("~cells~mL^{-1}~")"), 
       x = expression(Time~"("~minutes~")")) + 
  theme(plot.title= element_text(size =16, face ="bold", 
                                 lineheight = 8, vjust=1), aspect.ratio=1)+
  stat_smooth(method="lm", se = F) + 
  theme_bw() +
  scale_shape_identity() + 
  facet_wrap( ~ pH, scales = "free_x" )
SlopePlots_0202_chaet


SlopePlots_0202_ply <- ClearanceRate_Master[!is.na(ClearanceRate_Master$PLY_cell.ml),] %>% 
  dplyr::filter(!Replicate %in% 'blank') %>%
  dplyr::filter(Date %in% "20220202") %>% 
  dplyr::mutate(Time._min = as.numeric(as.character(time))) %>% 
  ggplot(aes(time, PLY_cell.ml, color=Replicate)) + 
  geom_point(shape=1, color = "black")+ 
  ggtitle("RAW DATA - PLY: F1s Feeding Rate 20220202")+
  labs(y = expression(Live~algae~cells~"("~cells~mL^{-1}~")"), 
       x = expression(Time~"("~minutes~")")) + 
  theme(plot.title= element_text(size =16, face ="bold", 
                                 lineheight = 8, vjust=1), aspect.ratio=1)+
  stat_smooth(method="lm", se = F) + 
  theme_bw() +
  scale_shape_identity() + 
  facet_wrap( ~ pH, scales = "free_x" )
SlopePlots_0202_ply


SlopePlots_0202_lowchla <- ClearanceRate_Master[!is.na(ClearanceRate_Master$Low_chlorophyll_cell.ml),] %>% 
  dplyr::filter(!Replicate %in% 'blank') %>%
  dplyr::filter(Date %in% "20220202") %>% 
  dplyr::mutate(Time._min = as.numeric(as.character(time))) %>% 
  ggplot(aes(time, Low_chlorophyll_cell.ml, color=Replicate)) + 
  geom_point(shape=1, color = "black")+ 
  ggtitle("RAW DATA - Low chl a (seston): F1s Feeding Rate 20220202")+
  labs(y = expression(Live~algae~cells~"("~cells~mL^{-1}~")"), 
       x = expression(Time~"("~minutes~")")) + 
  theme(plot.title= element_text(size =16, face ="bold", 
                                 lineheight = 8, vjust=1), aspect.ratio=1)+
  stat_smooth(method="lm", se = F) + 
  theme_bw() +
  scale_shape_identity() + 
  facet_wrap( ~ pH, scales = "free_x" )
SlopePlots_0202_lowchla

ggarrange(SlopePlots_0202_chaet, SlopePlots_0202_ply, SlopePlots_0202_lowchla, ncol = 1, nrow = 3)





# Save plots :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/20210914_figs_tables/20210914_FlowCytometry_rawdata.pdf"))
ggarrange(SlopePlots_914_chaet, SlopePlots_914_ply, SlopePlots_914_lowchla, ncol = 1, nrow = 3)
dev.off()

pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/20210930_figs_tables/20210930_FlowCytometry_rawdata.pdf"), height = 12)
ggarrange(SlopePlots_930_chaet, SlopePlots_930_ply, SlopePlots_930_lowchla, ncol = 1, nrow = 3)
dev.off()

pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/20211026_figs_tables/20211026_FlowCytometry_rawdata.pdf"), height = 12)
ggarrange(SlopePlots_1026_chaet, SlopePlots_1026_ply, SlopePlots_1026_lowchla, ncol = 1, nrow = 3)
dev.off()

pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/20220202_figs_tables/20220202_FlowCytometry_rawdata.pdf"), height = 12)
ggarrange(SlopePlots_0202_chaet, SlopePlots_0202_ply, SlopePlots_0202_lowchla, ncol = 1, nrow = 3)
dev.off()
```



## Calculate the blank Clearance rate values for each trial

### CLEARANCE RATE EQUATION

**CR =  CR = V * (ln(C0/Ct)/t - A)**

- **V** == the volume of the vessel
- **t** == time of the trial interval (i.e. 60 minutes or 1 hour)
- **ln(C_0/C_t)** == ratio of the live algae concentration (cells ml-1) at time 0 (C0) and at the elapsed time interval(s) (Ct) - take the natural log of this ratio
- **A** == V * (ln(Blank_0/Blank_t)/t) for the 'blank' values in each treatment, accounts for the sink or stuck algae cells 
- **L** == normalization factor between individuals - here we will use the shell length in mm




```{r Calculate BLANKS and write csv, echo = FALSE}

# **A** == V * (ln(Blank_0/Blank_t)/t) for the 'blank' values in each treatment, accounts for the sink or stuck algae cells 

Blanks.Master <- Master_data[is.na(Master_data$Replicate),] %>% 
                                dplyr::mutate(unique_identifier = 
                                                paste(Date, pH, "Run", Run, raw_ID_sample_number, sep ='_'))

loop_BLANKS       <- as.data.frame(unique(Blanks.Master$unique_identifier)) %>%
                            dplyr::rename(ID = "unique(Blanks.Master$unique_identifier)") # call unique identifier tfor the for loop calc of blanks 

meanBLANKS.Master       <- data.frame() 
for (i in 1:nrow(loop_BLANKS)) { # for each unique identifier....
  
  # data loop
  dat <- Blanks.Master %>% 
          dplyr::filter(unique_identifier == loop_BLANKS[i,]) %>% # subset the data out for that ID
          dplyr::arrange(time) # arrange from time 0 to the last recorded time )this is important for the next part of this loop!
    
    # note that in some cases t_init and t_end are not the max and minimum values, respectively - this can alse call bad values due to error or pseudofeces!
    
    #  C0 = concentration at T initial
    #  t_init below (C0), I call a conditional statement based on the first two values 
    #  if the max value of timepoints 0 and 1 is  < than 1.25 * the minimum values ( > than assumed as exaggerated by pseudofeces) - call the MAX - else call the MIN
    
    # parameters
    t_end      <- nrow(dat)
    t_end_min <- nrow(dat) - 3

    # ply
    C0_Ply         <- if ( (max(c(dat[1,]$PLY_cell.ml, dat[2,]$PLY_cell.ml))) < (1.25*  (min(c(dat[1,]$PLY_cell.ml, dat[2,]$PLY_cell.ml)))) )  { 
                           C0_Ply <-  (max(c(dat[1,]$PLY_cell.ml, dat[2,]$PLY_cell.ml))) 
                           } else (C0_Ply <-  (min(c(dat[1,]$PLY_cell.ml, dat[2,]$PLY_cell.ml)))) # C0 for the ply 
    
    t0_Ply         <- min(dat$time[dat$PLY_cell.ml==C0_Ply])
    
    
    if (  min(dat$PLY_cell.ml[c(t_end_min:t_end)])  <   C0_Ply) { # if the minmum value of the last three timepoints is less than the concentration at time 0....
                          Cend_Ply <- min(dat$PLY_cell.ml[c(t_end_min:t_end)])  # call this value 
                          } else (Cend_Ply <- min(dat$PLY_cell.ml[t_end])) # ...else just call the last value - it will result in a negative ln() and be ommitted after the loop (below)
    
    
    tot.time_Ply   <- max(dat$time[dat$PLY_cell.ml==Cend_Ply]) - t0_Ply

    
    # chaet
    C0_Chaet        <- if ( (max(c(dat[1,]$Chaet_cell.ml, dat[2,]$Chaet_cell.ml))) < (1.25*  (min(c(dat[1,]$Chaet_cell.ml, dat[2,]$Chaet_cell.ml)))) )  { 
                           C0_Chaet <-  (max(c(dat[1,]$Chaet_cell.ml, dat[2,]$Chaet_cell.ml))) 
                           } else (C0_Chaet <-  (min(c(dat[1,]$Chaet_cell.ml, dat[2,]$Chaet_cell.ml)))) 
    
    t0_Chaet        <- min(dat$time[dat$Chaet_cell.ml==C0_Chaet])
    
    if (  min(dat$Chaet_cell.ml[c(t_end_min:t_end)])  <   C0_Ply) { # if the minmum value of the last three timepoints is less than the concentration at time 0....
                          Cend_Chaet <- min(dat$Chaet_cell.ml[c(t_end_min:t_end)])  # call this value 
                          } else (Cend_Chaet <- min(dat$Chaet_cell.ml[t_end])) # ...else just call the last value - it will result in a negative ln() and be ommitted after the loop (below)
    
    tot.time_Chaet  <- max(dat$time[dat$Chaet_cell.ml==Cend_Chaet]) - t0_Chaet
    
    
    # low chl a (seston)
    C0_seston <- if ( (max(c(dat[1,]$Low_chlorophyll_cell.ml, dat[2,]$Low_chlorophyll_cell.ml))) < (1.25*  (min(c(dat[1,]$Low_chlorophyll_cell.ml, dat[2,]$Low_chlorophyll_cell.ml)))) )  { 
                     C0_seston <-  (max(c(dat[1,]$Low_chlorophyll_cell.ml, dat[2,]$Low_chlorophyll_cell.ml))) 
                     } else (C0_seston <-  (min(c(dat[1,]$Low_chlorophyll_cell.ml, dat[2,]$Low_chlorophyll_cell.ml))))  
    t0_seston       <- min(dat$time[dat$Low_chlorophyll_cell.ml==C0_seston])
    
    if (  min(dat$Low_chlorophyll_cell.ml[c(t_end_min:t_end)])  <   C0_Ply) { # if the minmum value of the last three timepoints is less than the concentration at time 0....
                          Cend_seston <- min(dat$Low_chlorophyll_cell.ml[c(t_end_min:t_end)])  # call this value 
                          } else (Cend_seston <- min(dat$Low_chlorophyll_cell.ml[t_end])) # ...else just call the last value - it will result in a negative ln() and be ommitted after the loop (below)
    
    tot.time_seston <- max(dat$time[dat$Low_chlorophyll_cell.ml==Cend_seston]) - t0_seston
    
    # natural log (ln) of the start and end ratio
    Blank_dat <- dat[1,] %>%  
        dplyr::select(c('Date','pH','Fed_Unfed','Run')) %>% 
        dplyr::mutate(CR.Blank_Chaet  = (ln(C0_Chaet / Cend_Chaet) / (tot.time_Chaet/60) ) ) %>%  # calc the ration of algae lost to the time 0 number 
        dplyr::mutate(CR.Blank_Ply    = (ln(C0_Ply / Cend_Ply) / (tot.time_Ply/60) ) ) %>%  # calc the ration of algae lost to the time 0 number 
        dplyr::mutate(CR.Blank_Seston = (ln(C0_seston / Cend_seston)/ (tot.time_seston/60) ) ) # calc the ration of algae lost to the time 0 number 
   
    df                <- data.frame(Blank_dat) # name dataframe for this single row
    meanBLANKS.Master <- rbind(meanBLANKS.Master,df) #bind to a cumulative list dataframe
 } 

meanBLANKS.Chaet <- data.frame(meanBLANKS.Master) %>% 
                      dplyr::group_by(Date, pH) %>% 
                      mutate(CR.Blank_Chaet = if_else(CR.Blank_Chaet < 0, 0, CR.Blank_Chaet)) %>% # make all negative values 0 
                      dplyr::summarise(
                       meanBlank  = mean(CR.Blank_Chaet),
                       sdBlank    = sd(CR.Blank_Chaet),
                       n = n()) %>% 
                       dplyr::mutate(Type = 'Chaet') %>% 
                       dplyr::mutate(Date_pH = paste(Date, pH, sep = '_'))

meanBLANKS.Ply   <- data.frame(meanBLANKS.Master) %>% 
                          dplyr::group_by(Date, pH) %>% 
                          mutate(CR.Blank_Ply = if_else(CR.Blank_Ply < 0, 0, CR.Blank_Ply)) %>% # make all negative values 0 
                          dplyr::summarise(
                           meanBlank  = mean(CR.Blank_Ply),
                           sdBlank    = sd(CR.Blank_Ply),
                           n= n()) %>% 
                          dplyr::mutate(Type = 'Ply') %>% 
                          dplyr::mutate(Date_pH = paste(Date, pH, sep = '_'))
                                      
meanBLANKS.Seson <- data.frame(meanBLANKS.Master) %>% 
                        dplyr::group_by(Date, pH) %>% 
                        mutate(CR.Blank_Seston = if_else(CR.Blank_Seston < 0, 0, CR.Blank_Seston)) %>% # make all negative values 0 
                        dplyr::summarise(
                         meanBlank  = mean(CR.Blank_Seston),
                         sdBlank    = sd(CR.Blank_Seston),
                         n= n()) %>% 
                        dplyr::mutate(Type = 'Seston') %>% 
                        dplyr::mutate(Date_pH = paste(Date, pH, sep = '_'))

meanBLANKS.Summary <- rbind(meanBLANKS.Chaet, meanBLANKS.Ply, meanBLANKS.Seson)


write.csv(meanBLANKS.Summary, "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/Blanks_Master.csv")

```

# Calculate Clearance Rate 

### Note: the following clusters calculate CR for the start/end Algae counts (i.e. 20210914 time 0 and time 90 minutes; 20210930 time 0 and time 60 minutes)


### CLEARANCE RATE EQUATION

**CR =  CR = V * (ln(C0/Ct)/t - A)**

- **V** == the volume of the vessel
- **t** == time of the trial interval (i.e. 60 minutes or 1 hour)
- **ln(C_0/C_t)** == ratio of the live algae concentration (cells ml-1) at time 0 (C0) and at the elapsed time interval(s) (Ct) - take the natural log of this ratio
- **A** == V * (ln(Blank_0/Blank_t)/t) for the 'blank' values in each treatment, accounts for the sink or stuck algae cells 
- **L** == normalization factor between individuals - here we will use the shell length in mm



## 20210914 Clearance Rate data 

```{r 20210914 CR, echo = T}

# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Clearance Rate for loop     ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
meanLength   <- mean(ClearanceRate_Master$Length_um/1000)    # 6.155029 mm
medianLength <- median(ClearanceRate_Master$Length_um/1000)  # 3.82627 mm
bLength      <- 2.18 # review the outlier-omitted b factor plot in previous chunk

V = 25 # V == Volume of the vessel (in mL as 25 ml)

df_total.914<- data.frame() # start dataframe 
for (i in 1:nrow(loop_914)) {
  dat <- ClearanceRate_Master.914 %>% 
    dplyr::filter(uniq_Identifier == loop_914[i,]) %>% 
    dplyr::mutate(Date_pH = paste(Date, pH, sep = '_')) %>% 
    dplyr::arrange(time)
  
  t_end      <- nrow(dat)
  t_end_min1 <- nrow(dat) - 1
  
  blanks <- meanBLANKS.Summary %>% dplyr::filter(Date_pH %in% dat$Date_pH[1])
  
  # ply
  A.ply               <- blanks$meanBlank[blanks$Type == 'Ply']
  C0_Ply              <- if ( (max(c(dat[1,]$PLY_cell.ml, dat[2,]$PLY_cell.ml))) < (1.25*  (min(c(dat[1,]$PLY_cell.ml, dat[2,]$PLY_cell.ml)))) )  { 
                             C0_Ply <-  (max(c(dat[1,]$PLY_cell.ml, dat[2,]$PLY_cell.ml))) 
                             } else (C0_Ply <-  (min(c(dat[1,]$PLY_cell.ml, dat[2,]$PLY_cell.ml)))) # C0 for the ply 
  Cend_Ply            <- (min(c(dat[t_end_min1,]$PLY_cell.ml, dat[t_end,]$PLY_cell.ml)))
  t0_Ply              <- dat$time[dat$PLY_cell.ml==C0_Ply]
  t_Ply               <- max((dat$time[dat$PLY_cell.ml==Cend_Ply]) - t0_Ply) # call max becasue (although unlikely) there can be a case of the same count - calling multiple values

if (Cend_Ply == 0) { 
    ClearanceRate.Ply <- (V * ((ln( C0_Ply / 0.0001 )/(t_Ply/60)) - A.ply))
                      } else ( ClearanceRate.Ply <- (V * ((ln( C0_Ply / Cend_Ply )/(t_Ply/60)) - A.ply)) )
  ClearanceRate.Ply_length         <- ClearanceRate.Ply / (dat$Length_um[1] / 1000)
  ClearanceRate.Ply_bfactor_length <- ClearanceRate.Ply*((meanLength/(dat$Length_um[1] / 1000))^bLength)  # Ply b factor norm
 
  # chaet
  A.chaet             <- blanks$meanBlank[blanks$Type == 'Chaet']
  C0_Chaet            <- if ( (max(c(dat[1,]$Chaet_cell.ml, dat[2,]$Chaet_cell.ml))) < (1.25*  (min(c(dat[1,]$Chaet_cell.ml, dat[2,]$Chaet_cell.ml)))) )  { 
                             C0_Chaet <-  (max(c(dat[1,]$Chaet_cell.ml, dat[2,]$Chaet_cell.ml))) 
                             } else (C0_Chaet <-  (min(c(dat[1,]$Chaet_cell.ml, dat[2,]$Chaet_cell.ml)))) # C0 for the ply 
  Cend_Chaet          <- (min(c(dat[t_end_min1,]$Chaet_cell.ml, dat[t_end,]$Chaet_cell.ml)))
  t0_Chaet            <- dat$time[dat$Chaet_cell.ml==C0_Chaet]
  t_Chaet             <- max((dat$time[dat$Chaet_cell.ml==Cend_Chaet]) - t0_Chaet) # call max becasue (although unlikely) there can be a case of the same count - calling multiple values
  
if (Cend_Chaet == 0) { 
    ClearanceRate.Chaet <- (V * ((ln( C0_Chaet / 0.0001 )/(t_Chaet/60)) - A.chaet))
                      } else ( ClearanceRate.Chaet <- (V * ((ln( C0_Chaet / Cend_Chaet )/(t_Chaet/60)) - A.chaet)) )
  ClearanceRate.Chaet_length         <- ClearanceRate.Chaet / (dat$Length_um[1] / 1000) # div mm length
  ClearanceRate.Chaet_bfactor_length <- ClearanceRate.Chaet*((meanLength/(dat$Length_um[1] / 1000))^bLength)  # Chaetoceros b factor norm

    
  # low chl a (seston)
  A.Seston             <- blanks$meanBlank[blanks$Type == 'Seston']
  C0_Seston            <- if ( (max(c(dat[1,]$Low_chlorophyll_cell.ml, dat[2,]$Low_chlorophyll_cell.ml))) < (1.25*  (min(c(dat[1,]$Low_chlorophyll_cell.ml, dat[2,]$Low_chlorophyll_cell.ml)))) )  { 
                             C0_Seston <-  (max(c(dat[1,]$Low_chlorophyll_cell.ml, dat[2,]$Low_chlorophyll_cell.ml))) 
                             } else (C0_Seston <-  (min(c(dat[1,]$Low_chlorophyll_cell.ml, dat[2,]$Low_chlorophyll_cell.ml)))) # C0 for the ply 
  Cend_Seston          <- (min(c(dat[t_end_min1,]$Low_chlorophyll_cell.ml, dat[t_end,]$Low_chlorophyll_cell.ml)))
  t0_Seston            <- dat$time[dat$Low_chlorophyll_cell.ml==C0_Seston]
  t_Seston             <- max((dat$time[dat$Low_chlorophyll_cell.ml==Cend_Seston]) - t0_Seston) # call max becasue (although unlikely) there can be a case of the same count - calling multiple values
if (Cend_Seston == 0) { 
    ClearanceRate.Seston <- (V * ((ln( C0_Seston / 0.0001 )/(t_Seston/60)) - A.Seston))
                      } else ( ClearanceRate.Seston <- (V * ((ln( C0_Seston / Cend_Seston )/(t_Seston/60)) - A.Seston)) )
  ClearanceRate.Seston_length         <- ClearanceRate.Seston / (dat$Length_um[1] / 1000) # div mm length
  ClearanceRate.Seston_bfactor_length <- ClearanceRate.Seston*((meanLength/(dat$Length_um[1] / 1000))^bLength)  # Seston b factor norm
  
  dat2 <- dat[1,] %>%
    dplyr::select(c('Date','pH', 'Replicate', 'Fed_Unfed','Run', 'Plate', 'Number', 'Length_um', 'whole_Dry_weight')) %>% 
    mutate(Chaet_mL.hr                = ClearanceRate.Chaet) %>% 
    mutate(Ply_mL.hr                  = ClearanceRate.Ply) %>% 
    mutate(Seston_mL.hr               = ClearanceRate.Seston) %>% 

    mutate(Chaet_mL.hr.length         = ClearanceRate.Chaet_length) %>% 
    mutate(Ply_mL.hr.length           = ClearanceRate.Ply_length) %>% 
    mutate(Seston_mL.hr.length        = ClearanceRate.Seston_length) %>% 
    
    mutate(Chaet_mL.hr.bfactorlength  = ClearanceRate.Chaet_bfactor_length) %>% 
    mutate(Ply_mL.hr.bfactorlength    = ClearanceRate.Ply_bfactor_length) %>% 
    mutate(Seston_mL.hr.bfactorlength = ClearanceRate.Seston_bfactor_length)
    
  if (nrow(dat2) > 0) {
    FeedRate.table           <- data.frame(matrix(nrow = nrow(dat2), ncol = 18)) # create dataframe to save cumunalitively during for loop
    colnames(FeedRate.table) <- c('Date', 'ID', 'pH', 'Replicate', 'Fed_Unfed','Run', 'Plate', 'Number', 'Length_um', 
                                  'Chaet_mL.hr','Ply_mL.hr', 'Seston_mL.hr',
                                  'Chaet_mL.hr.length','Ply_mL.hr.length', 'Seston_mL.hr.length',
                                  'Chaet_mL.hr.bfactorlength', 'Ply_mL.hr.bfactorlength', 'Seston_mL.hr.bfactorlength') 
    FeedRate.table$Date                       <- dat2$Date
    FeedRate.table$ID                         <- loop_914[i,]
    FeedRate.table$pH                         <- gsub("_.*", "\\1", FeedRate.table$ID)
    FeedRate.table$Replicate                  <- gsub("^(?:[^_]+_){4}([^_]+).*", "\\1", FeedRate.table$ID)
    FeedRate.table$Fed_Unfed                  <- dat2$Fed_Unfed
    FeedRate.table$Run                        <- gsub("^(?:[^_]+_){2}([^_]+).*", "\\1", FeedRate.table$ID)
    FeedRate.table$Plate                      <- dat2$Plate
    FeedRate.table$Number                     <- gsub("^(?:[^_]+_){6}([^_]+).*", "\\1", FeedRate.table$ID)
    FeedRate.table$Length_um                  <- dat2$Length_um
    
    FeedRate.table$Chaet_mL.hr                <- dat2$Chaet_mL.hr
    FeedRate.table$Ply_mL.hr                  <- dat2$Ply_mL.hr
    FeedRate.table$Seston_mL.hr               <- dat2$Seston_mL.hr
    
    FeedRate.table$Chaet_mL.hr.length         <- dat2$Chaet_mL.hr.length
    FeedRate.table$Ply_mL.hr.length           <- dat2$Ply_mL.hr.length
    FeedRate.table$Seston_mL.hr.length        <- dat2$Seston_mL.hr.length
    
    FeedRate.table$Chaet_mL.hr.bfactorlength  <- dat2$Chaet_mL.hr.bfactorlength
    FeedRate.table$Ply_mL.hr.bfactorlength    <- dat2$Ply_mL.hr.bfactorlength
    FeedRate.table$Seston_mL.hr.bfactorlength <- dat2$Seston_mL.hr.bfactorlength
    
    df           <- data.frame(FeedRate.table) # name dataframe for this single row
    df_total.914 <- rbind(df_total.914,df) #bind to a cumulative list dataframe
    #print(df_total.914) # print to monitor progress
  } else {}
}



# Data
Chaet_FR_914_df    <- df_total.914 %>% 
  filter(Chaet_mL.hr > 0) %>% 
  mutate(type = 'chaet') %>% 
  dplyr::select(c("Date","ID","pH","Replicate","Fed_Unfed","Run","Plate","Number","Length_um", "type",
                  "Chaet_mL.hr","Chaet_mL.hr.length","Chaet_mL.hr.bfactorlength")) %>% 
  dplyr::rename(CR_mL.hr               = Chaet_mL.hr) %>% 
  dplyr::rename(CR_mL.hr.length        = Chaet_mL.hr.length) %>% 
  dplyr::rename(CR_mL.hr.bfactorlength = Chaet_mL.hr.bfactorlength)



Ply_FR_914_df <- df_total.914 %>% 
  filter(Ply_mL.hr > 0) %>% 
  mutate(type = 'ply') %>% 
  dplyr::select(c("Date","ID","pH","Replicate","Fed_Unfed","Run","Plate","Number","Length_um", "type",
                  "Ply_mL.hr","Ply_mL.hr.length","Ply_mL.hr.bfactorlength")) %>% 
  dplyr::rename(CR_mL.hr               = Ply_mL.hr) %>% 
  dplyr::rename(CR_mL.hr.length        = Ply_mL.hr.length) %>% 
  dplyr::rename(CR_mL.hr.bfactorlength = Ply_mL.hr.bfactorlength)



Seston_FR_914_df   <- df_total.914 %>% 
  filter(Seston_mL.hr > 0) %>% 
  mutate(type = 'seston') %>% 
  dplyr::select(c("Date","ID","pH","Replicate","Fed_Unfed","Run","Plate","Number","Length_um", "type",
                  "Seston_mL.hr","Seston_mL.hr.length","Seston_mL.hr.bfactorlength")) %>% 
  dplyr::rename(CR_mL.hr               = Seston_mL.hr) %>% 
  dplyr::rename(CR_mL.hr.length        = Seston_mL.hr.length) %>% 
  dplyr::rename(CR_mL.hr.bfactorlength = Seston_mL.hr.bfactorlength)


Master_914     <- rbind(Chaet_FR_914_df, Ply_FR_914_df, Seston_FR_914_df)

```

## 20210930 Clearance Rate data 

```{r 20210930 CR, echo = T}

# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Clearance Rate for loop     ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::


V = 25 # V == Volume of the vessel (in mL as 25 ml)

df_total.930<- data.frame() # start dataframe 
for (i in 1:nrow(loop_930)) {
  dat <- ClearanceRate_Master.930 %>% 
    dplyr::filter(uniq_Identifier == loop_930[i,]) %>% 
    dplyr::mutate(Date_pH = paste(Date, pH, sep = '_')) %>% 
    dplyr::arrange(time)
  
   t_end      <- nrow(dat)
  t_end_min1 <- nrow(dat) - 1
  
  blanks <- meanBLANKS.Summary %>% dplyr::filter(Date_pH %in% dat$Date_pH[1])
  
  # ply
  A.ply               <- blanks$meanBlank[blanks$Type == 'Ply']
  C0_Ply              <- if ( (max(c(dat[1,]$PLY_cell.ml, dat[2,]$PLY_cell.ml))) < (1.25*  (min(c(dat[1,]$PLY_cell.ml, dat[2,]$PLY_cell.ml)))) )  { 
                             C0_Ply <-  (max(c(dat[1,]$PLY_cell.ml, dat[2,]$PLY_cell.ml))) 
                             } else (C0_Ply <-  (min(c(dat[1,]$PLY_cell.ml, dat[2,]$PLY_cell.ml)))) # C0 for the ply 
  Cend_Ply            <- (min(c(dat[t_end_min1,]$PLY_cell.ml, dat[t_end,]$PLY_cell.ml)))
  t0_Ply              <- dat$time[dat$PLY_cell.ml==C0_Ply]
  t_Ply               <- max((dat$time[dat$PLY_cell.ml==Cend_Ply]) - t0_Ply) # call max becasue (although unlikely) there can be a case of the same count - calling multiple values

if (Cend_Ply == 0) { 
    ClearanceRate.Ply <- (V * ((ln( C0_Ply / 0.0001 )/(t_Ply/60)) - A.ply))
                      } else ( ClearanceRate.Ply <- (V * ((ln( C0_Ply / Cend_Ply )/(t_Ply/60)) - A.ply)) )
  ClearanceRate.Ply_length         <- ClearanceRate.Ply / (dat$Length_um[1] / 1000)
  ClearanceRate.Ply_bfactor_length <- ClearanceRate.Ply*((meanLength/(dat$Length_um[1] / 1000))^bLength)  # Ply b factor norm
 
  # chaet
  A.chaet             <- blanks$meanBlank[blanks$Type == 'Chaet']
  C0_Chaet            <- if ( (max(c(dat[1,]$Chaet_cell.ml, dat[2,]$Chaet_cell.ml))) < (1.25*  (min(c(dat[1,]$Chaet_cell.ml, dat[2,]$Chaet_cell.ml)))) )  { 
                             C0_Chaet <-  (max(c(dat[1,]$Chaet_cell.ml, dat[2,]$Chaet_cell.ml))) 
                             } else (C0_Chaet <-  (min(c(dat[1,]$Chaet_cell.ml, dat[2,]$Chaet_cell.ml)))) # C0 for the ply 
  Cend_Chaet          <- (min(c(dat[t_end_min1,]$Chaet_cell.ml, dat[t_end,]$Chaet_cell.ml)))
  t0_Chaet            <- dat$time[dat$Chaet_cell.ml==C0_Chaet]
  t_Chaet             <- max((dat$time[dat$Chaet_cell.ml==Cend_Chaet]) - t0_Chaet) # call max becasue (although unlikely) there can be a case of the same count - calling multiple values
  
if (Cend_Chaet == 0) { 
    ClearanceRate.Chaet <- (V * ((ln( C0_Chaet / 0.0001 )/(t_Chaet/60)) - A.chaet))
                      } else ( ClearanceRate.Chaet <- (V * ((ln( C0_Chaet / Cend_Chaet )/(t_Chaet/60)) - A.chaet)) )
  ClearanceRate.Chaet_length         <- ClearanceRate.Chaet / (dat$Length_um[1] / 1000) # div mm length
  ClearanceRate.Chaet_bfactor_length <- ClearanceRate.Chaet*((meanLength/(dat$Length_um[1] / 1000))^bLength)  # Chaetoceros b factor norm

    
  # low chl a (seston)
  A.Seston             <- blanks$meanBlank[blanks$Type == 'Seston']
  C0_Seston            <- if ( (max(c(dat[1,]$Low_chlorophyll_cell.ml, dat[2,]$Low_chlorophyll_cell.ml))) < (1.25*  (min(c(dat[1,]$Low_chlorophyll_cell.ml, dat[2,]$Low_chlorophyll_cell.ml)))) )  { 
                             C0_Seston <-  (max(c(dat[1,]$Low_chlorophyll_cell.ml, dat[2,]$Low_chlorophyll_cell.ml))) 
                             } else (C0_Seston <-  (min(c(dat[1,]$Low_chlorophyll_cell.ml, dat[2,]$Low_chlorophyll_cell.ml)))) # C0 for the ply 
  Cend_Seston          <- (min(c(dat[t_end_min1,]$Low_chlorophyll_cell.ml, dat[t_end,]$Low_chlorophyll_cell.ml)))
  t0_Seston            <- dat$time[dat$Low_chlorophyll_cell.ml==C0_Seston]
  t_Seston             <- max((dat$time[dat$Low_chlorophyll_cell.ml==Cend_Seston]) - t0_Seston) # call max becasue (although unlikely) there can be a case of the same count - calling multiple values
if (Cend_Seston == 0) { 
    ClearanceRate.Seston <- (V * ((ln( C0_Seston / 0.0001 )/(t_Seston/60)) - A.Seston))
                      } else ( ClearanceRate.Seston <- (V * ((ln( C0_Seston / Cend_Seston )/(t_Seston/60)) - A.Seston)) )
  ClearanceRate.Seston_length         <- ClearanceRate.Seston / (dat$Length_um[1] / 1000) # div mm length
  ClearanceRate.Seston_bfactor_length <- ClearanceRate.Seston*((meanLength/(dat$Length_um[1] / 1000))^bLength)  # Seston b factor norm
  
  dat2 <- dat[1,] %>%
    dplyr::select(c('Date','pH', 'Replicate', 'Fed_Unfed','Run', 'Plate', 'Number', 'Length_um', 'whole_Dry_weight')) %>% 
    mutate(Chaet_mL.hr                = ClearanceRate.Chaet) %>% 
    mutate(Ply_mL.hr                  = ClearanceRate.Ply) %>% 
    mutate(Seston_mL.hr               = ClearanceRate.Seston) %>% 

    mutate(Chaet_mL.hr.length         = ClearanceRate.Chaet_length) %>% 
    mutate(Ply_mL.hr.length           = ClearanceRate.Ply_length) %>% 
    mutate(Seston_mL.hr.length        = ClearanceRate.Seston_length) %>% 
    
    mutate(Chaet_mL.hr.bfactorlength  = ClearanceRate.Chaet_bfactor_length) %>% 
    mutate(Ply_mL.hr.bfactorlength    = ClearanceRate.Ply_bfactor_length) %>% 
    mutate(Seston_mL.hr.bfactorlength = ClearanceRate.Seston_bfactor_length)
    
  if (nrow(dat2) > 0) {
    FeedRate.table           <- data.frame(matrix(nrow = nrow(dat2), ncol = 18)) # create dataframe to save cumunalitively during for loop
    colnames(FeedRate.table) <- c('Date', 'ID', 'pH', 'Replicate', 'Fed_Unfed','Run', 'Plate', 'Number', 'Length_um', 
                                  'Chaet_mL.hr','Ply_mL.hr', 'Seston_mL.hr',
                                  'Chaet_mL.hr.length','Ply_mL.hr.length', 'Seston_mL.hr.length',
                                  'Chaet_mL.hr.bfactorlength', 'Ply_mL.hr.bfactorlength', 'Seston_mL.hr.bfactorlength') 
    FeedRate.table$Date                       <- dat2$Date
    FeedRate.table$ID                         <- loop_914[i,]
    FeedRate.table$pH                         <- gsub("_.*", "\\1", FeedRate.table$ID)
    FeedRate.table$Replicate                  <- gsub("^(?:[^_]+_){4}([^_]+).*", "\\1", FeedRate.table$ID)
    FeedRate.table$Fed_Unfed                  <- dat2$Fed_Unfed
    FeedRate.table$Run                        <- gsub("^(?:[^_]+_){2}([^_]+).*", "\\1", FeedRate.table$ID)
    FeedRate.table$Plate                      <- dat2$Plate
    FeedRate.table$Number                     <- gsub("^(?:[^_]+_){6}([^_]+).*", "\\1", FeedRate.table$ID)
    FeedRate.table$Length_um                  <- dat2$Length_um
    
    FeedRate.table$Chaet_mL.hr.length         <- dat2$Chaet_mL.hr.length
    FeedRate.table$Ply_mL.hr.length           <- dat2$Ply_mL.hr.length
    FeedRate.table$Seston_mL.hr.length        <- dat2$Seston_mL.hr.length
    
    FeedRate.table$Chaet_mL.hr                <- dat2$Chaet_mL.hr
    FeedRate.table$Ply_mL.hr                  <- dat2$Ply_mL.hr
    FeedRate.table$Seston_mL.hr               <- dat2$Seston_mL.hr
    
    FeedRate.table$Chaet_mL.hr.bfactorlength  <- dat2$Chaet_mL.hr.bfactorlength
    FeedRate.table$Ply_mL.hr.bfactorlength    <- dat2$Ply_mL.hr.bfactorlength
    FeedRate.table$Seston_mL.hr.bfactorlength <- dat2$Seston_mL.hr.bfactorlength
    
    df           <- data.frame(FeedRate.table) # name dataframe for this single row
    df_total.930 <- rbind(df_total.930,df) #bind to a cumulative list dataframe
    #print(df_total.930) # print to monitor progress
  } else {}
}

# Data
Chaet_FR_930_df    <- df_total.930 %>% 
  filter(Chaet_mL.hr > 0) %>% 
  mutate(type = 'chaet') %>% 
  dplyr::select(c("Date","ID","pH","Replicate","Fed_Unfed","Run","Plate","Number","Length_um", "type",
                  "Chaet_mL.hr","Chaet_mL.hr.length","Chaet_mL.hr.bfactorlength")) %>% 
  dplyr::rename(CR_mL.hr               = Chaet_mL.hr) %>% 
  dplyr::rename(CR_mL.hr.length        = Chaet_mL.hr.length) %>% 
  dplyr::rename(CR_mL.hr.bfactorlength = Chaet_mL.hr.bfactorlength)



Ply_FR_930_df <- df_total.930 %>% 
  filter(Ply_mL.hr > 0) %>% 
  mutate(type = 'ply') %>% 
  dplyr::select(c("Date","ID","pH","Replicate","Fed_Unfed","Run","Plate","Number","Length_um", "type",
                  "Ply_mL.hr","Ply_mL.hr.length","Ply_mL.hr.bfactorlength")) %>% 
  dplyr::rename(CR_mL.hr               = Ply_mL.hr) %>% 
  dplyr::rename(CR_mL.hr.length        = Ply_mL.hr.length) %>% 
  dplyr::rename(CR_mL.hr.bfactorlength = Ply_mL.hr.bfactorlength)



Seston_FR_930_df   <- df_total.930 %>% 
  filter(Seston_mL.hr > 0) %>% 
  mutate(type = 'seston') %>% 
  dplyr::select(c("Date","ID","pH","Replicate","Fed_Unfed","Run","Plate","Number","Length_um", "type",
                  "Seston_mL.hr","Seston_mL.hr.length","Seston_mL.hr.bfactorlength")) %>% 
  dplyr::rename(CR_mL.hr               = Seston_mL.hr) %>% 
  dplyr::rename(CR_mL.hr.length        = Seston_mL.hr.length) %>% 
  dplyr::rename(CR_mL.hr.bfactorlength = Seston_mL.hr.bfactorlength)


Master_930     <- rbind(Chaet_FR_930_df, Ply_FR_930_df, Seston_FR_930_df)
```

## 20211026 Clearance Rate data 

NOTE: the calculation here changes from the other tiepoints due to **complete clearance of algae in larger/older individuals!** 
if the 0 value is kept it will become 'Inf' due to negative denominator in the natural log... in ln(C_init / C_end)
thus I wrote a conditional statement (if else) for these negative values - making them equal to 0.0001 for this ratio
the alternative can be to call the nearest non-zero value in line

```{r 20211026 CR, echo = T}



# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Clearance Rate for loop     ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::


V = 25 # V == Volume of the vessel (in mL as 25 ml)

df_total.1026<- data.frame() # start dataframe 
for (i in 1:nrow(loop_1026)) {
  dat <- ClearanceRate_Master.1026 %>% 
    dplyr::filter(uniq_Identifier == loop_1026[i,]) %>% 
    dplyr::mutate(Date_pH = paste(Date, pH, sep = '_')) %>% 
    dplyr::arrange(time)
  
   t_end      <- nrow(dat)
  t_end_min1 <- nrow(dat) - 1
  
  blanks <- meanBLANKS.Summary %>% dplyr::filter(Date_pH %in% dat$Date_pH[1])
  
  # ply
  A.ply               <- blanks$meanBlank[blanks$Type == 'Ply']
  C0_Ply              <- if ( (max(c(dat[1,]$PLY_cell.ml, dat[2,]$PLY_cell.ml))) < (1.25*  (min(c(dat[1,]$PLY_cell.ml, dat[2,]$PLY_cell.ml)))) )  { 
                             C0_Ply <-  (max(c(dat[1,]$PLY_cell.ml, dat[2,]$PLY_cell.ml))) 
                             } else (C0_Ply <-  (min(c(dat[1,]$PLY_cell.ml, dat[2,]$PLY_cell.ml)))) # C0 for the ply 
  Cend_Ply            <- (min(c(dat[t_end_min1,]$PLY_cell.ml, dat[t_end,]$PLY_cell.ml)))
  t0_Ply              <- dat$time[dat$PLY_cell.ml==C0_Ply]
  t_Ply               <- max((dat$time[dat$PLY_cell.ml==Cend_Ply]) - t0_Ply) # call max becasue (although unlikely) there can be a case of the same count - calling multiple values

if (Cend_Ply == 0) { 
    ClearanceRate.Ply <- (V * ((ln( C0_Ply / 0.0001 )/(t_Ply/60)) - A.ply))
                      } else ( ClearanceRate.Ply <- (V * ((ln( C0_Ply / Cend_Ply )/(t_Ply/60)) - A.ply)) )
  ClearanceRate.Ply_length         <- ClearanceRate.Ply / (dat$Length_um[1] / 1000)
  ClearanceRate.Ply_bfactor_length <- ClearanceRate.Ply*((meanLength/(dat$Length_um[1] / 1000))^bLength)  # Ply b factor norm
 
  # chaet
  A.chaet             <- blanks$meanBlank[blanks$Type == 'Chaet']
  C0_Chaet            <- if ( (max(c(dat[1,]$Chaet_cell.ml, dat[2,]$Chaet_cell.ml))) < (1.25*  (min(c(dat[1,]$Chaet_cell.ml, dat[2,]$Chaet_cell.ml)))) )  { 
                             C0_Chaet <-  (max(c(dat[1,]$Chaet_cell.ml, dat[2,]$Chaet_cell.ml))) 
                             } else (C0_Chaet <-  (min(c(dat[1,]$Chaet_cell.ml, dat[2,]$Chaet_cell.ml)))) # C0 for the ply 
  Cend_Chaet          <- (min(c(dat[t_end_min1,]$Chaet_cell.ml, dat[t_end,]$Chaet_cell.ml)))
  t0_Chaet            <- dat$time[dat$Chaet_cell.ml==C0_Chaet]
  t_Chaet             <- max((dat$time[dat$Chaet_cell.ml==Cend_Chaet]) - t0_Chaet) # call max becasue (although unlikely) there can be a case of the same count - calling multiple values
  
if (Cend_Chaet == 0) { 
    ClearanceRate.Chaet <- (V * ((ln( C0_Chaet / 0.0001 )/(t_Chaet/60)) - A.chaet))
                      } else ( ClearanceRate.Chaet <- (V * ((ln( C0_Chaet / Cend_Chaet )/(t_Chaet/60)) - A.chaet)) )
  ClearanceRate.Chaet_length         <- ClearanceRate.Chaet / (dat$Length_um[1] / 1000) # div mm length
  ClearanceRate.Chaet_bfactor_length <- ClearanceRate.Chaet*((meanLength/(dat$Length_um[1] / 1000))^bLength)  # Chaetoceros b factor norm

    
  # low chl a (seston)
  A.Seston             <- blanks$meanBlank[blanks$Type == 'Seston']
  C0_Seston            <- if ( (max(c(dat[1,]$Low_chlorophyll_cell.ml, dat[2,]$Low_chlorophyll_cell.ml))) < (1.25*  (min(c(dat[1,]$Low_chlorophyll_cell.ml, dat[2,]$Low_chlorophyll_cell.ml)))) )  { 
                             C0_Seston <-  (max(c(dat[1,]$Low_chlorophyll_cell.ml, dat[2,]$Low_chlorophyll_cell.ml))) 
                             } else (C0_Seston <-  (min(c(dat[1,]$Low_chlorophyll_cell.ml, dat[2,]$Low_chlorophyll_cell.ml)))) # C0 for the ply 
  Cend_Seston          <- (min(c(dat[t_end_min1,]$Low_chlorophyll_cell.ml, dat[t_end,]$Low_chlorophyll_cell.ml)))
  t0_Seston            <- dat$time[dat$Low_chlorophyll_cell.ml==C0_Seston]
  t_Seston             <- max((dat$time[dat$Low_chlorophyll_cell.ml==Cend_Seston]) - t0_Seston) # call max becasue (although unlikely) there can be a case of the same count - calling multiple values
if (Cend_Seston == 0) { 
    ClearanceRate.Seston <- (V * ((ln( C0_Seston / 0.0001 )/(t_Seston/60)) - A.Seston))
                      } else ( ClearanceRate.Seston <- (V * ((ln( C0_Seston / Cend_Seston )/(t_Seston/60)) - A.Seston)) )
  ClearanceRate.Seston_length         <- ClearanceRate.Seston / (dat$Length_um[1] / 1000) # div mm length
  ClearanceRate.Seston_bfactor_length <- ClearanceRate.Seston*((meanLength/(dat$Length_um[1] / 1000))^bLength)  # Seston b factor norm
  
  dat2 <- dat[1,] %>%
    dplyr::select(c('Date','pH', 'Replicate', 'Fed_Unfed','Run', 'Plate', 'Number', 'Length_um', 'whole_Dry_weight')) %>% 
    mutate(Chaet_mL.hr                = ClearanceRate.Chaet) %>% 
    mutate(Ply_mL.hr                  = ClearanceRate.Ply) %>% 
    mutate(Seston_mL.hr               = ClearanceRate.Seston) %>% 

    mutate(Chaet_mL.hr.length         = ClearanceRate.Chaet_length) %>% 
    mutate(Ply_mL.hr.length           = ClearanceRate.Ply_length) %>% 
    mutate(Seston_mL.hr.length        = ClearanceRate.Seston_length) %>% 
    
    mutate(Chaet_mL.hr.bfactorlength  = ClearanceRate.Chaet_bfactor_length) %>% 
    mutate(Ply_mL.hr.bfactorlength    = ClearanceRate.Ply_bfactor_length) %>% 
    mutate(Seston_mL.hr.bfactorlength = ClearanceRate.Seston_bfactor_length)
    
  if (nrow(dat2) > 0) {
    FeedRate.table           <- data.frame(matrix(nrow = nrow(dat2), ncol = 18)) # create dataframe to save cumunalitively during for loop
    colnames(FeedRate.table) <- c('Date', 'ID', 'pH', 'Replicate', 'Fed_Unfed','Run', 'Plate', 'Number', 'Length_um', 
                                  'Chaet_mL.hr','Ply_mL.hr', 'Seston_mL.hr',
                                  'Chaet_mL.hr.length','Ply_mL.hr.length', 'Seston_mL.hr.length',
                                  'Chaet_mL.hr.bfactorlength', 'Ply_mL.hr.bfactorlength', 'Seston_mL.hr.bfactorlength') 
    FeedRate.table$Date                       <- dat2$Date
    FeedRate.table$ID                         <- loop_914[i,]
    FeedRate.table$pH                         <- gsub("_.*", "\\1", FeedRate.table$ID)
    FeedRate.table$Replicate                  <- gsub("^(?:[^_]+_){4}([^_]+).*", "\\1", FeedRate.table$ID)
    FeedRate.table$Fed_Unfed                  <- dat2$Fed_Unfed
    FeedRate.table$Run                        <- gsub("^(?:[^_]+_){2}([^_]+).*", "\\1", FeedRate.table$ID)
    FeedRate.table$Plate                      <- dat2$Plate
    FeedRate.table$Number                     <- gsub("^(?:[^_]+_){6}([^_]+).*", "\\1", FeedRate.table$ID)
    FeedRate.table$Length_um                  <- dat2$Length_um
    
    FeedRate.table$Chaet_mL.hr.length         <- dat2$Chaet_mL.hr.length
    FeedRate.table$Ply_mL.hr.length           <- dat2$Ply_mL.hr.length
    FeedRate.table$Seston_mL.hr.length        <- dat2$Seston_mL.hr.length
    
    FeedRate.table$Chaet_mL.hr                <- dat2$Chaet_mL.hr
    FeedRate.table$Ply_mL.hr                  <- dat2$Ply_mL.hr
    FeedRate.table$Seston_mL.hr               <- dat2$Seston_mL.hr
    
    FeedRate.table$Chaet_mL.hr.bfactorlength  <- dat2$Chaet_mL.hr.bfactorlength
    FeedRate.table$Ply_mL.hr.bfactorlength    <- dat2$Ply_mL.hr.bfactorlength
    FeedRate.table$Seston_mL.hr.bfactorlength <- dat2$Seston_mL.hr.bfactorlength
    
    df           <- data.frame(FeedRate.table) # name dataframe for this single row
    df_total.1026 <- rbind(df_total.1026,df) #bind to a cumulative list dataframe
    #print(df_total.1026) # print to monitor progress
  } else {}
}


# Data
Chaet_FR_1026_df    <- df_total.1026 %>% 
  filter(Chaet_mL.hr > 0) %>% 
  mutate(type = 'chaet') %>% 
  dplyr::select(c("Date","ID","pH","Replicate","Fed_Unfed","Run","Plate","Number","Length_um", "type",
                  "Chaet_mL.hr","Chaet_mL.hr.length","Chaet_mL.hr.bfactorlength")) %>% 
  dplyr::rename(CR_mL.hr               = Chaet_mL.hr) %>% 
  dplyr::rename(CR_mL.hr.length        = Chaet_mL.hr.length) %>% 
  dplyr::rename(CR_mL.hr.bfactorlength = Chaet_mL.hr.bfactorlength)



Ply_FR_1026_df <- df_total.1026 %>% 
  filter(Ply_mL.hr > 0) %>% 
  mutate(type = 'ply') %>% 
  dplyr::select(c("Date","ID","pH","Replicate","Fed_Unfed","Run","Plate","Number","Length_um", "type",
                  "Ply_mL.hr","Ply_mL.hr.length","Ply_mL.hr.bfactorlength")) %>% 
  dplyr::rename(CR_mL.hr               = Ply_mL.hr) %>% 
  dplyr::rename(CR_mL.hr.length        = Ply_mL.hr.length) %>% 
  dplyr::rename(CR_mL.hr.bfactorlength = Ply_mL.hr.bfactorlength)



Seston_FR_1026_df   <- df_total.1026 %>% 
  filter(Seston_mL.hr > 0) %>% 
  mutate(type = 'seston') %>% 
  dplyr::select(c("Date","ID","pH","Replicate","Fed_Unfed","Run","Plate","Number","Length_um", "type",
                  "Seston_mL.hr","Seston_mL.hr.length","Seston_mL.hr.bfactorlength")) %>% 
  dplyr::rename(CR_mL.hr               = Seston_mL.hr) %>% 
  dplyr::rename(CR_mL.hr.length        = Seston_mL.hr.length) %>% 
  dplyr::rename(CR_mL.hr.bfactorlength = Seston_mL.hr.bfactorlength)


Master_1026     <- rbind(Chaet_FR_1026_df, Ply_FR_1026_df, Seston_FR_1026_df)
```

## 20220202 Clearance Rate data 

NOTE: the calculation here changes from the other tiepoints due to **complete clearance of algae in larger/older individuals!** 
if the 0 value is kept it will become 'Inf' due to negative denominator in the natural log... in ln(C_init / C_end)
thus I wrote a conditional statement (if else) for these negative values - making them equal to 0.0001 for this ratio
the alternative can be to call the nearest non-zero value in line

```{r 20220202 CR, echo = T}



# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Clearance Rate for loop     ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::


V = 25 # V == Volume of the vessel (in mL as 25 ml)

df_total.0202<- data.frame() # start dataframe 
for (i in 1:nrow(loop_0202)) {
  dat <- ClearanceRate_Master.0202 %>% 
    dplyr::filter(uniq_Identifier == loop_0202[i,]) %>% 
    dplyr::mutate(Date_pH = paste(Date, pH, sep = '_')) %>% 
    dplyr::arrange(time)
  
  t_end      <- nrow(dat)
  t_end_min1 <- nrow(dat) - 1
  
  blanks <- meanBLANKS.Summary %>% dplyr::filter(Date_pH %in% dat$Date_pH[1])
  
  # ply
  A.ply               <- blanks$meanBlank[blanks$Type == 'Ply']
  C0_Ply              <- if ( (max(c(dat[1,]$PLY_cell.ml, dat[2,]$PLY_cell.ml))) < (1.25*  (min(c(dat[1,]$PLY_cell.ml, dat[2,]$PLY_cell.ml)))) )  { 
                             C0_Ply <-  (max(c(dat[1,]$PLY_cell.ml, dat[2,]$PLY_cell.ml))) 
                             } else (C0_Ply <-  (min(c(dat[1,]$PLY_cell.ml, dat[2,]$PLY_cell.ml)))) # C0 for the ply 
  Cend_Ply            <- (min(c(dat[t_end_min1,]$PLY_cell.ml, dat[t_end,]$PLY_cell.ml)))
  t0_Ply              <- dat$time[dat$PLY_cell.ml==C0_Ply]
  t_Ply               <- max((dat$time[dat$PLY_cell.ml==Cend_Ply]) - t0_Ply) # call max becasue (although unlikely) there can be a case of the same count - calling multiple values

if (Cend_Ply == 0) { 
    ClearanceRate.Ply <- (V * ((ln( C0_Ply / 0.0001 )/(t_Ply/60)) - A.ply))
                      } else ( ClearanceRate.Ply <- (V * ((ln( C0_Ply / Cend_Ply )/(t_Ply/60)) - A.ply)) )
  ClearanceRate.Ply_length         <- ClearanceRate.Ply / (dat$Length_um[1] / 1000)
  ClearanceRate.Ply_bfactor_length <- ClearanceRate.Ply*((meanLength/(dat$Length_um[1] / 1000))^bLength)  # Ply b factor norm
 
  # chaet
  A.chaet             <- blanks$meanBlank[blanks$Type == 'Chaet']
  C0_Chaet            <- if ( (max(c(dat[1,]$Chaet_cell.ml, dat[2,]$Chaet_cell.ml))) < (1.25*  (min(c(dat[1,]$Chaet_cell.ml, dat[2,]$Chaet_cell.ml)))) )  { 
                             C0_Chaet <-  (max(c(dat[1,]$Chaet_cell.ml, dat[2,]$Chaet_cell.ml))) 
                             } else (C0_Chaet <-  (min(c(dat[1,]$Chaet_cell.ml, dat[2,]$Chaet_cell.ml)))) # C0 for the ply 
  Cend_Chaet          <- (min(c(dat[t_end_min1,]$Chaet_cell.ml, dat[t_end,]$Chaet_cell.ml)))
  t0_Chaet            <- dat$time[dat$Chaet_cell.ml==C0_Chaet]
  t_Chaet             <- max((dat$time[dat$Chaet_cell.ml==Cend_Chaet]) - t0_Chaet) # call max becasue (although unlikely) there can be a case of the same count - calling multiple values
  
if (Cend_Chaet == 0) { 
    ClearanceRate.Chaet <- (V * ((ln( C0_Chaet / 0.0001 )/(t_Chaet/60)) - A.chaet))
                      } else ( ClearanceRate.Chaet <- (V * ((ln( C0_Chaet / Cend_Chaet )/(t_Chaet/60)) - A.chaet)) )
  ClearanceRate.Chaet_length         <- ClearanceRate.Chaet / (dat$Length_um[1] / 1000) # div mm length
  ClearanceRate.Chaet_bfactor_length <- ClearanceRate.Chaet*((meanLength/(dat$Length_um[1] / 1000))^bLength)  # Chaetoceros b factor norm

    
  # low chl a (seston)
  A.Seston             <- blanks$meanBlank[blanks$Type == 'Seston']
  C0_Seston            <- if ( (max(c(dat[1,]$Low_chlorophyll_cell.ml, dat[2,]$Low_chlorophyll_cell.ml))) < (1.25*  (min(c(dat[1,]$Low_chlorophyll_cell.ml, dat[2,]$Low_chlorophyll_cell.ml)))) )  { 
                             C0_Seston <-  (max(c(dat[1,]$Low_chlorophyll_cell.ml, dat[2,]$Low_chlorophyll_cell.ml))) 
                             } else (C0_Seston <-  (min(c(dat[1,]$Low_chlorophyll_cell.ml, dat[2,]$Low_chlorophyll_cell.ml)))) # C0 for the ply 
  Cend_Seston          <- (min(c(dat[t_end_min1,]$Low_chlorophyll_cell.ml, dat[t_end,]$Low_chlorophyll_cell.ml)))
  t0_Seston            <- dat$time[dat$Low_chlorophyll_cell.ml==C0_Seston]
  t_Seston             <- max((dat$time[dat$Low_chlorophyll_cell.ml==Cend_Seston]) - t0_Seston) # call max becasue (although unlikely) there can be a case of the same count - calling multiple values
if (Cend_Seston == 0) { 
    ClearanceRate.Seston <- (V * ((ln( C0_Seston / 0.0001 )/(t_Seston/60)) - A.Seston))
                      } else ( ClearanceRate.Seston <- (V * ((ln( C0_Seston / Cend_Seston )/(t_Seston/60)) - A.Seston)) )
  ClearanceRate.Seston_length         <- ClearanceRate.Seston / (dat$Length_um[1] / 1000) # div mm length
  ClearanceRate.Seston_bfactor_length <- ClearanceRate.Seston*((meanLength/(dat$Length_um[1] / 1000))^bLength)  # Seston b factor norm
  
  dat2 <- dat[1,] %>%
    dplyr::select(c('Date','pH', 'Replicate', 'Fed_Unfed','Run', 'Plate', 'Number', 'Length_um', 'whole_Dry_weight')) %>% 
    mutate(Chaet_mL.hr                = ClearanceRate.Chaet) %>% 
    mutate(Ply_mL.hr                  = ClearanceRate.Ply) %>% 
    mutate(Seston_mL.hr               = ClearanceRate.Seston) %>% 

    mutate(Chaet_mL.hr.length         = ClearanceRate.Chaet_length) %>% 
    mutate(Ply_mL.hr.length           = ClearanceRate.Ply_length) %>% 
    mutate(Seston_mL.hr.length        = ClearanceRate.Seston_length) %>% 
    
    mutate(Chaet_mL.hr.bfactorlength  = ClearanceRate.Chaet_bfactor_length) %>% 
    mutate(Ply_mL.hr.bfactorlength    = ClearanceRate.Ply_bfactor_length) %>% 
    mutate(Seston_mL.hr.bfactorlength = ClearanceRate.Seston_bfactor_length)
    
  if (nrow(dat2) > 0) {
    FeedRate.table           <- data.frame(matrix(nrow = nrow(dat2), ncol = 18)) # create dataframe to save cumunalitively during for loop
    colnames(FeedRate.table) <- c('Date', 'ID', 'pH', 'Replicate', 'Fed_Unfed','Run', 'Plate', 'Number', 'Length_um', 
                                  'Chaet_mL.hr','Ply_mL.hr', 'Seston_mL.hr',
                                  'Chaet_mL.hr.length','Ply_mL.hr.length', 'Seston_mL.hr.length',
                                  'Chaet_mL.hr.bfactorlength', 'Ply_mL.hr.bfactorlength', 'Seston_mL.hr.bfactorlength') 
    FeedRate.table$Date                       <- dat2$Date
    FeedRate.table$ID                         <- loop_914[i,]
    FeedRate.table$pH                         <- gsub("_.*", "\\1", FeedRate.table$ID)
    FeedRate.table$Replicate                  <- gsub("^(?:[^_]+_){4}([^_]+).*", "\\1", FeedRate.table$ID)
    FeedRate.table$Fed_Unfed                  <- dat2$Fed_Unfed
    FeedRate.table$Run                        <- gsub("^(?:[^_]+_){2}([^_]+).*", "\\1", FeedRate.table$ID)
    FeedRate.table$Plate                      <- dat2$Plate
    FeedRate.table$Number                     <- gsub("^(?:[^_]+_){6}([^_]+).*", "\\1", FeedRate.table$ID)
    FeedRate.table$Length_um                  <- dat2$Length_um
    
    FeedRate.table$Chaet_mL.hr.length         <- dat2$Chaet_mL.hr.length
    FeedRate.table$Ply_mL.hr.length           <- dat2$Ply_mL.hr.length
    FeedRate.table$Seston_mL.hr.length        <- dat2$Seston_mL.hr.length
    
    FeedRate.table$Chaet_mL.hr                <- dat2$Chaet_mL.hr
    FeedRate.table$Ply_mL.hr                  <- dat2$Ply_mL.hr
    FeedRate.table$Seston_mL.hr               <- dat2$Seston_mL.hr
    
    FeedRate.table$Chaet_mL.hr.bfactorlength  <- dat2$Chaet_mL.hr.bfactorlength
    FeedRate.table$Ply_mL.hr.bfactorlength    <- dat2$Ply_mL.hr.bfactorlength
    FeedRate.table$Seston_mL.hr.bfactorlength <- dat2$Seston_mL.hr.bfactorlength
    
    df           <- data.frame(FeedRate.table) # name dataframe for this single row
    df_total.0202 <- rbind(df_total.0202,df) #bind to a cumulative list dataframe
    #print(df_total.0202) # print to monitor progress
  } else {}
}


# Data
Chaet_FR_0202_df    <- df_total.0202 %>% 
  filter(Chaet_mL.hr > 0) %>% 
  mutate(type = 'chaet') %>% 
  dplyr::select(c("Date","ID","pH","Replicate","Fed_Unfed","Run","Plate","Number","Length_um", "type",
                  "Chaet_mL.hr","Chaet_mL.hr.length","Chaet_mL.hr.bfactorlength")) %>% 
  dplyr::rename(CR_mL.hr               = Chaet_mL.hr) %>% 
  dplyr::rename(CR_mL.hr.length        = Chaet_mL.hr.length) %>% 
  dplyr::rename(CR_mL.hr.bfactorlength = Chaet_mL.hr.bfactorlength)



Ply_FR_0202_df <- df_total.0202 %>% 
  filter(Ply_mL.hr > 0) %>% 
  mutate(type = 'ply') %>% 
  dplyr::select(c("Date","ID","pH","Replicate","Fed_Unfed","Run","Plate","Number","Length_um", "type",
                  "Ply_mL.hr","Ply_mL.hr.length","Ply_mL.hr.bfactorlength")) %>% 
  dplyr::rename(CR_mL.hr               = Ply_mL.hr) %>% 
  dplyr::rename(CR_mL.hr.length        = Ply_mL.hr.length) %>% 
  dplyr::rename(CR_mL.hr.bfactorlength = Ply_mL.hr.bfactorlength)



Seston_FR_0202_df   <- df_total.0202 %>% 
  filter(Seston_mL.hr > 0) %>% 
  mutate(type = 'seston') %>% 
  dplyr::select(c("Date","ID","pH","Replicate","Fed_Unfed","Run","Plate","Number","Length_um", "type",
                  "Seston_mL.hr","Seston_mL.hr.length","Seston_mL.hr.bfactorlength")) %>% 
  dplyr::rename(CR_mL.hr               = Seston_mL.hr) %>% 
  dplyr::rename(CR_mL.hr.length        = Seston_mL.hr.length) %>% 
  dplyr::rename(CR_mL.hr.bfactorlength = Seston_mL.hr.bfactorlength)


Master_0202     <- rbind(Chaet_FR_0202_df, Ply_FR_0202_df, Seston_FR_0202_df)
```

# master file
```{r, master Clearance rate data }

ClearanceRate_Master <- rbind(Master_914, Master_930, Master_1026, Master_0202) %>% 
  dplyr::mutate(pCO2 = case_when(pH == 8.0 ~ "500 μatm", pH == 7.5 ~ "800 μatm"))
write.csv(ClearanceRate_Master, "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/Calculated_Clearance_Master.csv")

```



```{r 20210914 CR stats, echo = T}
# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# assign a random factor for LME models   ::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::


df_total.914 <- df_total.914  %>% 
  dplyr::mutate(pCO2 = case_when(pH == 8.0 ~ "500 μatm", pH == 7.5 ~ "800 μatm")) %>% 
  dplyr::mutate(random_fact = as.factor(paste(Replicate, pH, sep = '_')))




# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# clean & view means...       ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::


Ply_CR_914_Means <- df_total.914 %>% 
  dplyr::group_by(pCO2) %>% 
  dplyr::filter(Ply_mL.hr.mmlength > 0) %>% # ommit negative values
  dplyr::summarise(
    meanCR = mean(Ply_mL.hr.mmlength),
    sdCR   = sd(Ply_mL.hr.mmlength), 
    seCR   = sd(Ply_mL.hr.mmlength) / sqrt(length(Ply_mL.hr.mmlength)), 
    n = n()) %>% 
  dplyr::mutate(Type = 'ply')
print(Ply_CR_914_Means)

Chaet_CR_914_Means <- df_total.914 %>% 
  dplyr::group_by(pCO2) %>% 
  dplyr::filter(Chaet_mL.hr.mmlength > 0) %>% # ommit negative values
  dplyr::summarise(
    meanCR = mean(Chaet_mL.hr.mmlength),
    sdCR   = sd(Chaet_mL.hr.mmlength), 
    seCR   = sd(Chaet_mL.hr.mmlength) / sqrt(length(Chaet_mL.hr.mmlength)), 
    n = n()) %>% 
  dplyr::mutate(Type = 'chaet')
print(Chaet_CR_914_Means)


Seston_CR_914_Means <- df_total.914 %>% 
  dplyr::group_by(pCO2) %>% 
  dplyr::filter(Seston_mL.hr.mmlength > 0) %>% # ommit negative values
  dplyr::summarise(
    meanCR = mean(Seston_mL.hr.mmlength),
    sdCR   = sd(Seston_mL.hr.mmlength), 
    seCR   = sd(Seston_mL.hr.mmlength) / sqrt(length(Seston_mL.hr.mmlength)), 
    n = n()) %>% 
    dplyr::mutate(Type = 'seston')
print(Seston_CR_914_Means)


CR_Means_Master_914 <- rbind(Ply_CR_914_Means, Chaet_CR_914_Means, Seston_CR_914_Means)
write.csv(CR_Means_Master_914, "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/20210914_figs_tables/Mean_CR.csv")


# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Linear mixed-effects models ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::





# library
require(nlme)
require(performance)

# Ply - Linear Mixed Effects Model
Ply_LMEmod_0914 <-lme(CR_mL.hr.mmlength ~ pH, random=~1|random_fact, data=Ply_FR_914_df)
# |     &nbsp;      | numDF | denDF | F-value |  p-value  |
# |:---------------:|:-----:|:-----:|:-------:|:---------:|
# | **(Intercept)** |   1   |   8   |  61.6   | 5.011e-05 |
# |     **pH**      |   1   |   6   | 0.1432  |  0.7181   |
pander(anova(Ply_LMEmod_0914), style='rmarkdown') # anova table of lmer
kable(as.data.frame(anova(Ply_LMEmod_0914))) %>%  # print a png of this table
  kable_styling() %>%
  save_kable(file = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/20210914_figs_tables/20210914_PLY_CR_LME_Table.png", zoom = 1.5)
pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/20210914_figs_tables/20210914_PLY_CR_LME_Diagnostics.pdf"))
check_model(Ply_LMEmod_0914) # print the model diagnostics 
dev.off()
# one way anova witou the random factor of tank
Ply_AOVmod_0914 <-aov(lm(CR_mL.hr.mmlength ~ pH, data=Ply_FR_914_df))
shapiro.test(resid(Ply_AOVmod_0914)) #  0.1025 - normal
leveneTest(Ply_AOVmod_0914) # 0.7556  - pass
pander(anova(Ply_AOVmod_0914), style='rmarkdown') # anova table of lmer
# |    &nbsp;     | Df | Sum Sq | Mean Sq | F value | Pr(>F) |
# |:-------------:|:--:|:------:|:-------:|:-------:|:------:|
# |    **pH**     | 1  | 0.8132 | 0.8132  | 0.1432  | 0.7108 |
# | **Residuals** | 14 |  79.5  |  5.678  |   NA    |   NA   |




# Chaet - Linear Mixed Effects Model
Chaet_LMEmod_0914 <-lme(CR_mL.hr.mmlength ~ pH, random=~1|random_fact, data=Chaet_FR_914_df)
# |     &nbsp;      | numDF | denDF | F-value |  p-value  |
# |:---------------:|:-----:|:-----:|:-------:|:---------:|
# | **(Intercept)** |   1   |  15   |  64.57  | 8.153e-07 |
# |     **pH**      |   1   |   6   |  4.102  |  0.08924  |
pander(anova(Chaet_LMEmod_0914), style='rmarkdown') # anova table of lmer
kable(as.data.frame(anova(Chaet_LMEmod_0914))) %>%  # print a png of this table
  kable_styling() %>%
  save_kable(file = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/20210914_figs_tables/20210914_CHAET_CR_LME_Table.png", zoom = 1.5)
pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/20210914_figs_tables/20210914_CHAET_CR_LME_Diagnostics.pdf"))
check_model(Chaet_LMEmod_0914) # print the model diagnostics 
dev.off()
# one way anova witou the random factor of tank
Chaet_AOVmod_0914 <-aov(lm(CR_mL.hr.mmlength ~ pH, data=Chaet_FR_914_df))
shapiro.test(resid(Chaet_AOVmod_0914)) #  0.1672 - normal
leveneTest(Chaet_AOVmod_0914) # 0.1234  - pass
pander(anova(Chaet_AOVmod_0914), style='rmarkdown') # anova table of lmer
# |    &nbsp;     | Df | Sum Sq | Mean Sq | F value | Pr(>F)  |
# |:-------------:|:--:|:------:|:-------:|:-------:|:-------:|
# |    **pH**     | 1  | 21.08  |  21.08  |  4.102  | 0.05573 | # marginal effect of pH
# | **Residuals** | 21 | 107.9  |  5.139  |   NA    |   NA    |







# Seston - Linear Mixed Effects Model
Seston_LMEmod_0914 <-lme(CR_mL.hr.mmlength ~ pH, random=~1|random_fact, data=Seston_FR_914_df)
# |     &nbsp;      | numDF | denDF | F-value |  p-value  |
# |:---------------:|:-----:|:-----:|:-------:|:---------:|
# | **(Intercept)** |   1   |  15   |  48.89  | 4.339e-06 |
# |     **pH**      |   1   |   6   |  1.496  |  0.2672   |
pander(anova(Seston_LMEmod_0914), style='rmarkdown') # anova table of lmer
kable(as.data.frame(anova(Chaet_LMEmod_0914))) %>%  # print a png of this table
  kable_styling() %>%
  save_kable(file = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/20210914_figs_tables/20210914_SESTON_CR_LME_Table.png", zoom = 1.5)
pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/20210914_figs_tables/20210914_SESTON_CR_LME_Diagnostics.pdf"))
check_model(Seston_LMEmod_0914) # print the model diagnostics 
dev.off()
# one way anova witou the random factor of tank
Seston_AOVmod_0914 <-aov(lm(CR_mL.hr.mmlength ~ pH, data=Seston_FR_914_df))
shapiro.test(resid(Seston_AOVmod_0914)) #  0.8013 - normal
leveneTest(Seston_AOVmod_0914) # 0.1058  - pass
pander(anova(Seston_AOVmod_0914), style='rmarkdown') # anova table of lmer
# |    &nbsp;     | Df | Sum Sq | Mean Sq | F value | Pr(>F) |
# |:-------------:|:--:|:------:|:-------:|:-------:|:------:|
# |    **pH**     | 1  | 6.324  |  6.324  |  1.862  | 0.1868 |
# | **Residuals** | 21 | 71.31  |  3.396  |   NA    |   NA   |




# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#  Plots                      ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::





CR_914_boxplot_parsed <- Master_914 %>% 
  ggplot(aes(pCO2 , CR_mL.hr.mmlength , fill = pCO2)) +
  theme(panel.grid=element_blank()) +
  geom_boxplot(size=0.2, alpha=0.1, aes(fill=pCO2)) +
  scale_fill_manual(values=c("forestgreen","orange")) +
  geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=10)) +
  stat_summary(fun.y=mean, geom="point", shape=18, size=4, color="black", fill="white") +
  ggtitle("Clearance rate, F1 Scallops 20210914") +
  facet_wrap(~type)
# CR_914_boxplot_parsed # view plot

CR_914_boxplot <- Master_914 %>% 
  ggplot(aes(pCO2 , CR_mL.hr.mmlength , fill = pCO2)) +
  theme(panel.grid=element_blank()) +
  geom_boxplot(size=0.2, alpha=0.1, aes(fill=pCO2)) +
  scale_fill_manual(values=c("forestgreen","orange")) +
  geom_point(aes(shape = type), size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
  scale_shape_manual(values=c(1, 2, 4))+
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=10)) +
  stat_summary(fun.y=mean, geom="point", shape=18, size=4, color="black", fill="white") +
  ggtitle("Clearance rate, F1 Scallops 20210914") 
# CR_914_boxplot

# Save plots :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/20210914_figs_tables/2010914_CR_Boxplots.pdf"), width = 10, height= 6)
ggarrange(CR_914_boxplot_parsed, CR_914_boxplot)
dev.off()



# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#  run test with 'type' as factor ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

# Question: under different pCO2 levels do scallops differ in overall clearnace rate and is there an interaction between pCO2 and particle?
# example, under high pCO2 bay scallops favor consuming larger cells i.e. Tetraselmis) 

LMEmod_914 <-lme(CR_mL.hr.mmlength ~ pH*type, random=~1|random_fact, data=Master_914)
# |     &nbsp;      | numDF | denDF | F-value |  p-value  |
# |:---------------:|:-----:|:-----:|:-------:|:---------:|
# | **(Intercept)** |   1   |  50   |  106.6  | 5.396e-14 |
# |     **pH**      |   1   |   6   |  3.324  |  0.1181   |
# |    **type**     |   2   |  50   |  2.315  |  0.1092   |
# |   **pH:type**   |   2   |  50   | 0.5997  |  0.5529   |
pander(anova(LMEmod_914), style='rmarkdown') # anova table of lmer
shapiro.test(residuals(LMEmod_914)) # non nomral 0.03313
hist(residuals(LMEmod_914)) # 
qqnorm(residuals(LMEmod_914)) #
# two way anova witou the random factor of tank
AOVmod_0914 <-aov(lm(CR_mL.hr.mmlength ~ pH*type, data=Master_914))
hist(resid(AOVmod_0914))
qqnorm(resid(AOVmod_0914))
shapiro.test(resid(AOVmod_0914)) #  0.04204 - non - normal
leveneTest(AOVmod_0914) # 0.4056  - pass
pander(anova(AOVmod_0914), style='rmarkdown') # anova table of lmer
# |    &nbsp;     | Df | Sum Sq | Mean Sq | F value | Pr(>F)  |
# |:-------------:|:--:|:------:|:-------:|:-------:|:-------:|
# |    **pH**     | 1  | 26.79  |  26.79  |  5.798  | 0.01937 | * significant effect of pH
# |   **type**    | 2  | 20.19  |  10.09  |  2.185  |  0.122  |
# |  **pH:type**  | 2  | 5.083  |  2.541  |  0.55   |  0.58   |
# | **Residuals** | 56 | 258.7  |  4.62   |   NA    |   NA    |
AOVmod_0914_TRANSFORMED <-aov(lm(sqrt(CR_mL.hr.mmlength) ~ pH*type, data=Master_914))
shapiro.test(resid(AOVmod_0914_TRANSFORMED)) #  0.7088 - non - normal
leveneTest(AOVmod_0914_TRANSFORMED) # 0.7599  - pass
pander(anova(AOVmod_0914_TRANSFORMED), style='rmarkdown') # anova table of lmer
# |    &nbsp;     | Df | Sum Sq | Mean Sq | F value | Pr(>F)  |
# |:-------------:|:--:|:------:|:-------:|:-------:|:-------:|
# |    **pH**     | 1  |  1.8   |   1.8   |  5.764  | 0.01971 | * still a sig effect after normality was resolved
# |   **type**    | 2  | 1.437  | 0.7183  |   2.3   | 0.1097  |
# |  **pH:type**  | 2  | 0.3052 | 0.1526  | 0.4885  | 0.6161  |
# | **Residuals** | 56 | 17.49  | 0.3124  |   NA    |   NA    |

```

```{r 20210930 CR stats, echo = T}

# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# clean & view means...       ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

df_total.930 <- df_total.930  %>% 
  dplyr::mutate(pCO2 = case_when(pH == 8.0 ~ "500 μatm", pH == 7.5 ~ "800 μatm")) %>% 
  dplyr::mutate(random_fact = as.factor(paste(Replicate, pH, Fed_Unfed, sep = '_')))


Ply_CR_930_Means <- df_total.930 %>% 
  dplyr::group_by(pCO2, Fed_Unfed) %>% 
  dplyr::filter(Ply_mL.hr.mmlength > 0) %>% # ommit negative values
  dplyr::summarise(
    meanCR = mean(Ply_mL.hr.mmlength),
    sdCR   = sd(Ply_mL.hr.mmlength), 
    seCR   = sd(Ply_mL.hr.mmlength) / sqrt(length(Ply_mL.hr.mmlength)), 
    n = n()) %>% 
    dplyr::mutate(Type = 'ply')
print(Ply_CR_930_Means)

Chaet_CR_930_Means <- df_total.930 %>% 
  dplyr::group_by(pCO2, Fed_Unfed) %>% 
  dplyr::filter(Chaet_mL.hr.mmlength > 0) %>% # ommit negative values
  dplyr::summarise(
    meanCR = mean(Chaet_mL.hr.mmlength),
    sdCR   = sd(Chaet_mL.hr.mmlength), 
    seCR   = sd(Chaet_mL.hr.mmlength) / sqrt(length(Chaet_mL.hr.mmlength)), 
    n = n()) %>% 
    dplyr::mutate(Type = 'chaet')
print(Chaet_CR_930_Means)


Seston_CR_930_Means <- df_total.930 %>% 
  dplyr::group_by(pCO2, Fed_Unfed) %>% 
  dplyr::filter(Seston_mL.hr.mmlength > 0) %>% # ommit negative values
  dplyr::summarise(
    meanCR = mean(Seston_mL.hr.mmlength),
    sdCR   = sd(Seston_mL.hr.mmlength), 
    seCR   = sd(Seston_mL.hr.mmlength) / sqrt(length(Seston_mL.hr.mmlength)), 
    n = n()) %>% 
    dplyr::mutate(Type = 'seston')
print(Seston_CR_930_Means)



CR_Means_Master_930 <- rbind(Ply_CR_930_Means, Chaet_CR_930_Means, Seston_CR_930_Means)
write.csv(CR_Means_Master_930, "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/20210930_figs_tables/Mean_CR.csv")



# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Linear mixed-effects models ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::




# Data
Ply_FR_930_df      <- df_total.930 %>% filter(Ply_mL.hr.mmlength > 0) %>% mutate(type = 'ply') %>% 
  dplyr::rename(CR_mL.hr.mmlength = Ply_mL.hr.mmlength) %>% dplyr::select(!c('Chaet_mL.hr.mmlength','Seston_mL.hr.mmlength'))
Chaet_FR_930_df    <- df_total.930 %>% filter(Chaet_mL.hr.mmlength > 0) %>% mutate(type = 'chaet') %>% 
  dplyr::rename(CR_mL.hr.mmlength = Chaet_mL.hr.mmlength) %>% dplyr::select(!c('Ply_mL.hr.mmlength','Seston_mL.hr.mmlength'))
Seston_FR_930_df   <- df_total.930 %>% filter(Seston_mL.hr.mmlength > 0) %>% mutate(type = 'seston') %>% 
  dplyr::rename(CR_mL.hr.mmlength = Seston_mL.hr.mmlength) %>% dplyr::select(!c('Chaet_mL.hr.mmlength','Ply_mL.hr.mmlength'))

# library
require(nlme)

# Ply - Linear Mixed Effects Model
Ply_LMEmod_0930 <-lme(CR_mL.hr.mmlength ~ pH*Fed_Unfed, random=~1|random_fact, data=Ply_FR_930_df)
# |      &nbsp;      | numDF | denDF | F-value  | p-value  |
# |:----------------:|:-----:|:-----:|:--------:|:--------:|
# | **(Intercept)**  |   1   |  10   |  10.95   | 0.007887 |
# |      **pH**      |   1   |   6   | 0.004046 |  0.9513  |
# |  **Fed_Unfed**   |   1   |   6   |  1.365   |  0.287   |
# | **pH:Fed_Unfed** |   1   |   6   |  0.1011  |  0.7612  |
pander(anova(Ply_LMEmod_0930), style='rmarkdown') # anova table of lmer
shapiro.test(resid(Ply_LMEmod_0930)) # 0.407
qqnorm(resid(Ply_LMEmod_0930)) # normal
kable(as.data.frame(anova(Ply_LMEmod_0930))) %>%  # print a png of this table
  kable_styling() %>%
  save_kable(file = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/20210930_figs_tables/20210930_PLY_CR_LME_Table.png", zoom = 1.5)
pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/20210930_figs_tables/20210930_PLY_CR_LME_Diagnostics.pdf"))
check_model(Ply_LMEmod_0930) # print the model diagnostics 
dev.off()




# Chaet - Linear Mixed Effects Model
Chaet_LMEmod_0930 <-lme(CR_mL.hr.mmlength ~ pH, random=~1|random_fact, data=Chaet_FR_930_df)
# |      &nbsp;      | numDF | denDF | F-value |  p-value  |
# |:----------------:|:-----:|:-----:|:-------:|:---------:|
# | **(Intercept)**  |   1   |  52   |  44.02  | 1.893e-08 |
# |      **pH**      |   1   |  12   | 0.06041 |   0.81    |
# |  **Fed_Unfed**   |   1   |  12   |  6.973  |  0.02155  | **
# | **pH:Fed_Unfed** |   1   |  12   | 0.01714 |   0.898   |
pander(anova(Chaet_LMEmod_0930), style='rmarkdown') # anova table of lmer
shapiro.test(resid(Chaet_LMEmod_0930)) # 3.877e-10 non-normal
qqnorm(resid(Chaet_LMEmod_0930)) # nonnonormal residuals
hist(resid(Chaet_LMEmod_0930)) # right skew - log should resolve normality 

Chaet_LMEmod_0930_LOG <-lme( log(CR_mL.hr.mmlength) ~ pH, random=~1|random_fact, data=Chaet_FR_930_df)
pander(anova(Chaet_LMEmod_0930_LOG), style='rmarkdown') # anova table of lmer
# |      &nbsp;      | numDF | denDF | F-value  |  p-value  |
# |:----------------:|:-----:|:-----:|:--------:|:---------:|
# | **(Intercept)**  |   1   |  52   |  75.88   | 9.753e-12 |
# |      **pH**      |   1   |  12   |  0.5087  |  0.4894   |
# |  **Fed_Unfed**   |   1   |  12   |  7.169   |  0.02013  | # did not change the statistical outcome of the LME!
# | **pH:Fed_Unfed** |   1   |  12   | 0.001205 |  0.9729   |
shapiro.test(resid(Chaet_LMEmod_0930_LOG)) # 0.1789 - now it is normal
qqnorm(resid(Chaet_LMEmod_0930_LOG)) # normal
hist(resid(Chaet_LMEmod_0930_LOG)) # normality resolved using log (no longer right skew)

kable(as.data.frame(anova(Chaet_LMEmod_0930))) %>%  # print a png of this table
  kable_styling() %>%
  save_kable(file = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/20210930_figs_tables/20210930_CHAET_CR_LME_Table.png", zoom = 1.5)
pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/20210930_figs_tables/20210930_CHAET_CR_LME_Diagnostics.pdf"))
check_model(Chaet_LMEmod_0930) # print the model diagnostics 
dev.off()




# Seston - Linear Mixed Effects Model
Seston_LMEmod_0930 <-lme(CR_mL.hr.mmlength ~ pH, random=~1|random_fact, data=Seston_FR_930_df)
# |      &nbsp;      | numDF | denDF | F-value |  p-value  |
# |:----------------:|:-----:|:-----:|:-------:|:---------:|
# | **(Intercept)**  |   1   |  34   |  33.37  | 1.682e-06 |
# |      **pH**      |   1   |  12   | 0.05125 |  0.8247   |
# |  **Fed_Unfed**   |   1   |  12   | 0.3996  |  0.5391   |
# | **pH:Fed_Unfed** |   1   |  12   |  1.247  |   0.286   |
pander(anova(Seston_LMEmod_0930), style='rmarkdown') # anova table of lmer
shapiro.test(resid(Seston_LMEmod_0930)) # 2.236e-06 non-normal
qqnorm(resid(Seston_LMEmod_0930)) # nonnonormal residuals
hist(resid(Seston_LMEmod_0930)) #right skew - log should resolve normality 

Seston_LMEmod_0930_LOG <-lme( log(CR_mL.hr.mmlength) ~ pH, random=~1|random_fact, data=Seston_FR_930_df)
pander(anova(Seston_LMEmod_0930_LOG), style='rmarkdown') # anova table of lmer
# |      &nbsp;      | numDF | denDF | F-value |  p-value  | # still no marginal  nor significant effects - normality did not change the statistical outcome of the model...
# |:----------------:|:-----:|:-----:|:-------:|:---------:|
# | **(Intercept)**  |   1   |  34   |  23.41  | 2.784e-05 |
# |      **pH**      |   1   |  12   | 0.2759  |  0.6089   |
# |  **Fed_Unfed**   |   1   |  12   | 0.6224  |  0.4455   |
# | **pH:Fed_Unfed** |   1   |  12   |  2.677  |  0.1277   |
shapiro.test(resid(Seston_LMEmod_0930_LOG)) # 0.8217 normal with log transformation
qqnorm(resid(Seston_LMEmod_0930_LOG)) # normal residuals
hist(resid(Seston_LMEmod_0930_LOG)) # normality resolved
kable(as.data.frame(anova(Seston_LMEmod_0930))) %>%  # print a png of this table
  kable_styling() %>%
  save_kable(file = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/20210930_figs_tables/20210930_SESTON_CR_LME_Table.png", zoom = 1.5)
pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/20210930_figs_tables/20210930_SESTON_CR_LME_Diagnostics.pdf"))
check_model(Seston_LMEmod_0930) # print the model diagnostics 
dev.off()




# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#  Plots                      ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::




Master_930         <- rbind(Chaet_FR_930_df, Ply_FR_930_df, Seston_FR_930_df)


CR_930_boxplot <- Master_930_plotting %>% 
  ggplot(aes(pCO2 , CR_mL.hr.mmlength , fill = pCO2)) +
  theme(panel.grid=element_blank()) +
  geom_boxplot(size=0.2, alpha=0.1, aes(fill=pCO2)) +
  scale_fill_manual(values=c("white", "grey50")) +
  geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=10)) +
  stat_summary(fun.y=mean, geom="point", shape=18, size=4, color="black", fill="white") +
  ggtitle("Clearance rate, F1 Scallops 20210930") +
  facet_wrap(~type)
CR_930_boxplot


# Save plots :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/20210930_figs_tables/2010930_CR_Boxplots.pdf"), width = 7, height= 6)
ggarrange(CR_930_boxplot)
dev.off()



# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#  run test with 'type' as factor ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

# Question: under different pCO2 levels do scallops differ in overall clearnace rate and is there an interaction between pCO2 and particle?
# example, under high pCO2 bay scallops favor consuming larger cells i.e. Tetraselmis) 

LMEmod_930 <-lme(CR_mL.hr.mmlength ~ pH*type, random=~1|random_fact, data=Master_930)
# |     &nbsp;      | numDF | denDF | F-value  |  p-value  |
# |:---------------:|:-----:|:-----:|:--------:|:---------:|
# | **(Intercept)** |   1   |  66   |  31.64   | 4.078e-07 |
# |     **pH**      |   1   |   6   | 0.003329 |  0.9559   |
# |    **type**     |   2   |  66   |   1.04   |  0.3592   |
# |   **pH:type**   |   2   |  66   |  0.2621  |  0.7702   |
# | **pH:Fed_Unfed** |   1   |  10   | 0.5351  |  0.4813   |
pander(anova(LMEmod_930), style='rmarkdown') # anova table of lmer
shapiro.test(residuals(LMEmod_930)) # non nomral 2.833e-08
hist(residuals(LMEmod_930)) # 
qqnorm(residuals(LMEmod_930)) #

```

```{r 20211026 CR stats, echo = T}

# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# clean & view means...       ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

df_total.1026 <- df_total.1026  %>% 
  dplyr::mutate(pCO2 = case_when(pH == 8.0 ~ "500 μatm", pH == 7.5 ~ "800 μatm")) %>% 
  dplyr::mutate(random_fact = as.factor(paste(Replicate, pH, Fed_Unfed, sep = '_')))
 

Ply_CR_1026_Means <- df_total.1026 %>% 
  dplyr::group_by(pCO2) %>% 
  dplyr::filter(Ply_mL.hr.mmlength > 0) %>% # ommit negative values
  dplyr::summarise(
    meanCR = mean(Ply_mL.hr.mmlength),
    sdCR   = sd(Ply_mL.hr.mmlength), 
    seCR   = sd(Ply_mL.hr.mmlength) / sqrt(length(Ply_mL.hr.mmlength)), 
    n = n()) %>% 
    dplyr::mutate(Type = 'ply')
print(Ply_CR_1026_Means)

Chaet_CR_1026_Means <- df_total.1026 %>% 
  dplyr::group_by(pCO2) %>% 
  dplyr::filter(Chaet_mL.hr.mmlength > 0) %>% # ommit negative values
  dplyr::summarise(
    meanCR = mean(Chaet_mL.hr.mmlength),
    sdCR   = sd(Chaet_mL.hr.mmlength), 
    seCR   = sd(Chaet_mL.hr.mmlength) / sqrt(length(Chaet_mL.hr.mmlength)), 
    n = n()) %>% 
    dplyr::mutate(Type = 'chaet')
print(Chaet_CR_1026_Means)


Seston_CR_1026_Means <- df_total.1026 %>% 
  dplyr::group_by(pCO2) %>% 
  dplyr::filter(Seston_mL.hr.mmlength > 0) %>% # ommit negative values
  dplyr::summarise(
    meanCR = mean(Seston_mL.hr.mmlength),
    sdCR   = sd(Seston_mL.hr.mmlength), 
    seCR   = sd(Seston_mL.hr.mmlength) / sqrt(length(Seston_mL.hr.mmlength)), 
    n = n()) %>% 
    dplyr::mutate(Type = 'seston')
print(Seston_CR_1026_Means)



CR_Means_Master_1026 <- rbind(Ply_CR_1026_Means, Chaet_CR_1026_Means, Seston_CR_1026_Means)
write.csv(CR_Means_Master_1026, "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/20211026_figs_tables/Mean_CR.csv")





# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Linear mixed-effects models ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::




# Data
Ply_FR_1026_df      <- df_total.1026 %>% filter(Ply_mL.hr.mmlength > 0) %>% mutate(type = 'ply') %>% 
  dplyr::rename(CR_mL.hr.mmlength = Ply_mL.hr.mmlength) %>% dplyr::select(!c('Chaet_mL.hr.mmlength','Seston_mL.hr.mmlength'))
Chaet_FR_1026_df    <- df_total.1026 %>% filter(Chaet_mL.hr.mmlength > 0) %>% mutate(type = 'chaet') %>% 
  dplyr::rename(CR_mL.hr.mmlength = Chaet_mL.hr.mmlength) %>% dplyr::select(!c('Ply_mL.hr.mmlength','Seston_mL.hr.mmlength'))
Seston_FR_1026_df   <- df_total.1026 %>% filter(Seston_mL.hr.mmlength > 0) %>% mutate(type = 'seston') %>% 
  dplyr::rename(CR_mL.hr.mmlength = Seston_mL.hr.mmlength) %>% dplyr::select(!c('Chaet_mL.hr.mmlength','Ply_mL.hr.mmlength'))

# library
require(nlme)

# Ply - Linear Mixed Effects Model
Ply_LMEmod_1026 <-lme(CR_mL.hr.mmlength ~ pH, random=~1|random_fact, data=Ply_FR_1026_df)
# |      &nbsp;      | numDF | denDF | F-value  |  p-value  |
# |:----------------:|:-----:|:-----:|:--------:|:---------:|
# | **(Intercept)**  |   1   |  15   |  36.13   | 2.384e-05 |
# |      **pH**      |   1   |  12   | 4.12e-07 |  0.9995   |
# |  **Fed_Unfed**   |   1   |  12   |  19.18   | 0.0008971 | ***
# | **pH:Fed_Unfed** |   1   |  12   | 0.02747  |  0.8711   |
pander(anova(Ply_LMEmod_1026), style='rmarkdown') # anova table of lmer
shapiro.test(resid(Ply_LMEmod_1026)) # 0.06153 normal!
qqnorm(resid(Ply_LMEmod_1026)) # qqnorm looks s-shaped but the residuals are normal via shapiro wilk test
hist(resid(Ply_LMEmod_1026)) # histogram
kable(as.data.frame(anova(Ply_LMEmod_1026))) %>%  # print a png of this table
  kable_styling() %>%
  save_kable(file = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/20211026_figs_tables/20211026_PLY_CR_LME_Table.png", zoom = 1.5)
pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/20211026_figs_tables/20211026_PLY_CR_LME_Diagnostics.pdf"))
check_model(Ply_LMEmod_1026) # print the model diagnostics 
dev.off()






# still need to resolve normality in the model below (chaet 1026)

# Chaet - Linear Mixed Effects Model
Chaet_LMEmod_1026 <-lme(CR_mL.hr.mmlength ~ pH, random=~1|random_fact, data=Chaet_FR_1026_df)
# |      &nbsp;      | numDF | denDF | F-value |  p-value  |
# |:----------------:|:-----:|:-----:|:-------:|:---------:|
# | **(Intercept)**  |   1   |  14   |  45.77  | 9.091e-06 |
# |      **pH**      |   1   |  10   | 0.2495  |  0.6282   |
# |  **Fed_Unfed**   |   1   |  10   |  17.84  | 0.001763  | ***
# | **pH:Fed_Unfed** |   1   |  10   | 0.5351  |  0.4813   |
pander(anova(Chaet_LMEmod_1026), style='rmarkdown') # anova table of lmer
shapiro.test(resid(Chaet_LMEmod_1026)) # 9.188e-05 non-normal residuals
qqnorm(resid(Chaet_LMEmod_1026)) # s-dhaped or left skew
hist(resid(Chaet_LMEmod_1026)) # 


kable(as.data.frame(anova(Chaet_LMEmod_1026))) %>%  # print a png of this table
  kable_styling() %>%
  save_kable(file = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/20211026_figs_tables/20211026_CHAET_CR_LME_Table.png", zoom = 1.5)
pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/20211026_figs_tables/20211026_CHAET_CR_LME_Diagnostics.pdf"))
check_model(Chaet_LMEmod_1026) # print the model diagnostics 
dev.off()



# Seston - Linear Mixed Effects Model
Seston_LMEmod_1026 <-lme(CR_mL.hr.mmlength ~ pH, random=~1|random_fact, data=Seston_FR_1026_df)
# |      &nbsp;      | numDF | denDF | F-value |  p-value  |
# |:----------------:|:-----:|:-----:|:-------:|:---------:|
# | **(Intercept)**  |   1   |  14   |  61.2   | 1.775e-06 |
# |      **pH**      |   1   |  11   |  1.138  |  0.3089   |
# |  **Fed_Unfed**   |   1   |  11   |  19.33  | 0.001068  |
# | **pH:Fed_Unfed** |   1   |  11   |  2.006  |  0.1843   |
pander(anova(Seston_LMEmod_1026), style='rmarkdown') # anova table of lmer
shapiro.test(resid(Seston_LMEmod_1026)) #0.1157 normal residuals
qqnorm(resid(Seston_LMEmod_1026)) # normal
hist(resid(Seston_LMEmod_1026)) #  normal
kable(as.data.frame(anova(Seston_LMEmod_1026))) %>%  # print a png of this table
  kable_styling() %>%
  save_kable(file = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/20211026_figs_tables/20211026_SESTON_CR_LME_Table.png", zoom = 1.5)
pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/20211026_figs_tables/20211026_SESTON_CR_LME_Diagnostics.pdf"))
check_model(Seston_LMEmod_1026) # print the model diagnostics 
dev.off()




# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#  Plots                      ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::




Master_1026         <- rbind(Chaet_FR_1026_df, Ply_FR_1026_df, Seston_FR_1026_df)
CR_1026_boxplot <- Master_1026 %>% 
  ggplot(aes(pCO2 , CR_mL.hr.mmlength , fill = pCO2)) +
  theme(panel.grid=element_blank()) +
  geom_boxplot(size=0.2, alpha=0.1, aes(fill=pCO2)) +
  scale_fill_manual(values=c("white","grey50")) +
  geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=10)) +
  stat_summary(fun.y=mean, geom="point", shape=18, size=4, color="black", fill="white") +
  ggtitle("Clearance rate, F1 Scallops 20211026") +
  facet_wrap(~type)
CR_1026_boxplot



# Save plots :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/20211026_figs_tables/2011026_CR_Boxplots.pdf"), width = 7, height= 6)
ggarrange(CR_1026_boxplot)
dev.off()



# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#  run test with 'type' as factor ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

# Question: under different pCO2 levels do scallops differ in overall clearnace rate and is there an interaction between pCO2 and particle?
# example, under high pCO2 bay scallops favor consuming larger cells i.e. Tetraselmis) 

LMEmod_1026 <-lme(CR_mL.hr.mmlength ~ pH*type, random=~1|random_fact, data=Master_1026)
# |     &nbsp;      | numDF | denDF | F-value |  p-value  |
# |:---------------:|:-----:|:-----:|:-------:|:---------:|
# | **(Intercept)** |   1   |  41   |  74.21  | 9.646e-11 |
# |     **pH**      |   1   |   6   | 0.5171  |  0.4991   |
# |    **type**     |   2   |  41   |  13.61  | 2.931e-05 |
# |   **pH:type**   |   2   |  41   | 0.07564 |  0.9273   |
# | **pH:Fed_Unfed** |   1   |  10   | 0.5351  |  0.4813   |
pander(anova(LMEmod_1026), style='rmarkdown') # anova table of lmer
shapiro.test(residuals(LMEmod_1026)) # non nomral 0.001412
hist(residuals(LMEmod_1026)) # non nomral 0.001412
qqnorm(residuals(LMEmod_1026)) # non nomral 0.001412


```

```{r 20210202 CR stats, echo = T}

# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# clean & view means...       ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

df_total.0202 <- df_total.0202  %>% 
  dplyr::mutate(pCO2 = case_when(pH == 8.0 ~ "500 μatm", pH == 7.5 ~ "800 μatm")) %>% 
  dplyr::mutate(random_fact = as.factor(paste(Replicate, pH, Fed_Unfed, sep = '_')))
 

Ply_CR_0202_Means <- df_total.0202 %>% 
  dplyr::group_by(pCO2) %>% 
  dplyr::filter(Ply_mL.hr.mmlength > 0) %>% # ommit negative values
  dplyr::summarise(
    meanCR = mean(Ply_mL.hr.mmlength),
    sdCR   = sd(Ply_mL.hr.mmlength), 
    seCR   = sd(Ply_mL.hr.mmlength) / sqrt(length(Ply_mL.hr.mmlength)), 
    n = n()) %>% 
    dplyr::mutate(Type = 'ply')
print(Ply_CR_0202_Means)

Chaet_CR_0202_Means <- df_total.0202 %>% 
  dplyr::group_by(pCO2) %>% 
  dplyr::filter(Chaet_mL.hr.mmlength > 0) %>% # ommit negative values
  dplyr::summarise(
    meanCR = mean(Chaet_mL.hr.mmlength),
    sdCR   = sd(Chaet_mL.hr.mmlength), 
    seCR   = sd(Chaet_mL.hr.mmlength) / sqrt(length(Chaet_mL.hr.mmlength)), 
    n = n()) %>% 
    dplyr::mutate(Type = 'chaet')
print(Chaet_CR_0202_Means)


Seston_CR_0202_Means <- df_total.0202 %>% 
  dplyr::group_by(pCO2) %>% 
  dplyr::filter(Seston_mL.hr.mmlength > 0) %>% # ommit negative values
  dplyr::summarise(
    meanCR = mean(Seston_mL.hr.mmlength),
    sdCR   = sd(Seston_mL.hr.mmlength), 
    seCR   = sd(Seston_mL.hr.mmlength) / sqrt(length(Seston_mL.hr.mmlength)), 
    n = n()) %>% 
    dplyr::mutate(Type = 'seston')
print(Seston_CR_0202_Means)



CR_Means_Master_0202 <- rbind(Ply_CR_0202_Means, Chaet_CR_0202_Means, Seston_CR_0202_Means)
write.csv(CR_Means_Master_0202, "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/20220202_figs_tables/Mean_CR.csv")





# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Linear mixed-effects models ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::




# Data
Ply_FR_0202_df      <- df_total.0202 %>% filter(Ply_mL.hr.mmlength > 0) %>% mutate(type = 'ply') %>% 
  dplyr::rename(CR_mL.hr.mmlength = Ply_mL.hr.mmlength) %>% dplyr::select(!c('Chaet_mL.hr.mmlength','Seston_mL.hr.mmlength'))
Chaet_FR_0202_df    <- df_total.0202 %>% filter(Chaet_mL.hr.mmlength > 0) %>% mutate(type = 'chaet') %>% 
  dplyr::rename(CR_mL.hr.mmlength = Chaet_mL.hr.mmlength) %>% dplyr::select(!c('Ply_mL.hr.mmlength','Seston_mL.hr.mmlength'))
Seston_FR_0202_df   <- df_total.0202 %>% filter(Seston_mL.hr.mmlength > 0) %>% mutate(type = 'seston') %>% 
  dplyr::rename(CR_mL.hr.mmlength = Seston_mL.hr.mmlength) %>% dplyr::select(!c('Chaet_mL.hr.mmlength','Ply_mL.hr.mmlength'))

# library
require(nlme)

# Ply - Linear Mixed Effects Model
Ply_LMEmod_0202 <-lme(CR_mL.hr.mmlength ~ pH, random=~1|random_fact, data=Ply_FR_0202_df)
# |     &nbsp;      | numDF | denDF | F-value |  p-value  |
# |:---------------:|:-----:|:-----:|:-------:|:---------:|
# | **(Intercept)** |   1   |  12   |   132   | 7.857e-08 |
# |     **pH**      |   1   |  12   |  0.599  |  0.4539   |
# | **pH:Fed_Unfed** |   1   |  12   | 0.02747  |  0.8711   |
pander(anova(Ply_LMEmod_0202), style='rmarkdown') # anova table of lmer
shapiro.test(resid(Ply_LMEmod_0202)) # 0.2152 normal!
qqnorm(resid(Ply_LMEmod_0202)) # 
hist(resid(Ply_LMEmod_0202)) # histogram
kable(as.data.frame(anova(Ply_LMEmod_0202))) %>%  # print a png of this table
  kable_styling() %>%
  save_kable(file = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/20220202_figs_tables/20220202_PLY_CR_LME_Table.png", zoom = 1.5)
pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/20220202_figs_tables/20220202_PLY_CR_LME_Diagnostics.pdf"))
check_model(Ply_LMEmod_0202) # print the model diagnostics 
dev.off()






# still need to resolve normality in the model below (chaet 0202)

# Chaet - Linear Mixed Effects Model
Chaet_LMEmod_0202 <-lme(CR_mL.hr.mmlength ~ pH, random=~1|random_fact, data=Chaet_FR_0202_df)
# |     &nbsp;      | numDF | denDF | F-value |  p-value  |
# |:---------------:|:-----:|:-----:|:-------:|:---------:|
# | **(Intercept)** |   1   |  12   |  74.97  | 1.658e-06 |
# |     **pH**      |   1   |  12   | 0.8014  |  0.3883   |
pander(anova(Chaet_LMEmod_0202), style='rmarkdown') # anova table of lmer
shapiro.test(resid(Chaet_LMEmod_0202)) # 0.4727
qqnorm(resid(Chaet_LMEmod_0202)) #
hist(resid(Chaet_LMEmod_0202)) # 


kable(as.data.frame(anova(Chaet_LMEmod_0202))) %>%  # print a png of this table
  kable_styling() %>%
  save_kable(file = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/20220202_figs_tables/20220202_CHAET_CR_LME_Table.png", zoom = 1.5)
pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/20220202_figs_tables/20220202_CHAET_CR_LME_Diagnostics.pdf"))
check_model(Chaet_LMEmod_0202) # print the model diagnostics 
dev.off()



# Seston - Linear Mixed Effects Model
Seston_LMEmod_0202 <-lme(CR_mL.hr.mmlength ~ pH, random=~1|random_fact, data=Seston_FR_0202_df)
# |     &nbsp;      | numDF | denDF | F-value |  p-value  |
# |:---------------:|:-----:|:-----:|:-------:|:---------:|
# | **(Intercept)** |   1   |  12   |  133.1  | 7.483e-08 |
# |     **pH**      |   1   |  12   |  12.42  | 0.004188  |
pander(anova(Seston_LMEmod_0202), style='rmarkdown') # anova table of lmer
shapiro.test(resid(Seston_LMEmod_0202)) # 0.6871
qqnorm(resid(Seston_LMEmod_0202)) # normal
hist(resid(Seston_LMEmod_0202)) #  normal
kable(as.data.frame(anova(Seston_LMEmod_0202))) %>%  # print a png of this table
  kable_styling() %>%
  save_kable(file = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/20220202_figs_tables/20220202_SESTON_CR_LME_Table.png", zoom = 1.5)
pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/20220202_figs_tables/20220202_SESTON_CR_LME_Diagnostics.pdf"))
check_model(Seston_LMEmod_0202) # print the model diagnostics 
dev.off()




# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#  Plots                      ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::




Master_0202         <- rbind(Chaet_FR_0202_df, Ply_FR_0202_df, Seston_FR_0202_df)

CR_0202_boxplot <- Master_0202 %>% 
  ggplot(aes(pCO2 , CR_mL.hr.mmlength , fill = pCO2)) +
  theme(panel.grid=element_blank()) +
  geom_boxplot(size=0.2, alpha=0.1, aes(fill=pCO2)) +
  scale_fill_manual(values=c("white","grey50")) +
  geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=10)) +
  stat_summary(fun.y=mean, geom="point", shape=18, size=4, color="black", fill="white") +
  ggtitle("Clearance rate, F1 Scallops 20220202") +
  facet_wrap(~type)
CR_0202_boxplot



# Save plots :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/20220202_figs_tables/20220202_CR_Boxplots.pdf"), width = 7, height= 6)
ggarrange(CR_0202_boxplot)
dev.off()



# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#  run test with 'type' as factor ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

# Question: under different pCO2 levels do scallops differ in overall clearnace rate and is there an interaction between pCO2 and particle?
# example, under high pCO2 bay scallops favor consuming larger cells i.e. Tetraselmis) 

LMEmod_0202 <-lme(CR_mL.hr.mmlength ~ pH*type, random=~1|random_fact, data=Master_0202)
# |     &nbsp;      | numDF | denDF | F-value |  p-value  |
# |:---------------:|:-----:|:-----:|:-------:|:---------:|
# | **(Intercept)** |   1   |  36   |   155   | 1.31e-14  |
# |     **pH**      |   1   |  12   |  3.97   |  0.06958  |
# |    **type**     |   2   |  36   |  17.06  | 6.149e-06 |
# |   **pH:type**   |   2   |  36   | 0.2653  |  0.7685   |
# | **pH:Fed_Unfed** |   1   |  10   | 0.5351  |  0.4813   |
pander(anova(LMEmod_0202), style='rmarkdown') # anova table of lmer
shapiro.test(residuals(LMEmod_0202)) # 0.5814
hist(residuals(LMEmod_0202)) # 
qqnorm(residuals(LMEmod_0202)) # \


```

```{r consolidate all master boxplots}

pdf(paste0("C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/Master_CR_Boxplots.pdf"), width = 13, height= 8)

ggarrange(
CR_930_boxplot,
CR_914_boxplot,
CR_1026_boxplot,
CR_0202_boxplot)

dev.off()
```

## Density plots

```{r, 20210930 Density plots }
library(dplyr)
library(tidyr)

CHAET  <- Master_930 %>% dplyr::filter(type %in% 'chaet')
PLY    <- Master_930 %>% dplyr::filter(type %in% 'ply')
SESTON <- Master_930 %>% dplyr::filter(type %in% 'seston')



# :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Chaetoceros                  ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

df_mean_CHAET <- CHAET %>%
  dplyr::group_by(pCO2) %>% 
  dplyr::summarize(average = mean(CR_mL.hr.mmlength)) %>%
  dplyr::ungroup()
p.box_CHAET <- ggplot(CHAET, aes(x = pCO2, y = CR_mL.hr.mmlength)) + geom_boxplot() + geom_point(data= df_mean_CHAET, mapping = aes(x = pCO2, y = average),
             color="red") 
p.box.data.CHAET <- layer_data(p.box_CHAET) %>%
  select(x, ymin, lower, middle, upper, ymax, outliers, flipped_aes) %>%
  dplyr::rename(mean = flipped_aes) %>% 
  dplyr::mutate(mean  = df_mean_CHAET$average) %>% 
  mutate(pCO2 = factor(x, labels = levels(as.factor(CHAET$pCO2)), ordered = TRUE)) %>%
  select(-x)

p.box.data.CHAET %>% unnest(outliers)


density.plot_CR_CHAET_930 <-ggplot(p.box.data.CHAET) +
                                # manually plot flipped boxplot
                                geom_segment(aes(x = ymin, xend = ymax, y = -0.15, yend = -0.15)) +
                                geom_rect(aes(xmin = lower, xmax = upper, ymin = -0.3, ymax = 0,  fill = pCO2),color = "black") +
                                geom_point(data = . %>% unnest(outliers), aes(x = outliers, y = -0.15), color = "grey60", size = 1) +
                                # vertical lines at Q1 / Q2 / Q3
                                geom_vline(data = . %>% select(pCO2, lower, mean, upper) %>% gather(key, value, -pCO2), aes(xintercept = value)) +
                                # density plot
                                geom_density(data = CHAET, aes(x = CR_mL.hr.mmlength, group=pCO2, fill=pCO2, ..scaled..), alpha=.4, adjust=1.5) +
                                #  theme
                                theme_classic() +
                                facet_grid(pCO2 ~ .) +
                                theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "none", plot.title = element_text(size=10))+
                                labs(title = "F1 Scallops: Clearance rates (Chaetoceros) 92 DPF", 
                                     x = expression(Clearance~rate~"("~Chaetoceros~cells~mL^{-1}%.%~mm~shell~length^{-1}%.%hr^{-1}~")"),
                                     y = "Scaled density") +
                                scale_fill_manual(values=c("grey40", "grey85"))
density.plot_CR_CHAET_930

pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/20210930_figs_tables/20210930_CR_CHAET_density_plot.pdf"), width = 5, height = 5)
density.plot_CR_CHAET_930 # print the model diagnostics 
dev.off()


# :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Tetraselmis (Ply)                  ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::


df_mean_PLY <- PLY %>%
  dplyr::group_by(pHxfood) %>% 
  dplyr::summarize(average = mean(CR_mL.hr.mmlength)) %>%
  dplyr::ungroup()
p.box_PLY <- ggplot(PLY, aes(x = pHxfood, y = CR_mL.hr.mmlength)) + geom_boxplot() + geom_point(data= df_mean_PLY, mapping = aes(x = pHxfood, y = average),
             color="red") 
p.box.data.PLY <- layer_data(p.box_PLY) %>%
  select(x, ymin, lower, middle, upper, ymax, outliers, flipped_aes) %>%
  dplyr::rename(mean = flipped_aes) %>% 
  dplyr::mutate(mean  = df_mean_PLY$average) %>% 
  mutate(pHxfood = factor(x, labels = levels(PLY$pHxfood), ordered = TRUE)) %>%
  select(-x)

p.box.data.PLY %>% unnest(outliers)


density.plot_CR_PLY_930 <-ggplot(p.box.data.PLY) +
                                # manually plot flipped boxplot
                                geom_segment(aes(x = ymin, xend = ymax, y = -0.15, yend = -0.15)) +
                                geom_rect(aes(xmin = lower, xmax = upper, ymin = -0.3, ymax = 0,  fill = pHxfood),color = "black") +
                                geom_point(data = . %>% unnest(outliers), aes(x = outliers, y = -0.15), color = "grey60", size = 1) +
                                # vertical lines at Q1 / Q2 / Q3
                                geom_vline(data = . %>% select(pHxfood, lower, mean, upper) %>% gather(key, value, -pHxfood), aes(xintercept = value)) +
                                # density plot
                                geom_density(data = PLY, aes(x = CR_mL.hr.mmlength, group=pHxfood, fill=pHxfood, ..scaled..), alpha=.4, adjust=1.5) +
                                #  theme
                                theme_classic() +
                                facet_grid(pHxfood ~ .) +
                                theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "none", plot.title = element_text(size=10))+
                                labs(title = "F1 Scallops: Clearance rates (Tetraselmis/PLY) 92 DPF", 
                                     x = expression(Clearance~rate~"("~Tetraselmis~cells~mL^{-1}%.%~mm~shell~length^{-1}%.%hr^{-1}~")"),
                                     y = "Scaled density") +
                                scale_fill_manual(values=c("grey40", "grey85"))
density.plot_CR_PLY_930

pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/20210930_figs_tables/20210930_CR_PLY_density_plot.pdf"), width = 5, height = 5)
density.plot_CR_PLY_930 # print the model diagnostics 
dev.off()

# :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Seston                             ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::


df_mean_SESTON <- SESTON %>%
  dplyr::group_by(pHxfood) %>% 
  dplyr::summarize(average = mean(CR_mL.hr.mmlength)) %>%
  dplyr::ungroup()
p.box_SESTON <- ggplot(SESTON, aes(x = pHxfood, y = CR_mL.hr.mmlength)) + geom_boxplot() + geom_point(data= df_mean_SESTON, mapping = aes(x = pHxfood, y = average),
             color="red") 
p.box.data.SESTON <- layer_data(p.box_SESTON) %>%
  select(x, ymin, lower, middle, upper, ymax, outliers, flipped_aes) %>%
  dplyr::rename(mean = flipped_aes) %>% 
  dplyr::mutate(mean  = df_mean_SESTON$average) %>% 
  mutate(pHxfood = factor(x, labels = levels(SESTON$pHxfood), ordered = TRUE)) %>%
  select(-x)

p.box.data.SESTON %>% unnest(outliers)


density.plot_CR_SESTON_0930 <-ggplot(p.box.data.SESTON) +
                                # manually plot flipped boxplot
                                geom_segment(aes(x = ymin, xend = ymax, y = -0.15, yend = -0.15)) +
                                geom_rect(aes(xmin = lower, xmax = upper, ymin = -0.3, ymax = 0,  fill = pHxfood),color = "black") +
                                geom_point(data = . %>% unnest(outliers), aes(x = outliers, y = -0.15), color = "grey60", size = 1) +
                                # vertical lines at Q1 / Q2 / Q3
                                geom_vline(data = . %>% select(pHxfood, lower, mean, upper) %>% gather(key, value, -pHxfood), aes(xintercept = value)) +
                                # density plot
                                geom_density(data = SESTON, aes(x = CR_mL.hr.mmlength, group=pHxfood, fill=pHxfood, ..scaled..), alpha=.4, adjust=1.5) +
                                #  theme
                                theme_classic() +
                                facet_grid(pHxfood ~ .) +
                                theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "none", plot.title = element_text(size=10))+
                                labs(title = "F1 Scallops: Clearance rates (seston) 92 DPF", 
                                     x = expression(Clearance~rate~"("~SESTONoceros~cells~mL^{-1}%.%~mm~shell~length^{-1}%.%hr^{-1}~")"),
                                     y = "Scaled density") +
                                scale_fill_manual(values=c("grey40", "grey40", "grey85", "grey85"))
density.plot_CR_SESTON_0930

pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/20210930_figs_tables/20210930_CR_SESTON_density_plot.pdf"), width = 5, height = 5)
density.plot_CR_SESTON_0930 # print the model diagnostics 
dev.off()

```

```{r, 20211026 Density plots }
library(dplyr)
library(tidyr)

Master_1026$pHxfood <- as.factor(Master_1026$pHxfood)
CHAET <- Master_1026 %>% dplyr::filter(type %in% 'chaet')
PLY <- Master_1026 %>% dplyr::filter(type %in% 'ply')
SESTON <- Master_1026 %>% dplyr::filter(type %in% 'seston')



# :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Chaetoceros                  ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

df_mean_CHAET <- CHAET %>%
  dplyr::group_by(pHxfood) %>% 
  dplyr::summarize(average = mean(CR_mL.hr.mmlength)) %>%
  dplyr::ungroup()
p.box_CHAET <- ggplot(CHAET, aes(x = pHxfood, y = CR_mL.hr.mmlength)) + geom_boxplot() + geom_point(data= df_mean_CHAET, mapping = aes(x = pHxfood, y = average),
             color="red") 
p.box.data.CHAET <- layer_data(p.box_CHAET) %>%
  select(x, ymin, lower, middle, upper, ymax, outliers, flipped_aes) %>%
  dplyr::rename(mean = flipped_aes) %>% 
  dplyr::mutate(mean  = df_mean_CHAET$average) %>% 
  mutate(pHxfood = factor(x, labels = levels(CHAET$pHxfood), ordered = TRUE)) %>%
  select(-x)

p.box.data.CHAET %>% unnest(outliers)


density.plot_CR_CHAET_1026 <-ggplot(p.box.data.CHAET) +
                                # manually plot flipped boxplot
                                geom_segment(aes(x = ymin, xend = ymax, y = -0.15, yend = -0.15)) +
                                geom_rect(aes(xmin = lower, xmax = upper, ymin = -0.3, ymax = 0,  fill = pHxfood),color = "black") +
                                geom_point(data = . %>% unnest(outliers), aes(x = outliers, y = -0.15), color = "grey60", size = 1) +
                                # vertical lines at Q1 / Q2 / Q3
                                geom_vline(data = . %>% select(pHxfood, lower, mean, upper) %>% gather(key, value, -pHxfood), aes(xintercept = value)) +
                                # density plot
                                geom_density(data = CHAET, aes(x = CR_mL.hr.mmlength, group=pHxfood, fill=pHxfood, ..scaled..), alpha=.4, adjust=1.5) +
                                #  theme
                                theme_classic() +
                                facet_grid(pHxfood ~ .) +
                                theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "none", plot.title = element_text(size=10))+
                                labs(title = "F1 Scallops: Clearance rates (Chaetoceros) 92 DPF", 
                                     x = expression(Clearance~rate~"("~Chaetoceros~cells~mL^{-1}%.%~mm~shell~length^{-1}%.%hr^{-1}~")"),
                                     y = "Scaled density") +
                                scale_fill_manual(values=c("grey40", "grey40", "grey85", "grey85"))
density.plot_CR_CHAET_1026

pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/20211026_figs_tables/20211026_CR_CHAET_density_plot.pdf"), width = 5, height = 5)
density.plot_CR_CHAET_1026 # print the model diagnostics 
dev.off()


# :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Tetraselmis (Ply)                  ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::


df_mean_PLY <- PLY %>%
  dplyr::group_by(pHxfood) %>% 
  dplyr::summarize(average = mean(CR_mL.hr.mmlength)) %>%
  dplyr::ungroup()
p.box_PLY <- ggplot(PLY, aes(x = pHxfood, y = CR_mL.hr.mmlength)) + geom_boxplot() + geom_point(data= df_mean_PLY, mapping = aes(x = pHxfood, y = average),
             color="red") 
p.box.data.PLY <- layer_data(p.box_PLY) %>%
  select(x, ymin, lower, middle, upper, ymax, outliers, flipped_aes) %>%
  dplyr::rename(mean = flipped_aes) %>% 
  dplyr::mutate(mean  = df_mean_PLY$average) %>% 
  mutate(pHxfood = factor(x, labels = levels(PLY$pHxfood), ordered = TRUE)) %>%
  select(-x)

p.box.data.PLY %>% unnest(outliers)


density.plot_CR_PLY_1026 <-ggplot(p.box.data.PLY) +
                                # manually plot flipped boxplot
                                geom_segment(aes(x = ymin, xend = ymax, y = -0.15, yend = -0.15)) +
                                geom_rect(aes(xmin = lower, xmax = upper, ymin = -0.3, ymax = 0,  fill = pHxfood),color = "black") +
                                geom_point(data = . %>% unnest(outliers), aes(x = outliers, y = -0.15), color = "grey60", size = 1) +
                                # vertical lines at Q1 / Q2 / Q3
                                geom_vline(data = . %>% select(pHxfood, lower, mean, upper) %>% gather(key, value, -pHxfood), aes(xintercept = value)) +
                                # density plot
                                geom_density(data = PLY, aes(x = CR_mL.hr.mmlength, group=pHxfood, fill=pHxfood, ..scaled..), alpha=.4, adjust=1.5) +
                                #  theme
                                theme_classic() +
                                facet_grid(pHxfood ~ .) +
                                theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "none", plot.title = element_text(size=10))+
                                labs(title = "F1 Scallops: Clearance rates (Tetraselmis/PLY) 92 DPF", 
                                     x = expression(Clearance~rate~"("~Tetraselmis~cells~mL^{-1}%.%~mm~shell~length^{-1}%.%hr^{-1}~")"),
                                     y = "Scaled density") +
                                scale_fill_manual(values=c("grey40", "grey40", "grey85", "grey85"))
density.plot_CR_PLY_1026

pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/20211026_figs_tables/20211026_CR_PLY_density_plot.pdf"), width = 5, height = 5)
density.plot_CR_PLY_1026 # print the model diagnostics 
dev.off()

# :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Seston                             ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::


df_mean_SESTON <- SESTON %>%
  dplyr::group_by(pHxfood) %>% 
  dplyr::summarize(average = mean(CR_mL.hr.mmlength)) %>%
  dplyr::ungroup()
p.box_SESTON <- ggplot(SESTON, aes(x = pHxfood, y = CR_mL.hr.mmlength)) + geom_boxplot() + geom_point(data= df_mean_SESTON, mapping = aes(x = pHxfood, y = average),
             color="red") 
p.box.data.SESTON <- layer_data(p.box_SESTON) %>%
  select(x, ymin, lower, middle, upper, ymax, outliers, flipped_aes) %>%
  dplyr::rename(mean = flipped_aes) %>% 
  dplyr::mutate(mean  = df_mean_SESTON$average) %>% 
  mutate(pHxfood = factor(x, labels = levels(SESTON$pHxfood), ordered = TRUE)) %>%
  select(-x)

p.box.data.SESTON %>% unnest(outliers)


density.plot_CR_SESTON_1026 <-ggplot(p.box.data.SESTON) +
                                # manually plot flipped boxplot
                                geom_segment(aes(x = ymin, xend = ymax, y = -0.15, yend = -0.15)) +
                                geom_rect(aes(xmin = lower, xmax = upper, ymin = -0.3, ymax = 0,  fill = pHxfood),color = "black") +
                                geom_point(data = . %>% unnest(outliers), aes(x = outliers, y = -0.15), color = "grey60", size = 1) +
                                # vertical lines at Q1 / Q2 / Q3
                                geom_vline(data = . %>% select(pHxfood, lower, mean, upper) %>% gather(key, value, -pHxfood), aes(xintercept = value)) +
                                # density plot
                                geom_density(data = SESTON, aes(x = CR_mL.hr.mmlength, group=pHxfood, fill=pHxfood, ..scaled..), alpha=.4, adjust=1.5) +
                                #  theme
                                theme_classic() +
                                facet_grid(pHxfood ~ .) +
                                theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "none", plot.title = element_text(size=10))+
                                labs(title = "F1 Scallops: Clearance rates (seston) 92 DPF", 
                                     x = expression(Clearance~rate~"("~SESTONoceros~cells~mL^{-1}%.%~mm~shell~length^{-1}%.%hr^{-1}~")"),
                                     y = "Scaled density") +
                                scale_fill_manual(values=c("grey40", "grey40", "grey85", "grey85"))
density.plot_CR_SESTON_1026

pdf(paste0(filename = "C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/ClearanceRates/20211026_figs_tables/20211026_CR_SESTON_density_plot.pdf"), width = 5, height = 5)
density.plot_CR_SESTON_1026 # print the model diagnostics 
dev.off()

```