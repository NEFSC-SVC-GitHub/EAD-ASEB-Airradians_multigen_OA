---
title: "F2_Scope_for_growth"
author: "Samuel Gurr"
date: "2023-03-18"
output: html_document
---

# F2s: scope for growth

-   **objective**: to merge all data for F2s in which standard metabolic rates (resp), excretion rates, and biodeposition were completed **on the same individual(s)!**

    -   Create 'F2_Master' file: merge together respiration, excretion and biodepsotion data by a unique identifier for the individual

        -   i.e. date \* pH_treatment \* replicate tank \* dry tissue weight (mg)

        -   Note! master file data are limited by the biodeposition runs - there's pleeenty of data for respiration and excretion in which biodeposition *was not* completed

        -   these 'master' data use allometric scaling (b factor and mean correction) via **tissue dry weight** since *all* individuals used for biodeposition were large enough to separate tissue from shell for drying

            -   important to state because the cumulative respiration and excretion data (both including individuals with and without biodeposition runs) is corrected via **shell length** applicable to all life stages, like those too small/fragile to obtatin accurate estimation of dry tissue

    -   Calculate scope for growth

    -   Plot data

    -   Run statistics

    -   (*Optional*) Adjust plots to emphasize significant effect(s)

### load packages and set directory for this markdown file

```{r setup}

library(devtools) # devtools::install_github # use devtools to instlal github link
library(LoLinR) # install_github('colin-olito/LoLinR') # install LoLinR from github
library(dplyr)
library(lubridate)
library(rMR) 
library(dplyr)
library(stringr)
library(rlang)
library(ggplot2)
library(ggfortify)
library(DESeq2)
library(devtools)
library(ggbiplot)
library(VennDiagram)# venn diagrams
library(eulerr) #venn diagrams -  check out the R shiny app (http://eulerr.co/) 

# set wd
knitr::opts_knit$set(root.dir = 'C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis')
getwd()

```

# (1) Create 'F2 Master' file

## Load biodeposition, respiration, and excretion data

```{r}

Biodeposition    <- read.csv("Output/Biodeposition/Biodeposition_master_F2.csv", header = T)

RespirationRates <- read.csv(file="Output/Respiration/F2_RR_calc_master.csv", header=T)

ExcretionRates   <- read.csv(file="Output/ExcretionRates/F2/F2_ExcretionRates_master.csv", header=T) 
```

## Add minor adjustments to these files to assist merging

-   importantly, we adjust the excretion data for b factor normalization below, other datasets are already prepped with this correction
-   Note: : biodep does not have the columns to merge by including the Run, Vhamber_Tank, Replicate, etc. However... we can merge by the equal length and tissue dry weight in the RR dataset below! first we need to reformat a few things here
-   b factor TDW from use of all data in both F1 and F2
-   TDW correction to 1 g TDW (as opposed to a mean or median within the dataset)
    -   biodeposition.R and RR_calc scripts contain this correction, excretion corrects in the chunk below

```{r}

# biodep
Biodeposition_adj    <- Biodeposition %>% 
                          dplyr::select(-c(X, tank_ID.y)) %>% 
                          dplyr::rename(tank_ID = tank_ID.x) %>% 
                          dplyr::mutate(Date = format(strptime(Date, format = "%Y%m%d"), "%m/%d/%Y")) %>% # format to mm/dd/yyy as RR dataset
                          dplyr::mutate(Replicate = gsub("[^a-zA-Z]", "", tank_ID)) %>% # new replicate column - reflects RR dataset 
                          dplyr::rename(Dry_Tissue_weight = animal_dry_weight_g) %>% # change name to match RR
                          dplyr::rename(Length_mm = animal_length_mm) %>% # change name to match RR
                          dplyr::rename(pH = treatment) %>% # rename to match 
                          dplyr::select(-c(tank_ID, animal_number, initial_filter_weight_mg, dry_filter_weight_mg,ash_filter_weight_mg, inclubation_time_hours)) %>% 
                          dplyr::mutate(Date = case_when(Date == "02/01/2023" ~ '1/31/2023',
                                                         Date == "02/24/2023" ~ '2/23/2023',
                                                         Date == "03/28/2023" ~ '3/27/2023')) %>% 
                          dplyr::select(-Length_mm) # lenngth is the exact same as the resp and Excretion data except diff sig figs and some missing
nrow(Biodeposition_adj) # nrow 61

# RR
RespirationRates_adj <- RespirationRates %>% 
                          dplyr::filter(Date %in% c('1/31/2023','2/23/2023', '3/27/2023')) %>% # , '3/27/2023'
                          dplyr::mutate(Replicate = 
                                        gsub("[^a-zA-Z]", "", Chamber_tank)) %>% # new replicate column - reflects RR dataset 
                          dplyr::select(c(Date, 
                                          Age,  
                                          pH, 
                                          pCO2,
                                          Replicate,
                                          Length_mm, 
                                          Dry_Tissue_weight,
                                          resp_umol_hr_bFactorNormTDW.1g)) %>% 
                          dplyr::rename(RR_resp_umol_hr_bfactorTDW = 
                                          resp_umol_hr_bFactorNormTDW.1g) 
RespirationRates_adj$Dry_Tissue_weight <- as.numeric(RespirationRates_adj$Dry_Tissue_weight)                     
nrow(RespirationRates_adj) # 63

# ER
# note - we will bfctor and mean corret for TDW)
bTDW    <- 1.07 # FR_bfactor script using ALL F1 and F2 data!

ExcretionRates_adj  <- ExcretionRates  %>% 
                          dplyr::mutate(Date = format(strptime(Date, format = "%Y%m%d"), "%m/%d/%Y")) %>% # format to mm/dd/yyy as RR dataset
                          dplyr::mutate(Date = case_when(Date == "01/31/2023" ~ '1/31/2023',
                                                         Date == "02/23/2023" ~ '2/23/2023',
                                                         Date == "03/27/2023" ~ '3/27/2023',)) %>% 
                          dplyr::mutate(ExcretionRate_mg_hr = ExcretionRate_ug_mL_hr/1000) %>% 
                          dplyr::rename(ExcretionRate_umol_hr = ExcretionRate_umol_mL_hr) %>% 
  
                          dplyr::mutate(ExcretionRate_mg_hr_bFactorNormTDW = 
                                          (ExcretionRate_mg_hr)*((1/Dry_Tissue_weight)^bTDW)) %>% # TDW b factor - mg
                          
                          dplyr::mutate(ExcretionRate_umol_hr_bFactorNormTDW = 
                                          (ExcretionRate_umol_hr)*((1/Dry_Tissue_weight)^bTDW)) %>% # TDW b factor - umol
                          dplyr::mutate(Length_mm = as.numeric(Length_um / 1000)) %>% # Length_mm matched biodep and RR 
                          dplyr::select(c(Date, 
                                          pH, 
                                          Replicate, 
                                          Chamber_tank,
                                          Length_um,
                                          Dry_Tissue_weight,
                                          ExcretionRate_mg_hr_bFactorNormTDW,
                                          ExcretionRate_umol_hr_bFactorNormTDW))
# sanity check before we merge
nrow(ExcretionRates_adj)          == (nrow(RespirationRates_adj)  + nrow(Biodeposition_adj)) / 2 # FLASE becuase there were 2 outliers removed for biodep
unique(ExcretionRates_adj$Date)   == unique(RespirationRates_adj$Date) # should be TRUE
unique(RespirationRates_adj$Date) ==  unique(Biodeposition_adj$Date)  # should be TRUE
```

### Unique identifier

-   Date \* pH \* dry tissue weight

```{r}

Biodeposition_adj$uniqueID <- paste(Biodeposition_adj$Date,
                                 Biodeposition_adj$pH,
                                 Biodeposition_adj$Dry_Tissue_weight, 
                                 sep = '_')

RespirationRates_adj$uniqueID <- paste(RespirationRates_adj$Date,
                             RespirationRates_adj$pH,
                             RespirationRates_adj$Dry_Tissue_weight, 
                             sep = '_')

ExcretionRates_adj$uniqueID <- paste(ExcretionRates_adj$Date,
                             ExcretionRates_adj$pH,
                             ExcretionRates_adj$Dry_Tissue_weight, 
                             sep = '_')
```

### Test the unique identifier before merging

```{r}
# subset the ER data removing all instances that contain the same unique identifier 
# returns nothing == we are good to merge!

# btwn RR and ER
nrow(subset(ExcretionRates_adj, 
       !(uniqueID %in% RespirationRates_adj$uniqueID))) # no discrepancies btwn files (yay!)

# now btwn RR and biodep
nrow(subset(RespirationRates_adj, 
            !(uniqueID %in% Biodeposition_adj$uniqueID))) # 2 discrepancies, these are the removed outliers from biodep
```

### Let's merge this thang!

```{r}

# merge RR and ER - check the number of rows == 42
RR_ER_merge <- merge(RespirationRates_adj,ExcretionRates_adj) %>% dplyr::select(!pCO2)
# ommitted pCO2 because biodep has the correct micro symbol and is merged below 
nrow(RR_ER_merge) # 63 - no rows lost! 

# merge this data with the biodep - adjust the columns to be our master file!
F2_Masterfile <- merge(RR_ER_merge, Biodeposition_adj, 
                    by = c('Date','uniqueID','Dry_Tissue_weight', 'Replicate', 'pH')) %>% 
                  dplyr::select(c(Date, 
                                  Age,
                                  pCO2,
                                  pH,
                                  Replicate,
                                  Chamber_tank,
                                  Length_mm,
                                  Dry_Tissue_weight,
                                  RR_resp_umol_hr_bfactorTDW,
                                  ExcretionRate_umol_hr_bFactorNormTDW,
                                  IER_correct,
                                  IRR_correct,
                                  OER_correct,
                                  ORR_correct,
                                  CR_correct,
                                  FR_correct,
                                  RR_correct,
                                  p,
                                  f,
                                  i,
                                  SE,
                                  AR,
                                  AE))
nrow(F2_Masterfile) # 59 rows - as expected!!!!!
# View(F2_Masterfile)


```

### Write the file to output folder

```{r}

write.csv(F2_Masterfile, "Output/F2_RR_ER_Biodep_master.csv")
```

# Scope for growth calc

## P = A - (R + U)

-   Widdows and Johnson 1988 " Physiological energetics of *Mytilus edulis*: Scope for Growth
-   **P** = production - estimated from the difference between the energy absorbed from the food and energy expenditure via respiration and excretion - referred to as Scope for Growth (SGF)
-   **A** = C x absorption efficiency
    -   C = Clearnace rate (l g-1 h-1) x POM (mg L-1) x 23 J mg-1 ash free dry weight
-   **R** = VO2 (ml O2 g-1 hr-1) x 20.33 J ml-1 O2
-   **U** = mg NH4 g-1 hr-1 x 19.4 J mg-1 NH4

```{r}

F2_Masterfile$RR_Energy    <- (14.14*(F2_Masterfile$RR_resp_umol_hr_bfactorTDW))
F2_Masterfile$RR_Excretion <- (0.025*(F2_Masterfile$ExcretionRate_umol_hr_bFactorNormTDW))

F2_Masterfile$SfG <- (F2_Masterfile$AR - 
                        (F2_Masterfile$RR_Energy+F2_Masterfile$RR_Excretion)
                      )

# following the Widdows and Johnson 1988 aper described above..
# Note- RR is in L O2 so we will multiply 20.33*1000 to account for 20.33 Joules per ml-1 O2 
F2_Masterfile$RR_Energy_Widdows.1988     <- (20.33*F2_Masterfile$RR_resp_umol_hr_bfactorTDW)
F2_Masterfile$RR_Excretion_Widdows.1988  <- (19.4*F2_Masterfile$ExcretionRate_umol_hr_bFactorNormTDW)

F2_Masterfile$SfG_Widdows.1988           <- (  
                        (F2_Masterfile$AR * (F2_Masterfile$CR_correct*23)) - 
                        (F2_Masterfile$RR_Energy_Widdows.1988 + F2_Masterfile$RR_Excretion_Widdows.1988)
                        )

```

```{r}

F2_Masterfile$pCO2 <- factor(F2_Masterfile$pCO2, levels= c('500 μatm','800 μatm','1200 μatm'))
SFG_F2             <- ggplot(data=F2_Masterfile, aes(x=pCO2, y=SfG, colour=pCO2)) +
                        scale_colour_manual(values=c("forestgreen","orange", "purple"))+
                        theme_classic() +  
                        geom_boxplot(fill="white", 
                                     outlier.colour=NA, 
                                     position=position_dodge(width=0.9)) +
                        geom_point(position=position_jitterdodge()) +
                        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                        theme(axis.text.x=element_blank(),axis.title.x=element_blank()) +
                        labs(title="Scope for Growth ", x ="Month", y = "Scope for Growth") + 
                        facet_wrap(~Date)

SFG_F2_Widdows1988 <- ggplot(data=F2_Masterfile, aes(x=pCO2, y=SfG_Widdows.1988, colour=pCO2)) +
                        scale_colour_manual(values=c("forestgreen","orange", "purple"))+
                        theme_classic() +  
                        geom_boxplot(fill="white", 
                                     outlier.colour=NA, 
                                     position=position_dodge(width=0.9)) +
                        geom_point(position=position_jitterdodge()) +
                        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
                        theme(axis.text.x=element_blank(),axis.title.x=element_blank()) +
                        labs(title="Scope for Growth (Widdows and Johnson 1988)",
                             x ="Month", 
                             y = "Scope for Growth") + 
                        facet_wrap(~Date)
pdf("C:/Users/samjg/Documents/Github_repositories/Airradians_multigen_OA/RAnalysis/Output/F2_SFG.pdf")
ggarrange(SFG_F2, SFG_F2_Widdows1988, nrow = 2)
dev.off()

# stats
F2_Masterfile_1_31_23 <- F2_Masterfile %>% dplyr::filter(Date %in% '1/31/2023')
SGFmod_131 <- aov(lm(SfG ~ pCO2 , data =F2_Masterfile_1_31_23 ))
SGFmod_131 <- aov(lm(SfG_Widdows.1988 ~ pCO2 , data =F2_Masterfile_1_31_23 ))
shapiro.test(resid(SGFmod_131))
leveneTest(SGFmod_131)
summary(SGFmod_131)
```
